# Telegram бот учета смен (фото-отметки)

Бот фиксирует начало и окончание смен по фото. Если сотрудник не закрыл смену в течение 12 часов, смена закрывается автоматически, фиксируется нарушение, а руководитель получает уведомление.

## Возможности
- Старт/закрытие смены по фото с подтверждением.
- Автоматическое закрытие смен через `MAX_SHIFT_HOURS`.
- Фиксация нарушений `NOT_CLOSED_IN_TIME` и `SHORT_SHIFT` (смена меньше 8 часов).
- Отчеты для руководителя за 3/7/30 дней, текущий/прошлый месяц и 12 месяцев.
- Просмотр фото смен за последние 3 дня для администратора.
- Очистка ссылок на фото по политике хранения (3 дня).
- Уведомления руководителя о старте/закрытии/нарушениях.
- Настройка через переменные окружения.

## Быстрый старт (локально)
1. Скопируйте `.env.example` в `.env` и заполните значения.
2. Установите зависимости:
   ```bash
   pnpm install
   ```
3. Создайте миграцию и примените к БД:
   ```bash
   pnpm prisma migrate dev --name init
   ```
4. Запуск (простое локальное тестирование через polling):
   ```bash
   pnpm run dev:polling
   ```

Для режима webhook (как на Vercel) используйте `pnpm run dev` и публичный URL (например, через ngrok).

## Запуск в production (Vercel)
1. Установите переменные окружения в Vercel (см. список ниже).
2. Убедитесь, что команда сборки в Vercel: `pnpm run vercel-build`.
3. Разверните проект.
4. Настройте вебхук Telegram:
   ```bash
   pnpm ts-node scripts/setWebhook.ts
   ```
5. Настройте GitHub Actions для тикеров (см. ниже).
6. В production не используйте polling (`bot.launch()`), только webhook + internal tick.

## Docker
```bash
docker compose up -d --build
```

## Переменные окружения
- `TELEGRAM_BOT_TOKEN` — токен бота.
- `TELEGRAM_BOSS_CHAT_ID` — chat_id руководителя.
- `ADMIN_USER_IDS` — список user_id администраторов через запятую.
- `DATABASE_URL` — строка подключения к PostgreSQL.
- `DIRECT_URL` — прямое подключение к PostgreSQL без pooler (нужно для миграций).
- `WEBHOOK_SECRET` — секрет для URL вебхука.
- `INTERNAL_SECRET` — секрет для internal tick endpoint.
- `PUBLIC_BASE_URL` — публичный URL Vercel (например `https://project.vercel.app`).
- `TELEGRAM_WEBHOOK_SECRET_TOKEN` — (опционально) секрет Telegram webhook header.
- `TIMEZONE` — часовой пояс (по умолчанию `Asia/Bishkek`).
- `MAX_SHIFT_HOURS` — максимальная длительность смены в часах (по умолчанию 12).
- `MIN_SHIFT_HOURS` — минимальная длительность смены в часах (по умолчанию 8).
- `SHORT_SHIFT_GRACE_MINUTES` — допустимое отклонение в минутах (по умолчанию 0).
- `PENDING_ACTION_TTL_MINUTES` — окно подтверждения фото (по умолчанию 10 минут).
- `PENDING_ACTION_CLEANUP_CRON` — cron очистки подтверждений (по умолчанию `*/2 * * * *`).
- `PHOTO_RETENTION_DAYS` — срок хранения ссылок на фото (по умолчанию 3 дня).
- `PHOTO_RETENTION_CRON` — cron очистки ссылок на фото (по умолчанию `0 * * * *`).
- `OVERDUE_CHECK_CRON` — cron для автозакрытия (по умолчанию `*/5 * * * *`).
- `TICK_MAX_AUTOCLOSE` — лимит автозакрытий за тик (по умолчанию 50).
- `TICK_MAX_EXPIRE_PENDING` — лимит истечения подтверждений за тик (по умолчанию 200).
- `NOTIFY_EMPLOYEE_ON_AUTOCLOSE` — уведомлять ли сотрудника об авто‑закрытии (`true/false`).
- `LOG_LEVEL` — уровень логирования.

## Команды
- `/start` — приветствие и инструкция.
- `/status` — статус открытой смены.
- `/employees` или кнопка «Сотрудники» — отчет для руководителя.
- В разделе «Сотрудники» доступен просмотр фото смен за сегодня/вчера/последние 3 дня.
- `/report` или кнопка «Отчёт» — общий отчёт по всем сотрудникам.
- `/errors` — ошибки (администратор).
- `/whoami` — вывод chat/user ID для настройки.
- `/set_admin` — назначить себя администратором (если админов еще нет или вы уже админ).
- `/mode` — переключить режим (доступно, если включен режим BOTH).
- `/help` — помощь по командам.

## Примечания по логике
- Фото от сотрудника создаёт запрос подтверждения (10 минут).
- При подтверждении фото без открытой смены начинается новая смена.
- Если подтверждение не выполнено за 10 минут, запрос истекает.
- Если смена не закрыта в течение 12 часов, она закрывается автоматически ровно на `startTime + 12h` с нарушением.
- При закрытии смены длительностью меньше `MIN_SHIFT_HOURS` фиксируется нарушение `SHORT_SHIFT` (с учётом `SHORT_SHIFT_GRACE_MINUTES`).
- Ссылки на фото хранятся 3 дня, затем очищаются; смены остаются в базе.
- Для защиты от повторной обработки сохраняется `message_id` вместе с `chat_id`.

## Вебхуки и тикер
- Вебхук: `POST /api/telegram/webhook/<WEBHOOK_SECRET>` — **обрабатывает обновления сразу** (реальное время) и параллельно кладёт их в очередь для идемпотентности.
- Internal tick: `POST /api/internal/tick` (обычный), `POST /api/internal/tick?mode=queue` или `POST /api/internal/tick?mode=daily`.
- Авторизация internal tick: `Authorization: Bearer <INTERNAL_SECRET>` или заголовок `x-internal-secret`.
- Очередь используется как запасной механизм и для наблюдаемости.
- Health/Warmup: `GET /api/internal/health` — быстрый пинг БД и инстанса.

### GitHub Actions
Добавьте секреты в GitHub:
- `PUBLIC_BASE_URL`
- `INTERNAL_SECRET`

Файлы воркфлоу:
- `.github/workflows/tick-regular.yml` — каждые 30 минут.
- `.github/workflows/tick-queue.yml` — каждые 5 минут (обработка очереди обновлений).
- `.github/workflows/tick-daily.yml` — каждый день в 03:05.
- `.github/workflows/warmup-morning.yml` — прогрев в пиковое время 08:00–09:59 по Бишкеку (UTC+6).

## Надёжность
- Отправка сообщений в Telegram имеет ретраи на 429/5xx/сетевые сбои.
- Если очередь отстаёт > 180 сек, отправляется уведомление руководителю (не чаще 1 раза в час).

## Скрипты вебхука
```bash
pnpm ts-node scripts/setWebhook.ts
pnpm ts-node scripts/deleteWebhook.ts
```

## Роли и режимы
- Администраторы определяются через `ADMIN_USER_IDS` и/или таблицу `Admin`.
- По умолчанию администратор не считается сотрудником и не может начинать смены.
- Чтобы администратор мог работать как сотрудник, у сотрудника в БД выставьте `roleOverride = BOTH` (и `isActive = true`).
- `Employee.isActive = false` отключает сотрудника от смен.

## Дополнительные администраторы
Можно добавить нескольких администраторов, вставив `telegramUserId` в таблицу `Admin` (например через `psql`). Они будут получать те же уведомления, что и основной руководитель.

## Тесты
```bash
pnpm test
```

### Локальный запуск тестов
1. Поднимите тестовый PostgreSQL (например, через Docker):
   ```bash
   docker run --rm -p 5432:5432 -e POSTGRES_DB=shift_bot_test -e POSTGRES_USER=postgres -e POSTGRES_PASSWORD=postgres postgres:15-alpine
   ```
2. Скопируйте `.env.test.example` в `.env.test` и при необходимости измените `DATABASE_URL`.
3. Примените миграции:
   ```bash
   pnpm prisma migrate deploy
   ```
4. Запустите тесты:
   ```bash
   pnpm test
   ```
