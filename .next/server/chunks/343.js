"use strict";exports.id=343,exports.ids=[343],exports.modules={3406:(e,t,a)=>{a.d(t,{s:()=>i});let i={startEmployee:"–ü—Ä–∏–≤–µ—Ç! –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–º–µ–Ω—É, –∑–∞—Ç–µ–º –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ. –§–æ—Ç–æ –µ—â—ë —Ä–∞–∑ ‚Äî –∑–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É.",startAdmin:"–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä.\n–ö–æ–º–∞–Ω–¥—ã: /employees, /report, /whoami, /help",startBoth:"–í—ã –º–æ–∂–µ—Ç–µ —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∏–ª–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫. –¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º: –ê–¥–º–∏–Ω.",instructionEmployee:"–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ.",instructionAdmin:"–í—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /employees –∏–ª–∏ /help.",noAccess:"–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞.",noOpenShift:"–û—Ç–∫—Ä—ã—Ç—ã—Ö —Å–º–µ–Ω –Ω–µ—Ç.",openShift:e=>`–û—Ç–∫—Ä—ã—Ç–∞—è —Å–º–µ–Ω–∞ —Å ${e}`,shiftStarted:e=>`–°–º–µ–Ω–∞ –Ω–∞—á–∞–ª–∞—Å—å: ${e}`,shiftClosed:(e,t)=>`–°–º–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∞: ${e}. –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${t}.`,bossShiftStarted:(e,t)=>`‚úÖ ${e} –Ω–∞—á–∞–ª(–∞) —Å–º–µ–Ω—É –≤ ${t}`,bossShiftClosed:(e,t)=>`üèÅ ${e} –∑–∞–∫—Ä—ã–ª(–∞) —Å–º–µ–Ω—É. –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${t}.`,autoClosedBoss:(e,t,a)=>`‚ö†Ô∏è ${e} –Ω–µ –∑–∞–∫—Ä—ã–ª(–∞) —Å–º–µ–Ω—É –≤–æ–≤—Ä–µ–º—è. –°–º–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã—Ç–∞ –≤ ${t} (${a} —á–∞—Å–æ–≤). –ù–∞—Ä—É—à–µ–Ω–∏–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ.`,autoClosedEmployee:e=>`‚ö†Ô∏è –í—ã –Ω–µ –∑–∞–∫—Ä—ã–ª–∏ —Å–º–µ–Ω—É –≤–æ–≤—Ä–µ–º—è. –°–º–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã—Ç–∞ —á–µ—Ä–µ–∑ ${e} —á–∞—Å–æ–≤. –ù–∞—Ä—É—à–µ–Ω–∏–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ.`,alreadyClosed:"–û—Ç–∫—Ä—ã—Ç–∞—è —Å–º–µ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ (–≤–æ–∑–º–æ–∂–Ω–æ, –æ–Ω–∞ –±—ã–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã—Ç–∞).",reportChoosePeriod:"–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –æ—Ç—á—ë—Ç–∞:",employeesChoosePrompt:"–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏: –≤—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.",reportAllPrompt:"–û—Ç—á—ë—Ç: —Å–≤–æ–¥–∫–∞ –ø–æ –≤—Å–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º. –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥.",employeePeriodPrompt:e=>`–°–æ—Ç—Ä—É–¥–Ω–∏–∫: ${e}. –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥:`,employeeActionPrompt:e=>`–°–æ—Ç—Ä—É–¥–Ω–∏–∫: ${e}. –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:`,photoPeriodPrompt:e=>`–§–æ—Ç–æ –¥–ª—è ${e}. –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥:`,exportReady:"–§–∞–π–ª –≥–æ—Ç–æ–≤.",exportSkipped:"–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–º–µ–Ω –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞. –û—Ç–ø—Ä–∞–≤–ª–µ–Ω —Ç–æ–ª—å–∫–æ –æ–±—â–∏–π —Ñ–∞–π–ª.",searchHint:"–í–≤–µ–¥–∏—Ç–µ /employees <–∑–∞–ø—Ä–æ—Å> –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ username.",noEmployeesFound:"–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.",reportEmpty:"–î–∞–Ω–Ω—ã–µ –∑–∞ –ø–µ—Ä–∏–æ–¥ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.",setAdminSuccess:"–í—ã –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.",adminPhotoIgnored:"–í—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä. –§–æ—Ç–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–º–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /employees –∏–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º.",notEmployee:"–í—ã –Ω–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Å–µ–±—è –∫–∞–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.",confirmStartPrompt:"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–∞—á–∞–ª–æ —Å–º–µ–Ω—ã?",confirmEndPrompt:"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã?",pendingCancelled:"–û—Ç–º–µ–Ω–µ–Ω–æ. –§–æ—Ç–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ —Å–º–µ–Ω–µ.",pendingExpired:"–í—Ä–µ–º—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –∑–∞–Ω–æ–≤–æ.",pendingAlreadyHandled:"–î–µ–π—Å—Ç–≤–∏–µ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ.",pendingNotFound:"–î–µ–π—Å—Ç–≤–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.",openShiftExists:"–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç–∞—è —Å–º–µ–Ω–∞. –°–Ω–∞—á–∞–ª–∞ –∑–∞–∫—Ä–æ–π—Ç–µ –µ—ë.",photoShiftsEmpty:"–°–º–µ–Ω—ã –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.",photoStartMissing:"–§–æ—Ç–æ –Ω–∞—á–∞–ª–∞ —Å–º–µ–Ω—ã: —É–¥–∞–ª–µ–Ω–æ –ø–æ –ø–æ–ª–∏—Ç–∏–∫–µ —Ö—Ä–∞–Ω–µ–Ω–∏—è (3 –¥–Ω—è).",photoEndMissing:"–§–æ—Ç–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–º–µ–Ω—ã: —É–¥–∞–ª–µ–Ω–æ –ø–æ –ø–æ–ª–∏—Ç–∏–∫–µ —Ö—Ä–∞–Ω–µ–Ω–∏—è (3 –¥–Ω—è).",photoEndNotClosed:"–§–æ—Ç–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–º–µ–Ω—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (—Å–º–µ–Ω–∞ –µ—â—ë –Ω–µ –∑–∞–∫—Ä—ã—Ç–∞).",photoEndAutoClosed:"–§–æ—Ç–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–º–µ–Ω—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (—Å–º–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã—Ç–∞).",shiftNotFound:"–°–º–µ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.",helpAdmin:"–ü–æ–º–æ—â—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:\n/employees ‚Äî –æ—Ç—á—ë—Ç –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É\n/report ‚Äî –æ–±—â–∏–π –æ—Ç—á—ë—Ç\n/mode ‚Äî —Ä–µ–∂–∏–º (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)\n/whoami ‚Äî –≤–∞—à–∏ ID",helpEmployee:"–ü–æ–º–æ—â—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:\n–§–æ—Ç–æ ‚Äî –∑–∞–ø—Ä–æ—Å–∏—Ç—å –Ω–∞—á–∞–ª–æ/–∑–∞–∫—Ä—ã—Ç–∏–µ (–Ω—É–∂–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å)\n/status ‚Äî —Å—Ç–∞—Ç—É—Å —Å–º–µ–Ω—ã\n/whoami ‚Äî –≤–∞—à–∏ ID",helpBoth:"–ü–æ–º–æ—â—å:\n/mode ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º\n/employees ‚Äî –æ—Ç—á—ë—Ç –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É\n/report ‚Äî –æ–±—â–∏–π –æ—Ç—á—ë—Ç\n/status ‚Äî —Å—Ç–∞—Ç—É—Å —Å–º–µ–Ω—ã (—Å–æ—Ç—Ä—É–¥–Ω–∏–∫)\n–§–æ—Ç–æ ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–º–µ–Ω—ã",modePrompt:"–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º:",modeSetAdmin:"–†–µ–∂–∏–º: –ê–¥–º–∏–Ω.",modeSetEmployee:"–†–µ–∂–∏–º: –°–æ—Ç—Ä—É–¥–Ω–∏–∫.",modeUnavailable:"–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ."}},2942:(e,t,a)=>{a.d(t,{O:()=>n}),a(4243);var i=a(7012);let o=i.Ry({TELEGRAM_BOT_TOKEN:i.Z_().min(1),TELEGRAM_BOSS_CHAT_ID:i.Z_().min(1),ADMIN_USER_IDS:i.Z_().optional(),DATABASE_URL:i.Z_().min(1),WEBHOOK_SECRET:i.Z_().min(1),INTERNAL_SECRET:i.Z_().min(1),PUBLIC_BASE_URL:i.Z_().min(1),TELEGRAM_WEBHOOK_SECRET_TOKEN:i.Z_().optional(),TIMEZONE:i.Z_().default("Asia/Bishkek"),MAX_SHIFT_HOURS:i.oQ.number().int().positive().default(12),MIN_SHIFT_HOURS:i.oQ.number().int().positive().default(8),SHORT_SHIFT_GRACE_MINUTES:i.oQ.number().int().min(0).default(0),PENDING_ACTION_TTL_MINUTES:i.oQ.number().int().positive().default(10),PENDING_ACTION_CLEANUP_CRON:i.Z_().default("*/2 * * * *"),PHOTO_RETENTION_DAYS:i.oQ.number().int().positive().default(3),PHOTO_RETENTION_CRON:i.Z_().default("0 * * * *"),OVERDUE_CHECK_CRON:i.Z_().default("*/5 * * * *"),TICK_MAX_AUTOCLOSE:i.oQ.number().int().positive().default(50),TICK_MAX_EXPIRE_PENDING:i.oQ.number().int().positive().default(200),NOTIFY_EMPLOYEE_ON_AUTOCLOSE:i.oQ.boolean().default(!0),LOG_LEVEL:i.Z_().default("info"),NODE_ENV:i.Z_().optional()}).safeParse(process.env);if(!o.success){let e=o.error.format();throw Error(`Invalid environment configuration: ${JSON.stringify(e)}`)}let n={telegramBotToken:o.data.TELEGRAM_BOT_TOKEN,telegramBossChatId:o.data.TELEGRAM_BOSS_CHAT_ID,adminUserIds:(o.data.ADMIN_USER_IDS??"").split(",").map(e=>e.trim()).filter(Boolean),databaseUrl:o.data.DATABASE_URL,webhookSecret:o.data.WEBHOOK_SECRET,internalSecret:o.data.INTERNAL_SECRET,publicBaseUrl:o.data.PUBLIC_BASE_URL,telegramWebhookSecretToken:o.data.TELEGRAM_WEBHOOK_SECRET_TOKEN??null,timezone:o.data.TIMEZONE,maxShiftHours:o.data.MAX_SHIFT_HOURS,minShiftHours:o.data.MIN_SHIFT_HOURS,shortShiftGraceMinutes:o.data.SHORT_SHIFT_GRACE_MINUTES,pendingActionTtlMinutes:o.data.PENDING_ACTION_TTL_MINUTES,pendingActionCleanupCron:o.data.PENDING_ACTION_CLEANUP_CRON,photoRetentionDays:o.data.PHOTO_RETENTION_DAYS,photoRetentionCron:o.data.PHOTO_RETENTION_CRON,overdueCheckCron:o.data.OVERDUE_CHECK_CRON,tickMaxAutoclose:o.data.TICK_MAX_AUTOCLOSE,tickMaxExpirePending:o.data.TICK_MAX_EXPIRE_PENDING,notifyEmployeeOnAutoClose:o.data.NOTIFY_EMPLOYEE_ON_AUTOCLOSE,logLevel:o.data.LOG_LEVEL,nodeEnv:o.data.NODE_ENV}},8361:(e,t,a)=>{a.d(t,{k:()=>s});var i=a(4062),o=a.n(i),n=a(2942);let s=o()({level:n.O.logLevel,base:{service:"telegram-shift-bot"}})},6343:(e,t,a)=>{a.d(t,{M:()=>e_});var i=a(3524);let o=globalThis.prisma??new i.PrismaClient;var n=a(2942),s=a(8361);let r=e=>{let t=[e.firstName,e.lastName].filter(Boolean);return t.length>0?t.join(" "):e.username?`@${e.username}`:`user:${e.id}`};class l{async upsertFromTelegram(e){let t=r(e);return await o.employee.upsert({where:{telegramUserId:String(e.id)},create:{telegramUserId:String(e.id),username:e.username??null,firstName:e.firstName??null,lastName:e.lastName??null,displayName:t},update:{username:e.username??null,firstName:e.firstName??null,lastName:e.lastName??null,displayName:t}})}async findByTelegramUserId(e){return o.employee.findUnique({where:{telegramUserId:e}})}async findById(e){return o.employee.findUnique({where:{id:e}})}async findByIds(e){return 0===e.length?[]:o.employee.findMany({where:{id:{in:e}}})}async listEmployees(e){let t=Math.max(1,e.page),a=Math.min(20,Math.max(1,e.pageSize)),i=e.query?.trim(),n=i?{OR:[{displayName:{contains:i,mode:"insensitive"}},{username:{contains:i,mode:"insensitive"}},{firstName:{contains:i,mode:"insensitive"}},{lastName:{contains:i,mode:"insensitive"}},{telegramUserId:{contains:i,mode:"insensitive"}}]}:{},[s,r]=await o.$transaction([o.employee.count({where:n}),o.employee.findMany({where:n,orderBy:{displayName:"asc"},skip:(t-1)*a,take:a})]);return{total:s,items:r}}}class d{async findOpenShift(e,t){return(t??o).shift.findFirst({where:{employeeId:e,endTime:null},orderBy:{startTime:"desc"}})}async findLastShift(e){return o.shift.findFirst({where:{employeeId:e},orderBy:{startTime:"desc"}})}async isMessageProcessed(e,t){return!!await o.shift.findFirst({where:{OR:[{startChatId:e,startMessageId:t},{endChatId:e,endMessageId:t}]},select:{id:!0}})}async createShiftStart(e,t){return(t??o).shift.create({data:{employeeId:e.employeeId,startTime:e.startTime,startPhotoFileId:e.startPhotoFileId,startMessageId:e.startMessageId,startChatId:e.startChatId,employeeChatId:e.startChatId}})}async closeShiftByUserPhoto(e,t){return(t??o).shift.update({where:{id:e.shiftId},data:{endTime:e.endTime,endPhotoFileId:e.endPhotoFileId,endMessageId:e.endMessageId,endChatId:e.endChatId,closedReason:i.ClosedReason.USER_PHOTO,durationMinutes:e.durationMinutes}})}async createViolation(e,t,a){await (a??o).shiftViolation.createMany({data:[{shiftId:e,type:t}],skipDuplicates:!0})}async findOverdueShifts(e,t){return o.shift.findMany({where:{endTime:null,alertedAt:null,startTime:{lte:e}},include:{employee:!0,violations:!0},orderBy:{startTime:"asc"},take:t})}async autoCloseShift(e,t,a,n,s){return s?0===(await s.shift.updateMany({where:{id:e,endTime:null,alertedAt:null},data:{endTime:t,closedReason:i.ClosedReason.AUTO_TIMEOUT,durationMinutes:a,autoClosedAt:n,alertedAt:n}})).count?null:(await s.shiftViolation.createMany({data:[{shiftId:e,type:i.ViolationType.NOT_CLOSED_IN_TIME}],skipDuplicates:!0}),s.shift.findUnique({where:{id:e},include:{employee:!0,violations:!0}})):o.$transaction(async o=>0===(await o.shift.updateMany({where:{id:e,endTime:null,alertedAt:null},data:{endTime:t,closedReason:i.ClosedReason.AUTO_TIMEOUT,durationMinutes:a,autoClosedAt:n,alertedAt:n}})).count?null:(await o.shiftViolation.createMany({data:[{shiftId:e,type:i.ViolationType.NOT_CLOSED_IN_TIME}],skipDuplicates:!0}),o.shift.findUnique({where:{id:e},include:{employee:!0,violations:!0}})))}async findShiftsInRange(e,t,a){return o.shift.findMany({where:{startTime:{gte:e,lte:t}},include:{employee:!0,violations:!0},orderBy:[{employeeId:"asc"},{startTime:a?.order??"asc"}],take:a?.limit})}async findEmployeeShiftsInRange(e,t,a,i){return o.shift.findMany({where:{employeeId:e,startTime:{gte:t,lte:a}},include:{employee:!0,violations:!0},orderBy:{startTime:"desc"},take:i})}async findShiftById(e){return o.shift.findUnique({where:{id:e},include:{employee:!0,violations:!0}})}async purgeOldPhotos(e,t,a){if(!a)return(await o.shift.updateMany({where:{startTime:{lt:e},photosPurgedAt:null},data:{startPhotoFileId:null,endPhotoFileId:null,photosPurgedAt:t}})).count;let i=await o.shift.findMany({where:{startTime:{lt:e},photosPurgedAt:null},select:{id:!0},orderBy:{startTime:"asc"},take:a});if(0===i.length)return 0;let n=i.map(e=>e.id);return(await o.shift.updateMany({where:{id:{in:n},photosPurgedAt:null},data:{startPhotoFileId:null,endPhotoFileId:null,photosPurgedAt:t}})).count}async aggregateEmployeeStats(e,t,a){let i=await o.shift.aggregate({where:{employeeId:e,startTime:{gte:t,lte:a}},_count:{_all:!0},_sum:{durationMinutes:!0},_avg:{durationMinutes:!0}});return{totalShifts:i._count._all,totalDurationMinutes:i._sum.durationMinutes??0,averageDurationMinutes:Math.round(i._avg.durationMinutes??0)}}async countEmployeeViolations(e,t,a){return o.shiftViolation.count({where:{shift:{employeeId:e,startTime:{gte:t,lte:a}}}})}async countEmployeeViolationsByType(e,t,a){let n=await o.shiftViolation.groupBy({by:["type"],where:{shift:{employeeId:e,startTime:{gte:t,lte:a}}},_count:{_all:!0}}),s=0,r=0,l=0;for(let e of n)l+=e._count._all,e.type===i.ViolationType.NOT_CLOSED_IN_TIME&&(s=e._count._all),e.type===i.ViolationType.SHORT_SHIFT&&(r=e._count._all);return{notClosedInTime:s,shortShift:r,total:l}}async groupByEmployeeStats(e,t){return(await o.shift.groupBy({by:["employeeId"],where:{startTime:{gte:e,lte:t}},_count:{_all:!0},_sum:{durationMinutes:!0},_avg:{durationMinutes:!0}})).map(e=>({employeeId:e.employeeId,totalShifts:e._count._all,totalDurationMinutes:e._sum.durationMinutes??0,averageDurationMinutes:Math.round(e._avg.durationMinutes??0)}))}async countViolationsByEmployee(e,t){return await o.$queryRaw`
      SELECT s."employeeId" AS "employeeId",
             COUNT(v.*)::int AS "violations"
      FROM "Shift" s
      JOIN "ShiftViolation" v ON v."shiftId" = s."id"
      WHERE s."startTime" >= ${e}
        AND s."startTime" <= ${t}
      GROUP BY s."employeeId"
    `}async countViolationsByEmployeeAndType(e,t){return await o.$queryRaw`
      SELECT s."employeeId" AS "employeeId",
             v."type" AS "type",
             COUNT(v.*)::int AS "count"
      FROM "Shift" s
      JOIN "ShiftViolation" v ON v."shiftId" = s."id"
      WHERE s."startTime" >= ${e}
        AND s."startTime" <= ${t}
      GROUP BY s."employeeId", v."type"
    `}async findLastShiftsByEmployee(e,t){return await o.$queryRaw`
      SELECT DISTINCT ON (s."employeeId")
        s."employeeId" AS "employeeId",
        s."startTime" AS "startTime",
        s."endTime" AS "endTime",
        s."closedReason" AS "closedReason"
      FROM "Shift" s
      WHERE s."startTime" >= ${e}
        AND s."startTime" <= ${t}
      ORDER BY s."employeeId", s."startTime" DESC
    `}}class p{async isAdminUserId(e){return!!await o.admin.findUnique({where:{telegramUserId:e},select:{id:!0}})}async countAdmins(){return o.admin.count()}async addAdminUserId(e){await o.admin.upsert({where:{telegramUserId:e},create:{telegramUserId:e},update:{}})}async getAdminUserIds(){return(await o.admin.findMany({select:{telegramUserId:!0}})).map(e=>e.telegramUserId)}}class u{async getSession(e){return o.userSession.findUnique({where:{telegramUserId:e},select:{telegramUserId:!0,mode:!0}})}async setSession(e,t){await o.userSession.upsert({where:{telegramUserId:e},create:{telegramUserId:e,mode:t},update:{mode:t}})}}class m{async findById(e,t){return(t??o).pendingAction.findUnique({where:{id:e}})}async findByChatMessage(e,t,a){return(a??o).pendingAction.findUnique({where:{chatId_photoMessageId:{chatId:e,photoMessageId:t}}})}async createPendingAction(e,t){return(t??o).pendingAction.create({data:{employeeId:e.employeeId,telegramUserId:e.telegramUserId,chatId:e.chatId,actionType:e.actionType,photoFileId:e.photoFileId,photoMessageId:e.photoMessageId,createdAt:e.createdAt,expiresAt:e.expiresAt}})}async updateStatus(e,t,a,i){let n=i??o;return 0===(await n.pendingAction.updateMany({where:{id:e},data:{status:t,updatedAt:a}})).count?null:n.pendingAction.findUnique({where:{id:e}})}async updateStatusIfPending(e,t,a,n){return(await (n??o).pendingAction.updateMany({where:{id:e,status:i.PendingActionStatus.PENDING,expiresAt:{gt:t}},data:{status:a,updatedAt:t}})).count}async expirePendingActions(e,t){if(!t)return(await o.pendingAction.updateMany({where:{status:i.PendingActionStatus.PENDING,expiresAt:{lte:e}},data:{status:i.PendingActionStatus.EXPIRED,updatedAt:e}})).count;let a=await o.pendingAction.findMany({where:{status:i.PendingActionStatus.PENDING,expiresAt:{lte:e}},select:{id:!0},orderBy:{expiresAt:"asc"},take:t});if(0===a.length)return 0;let n=a.map(e=>e.id);return(await o.pendingAction.updateMany({where:{id:{in:n},status:i.PendingActionStatus.PENDING},data:{status:i.PendingActionStatus.EXPIRED,updatedAt:e}})).count}}class y{constructor(e,t,a,i){this.employeeRepo=e,this.shiftRepo=t,this.config=a,this.logger=i}async handlePhotoMessage(e){let t=String(e.chatId);if(await this.shiftRepo.isMessageProcessed(t,e.messageId))return this.logger.info({chatId:t,messageId:e.messageId},"Duplicate message ignored"),{type:"duplicate"};let a=await this.employeeRepo.upsertFromTelegram(e.user),i=await this.shiftRepo.findOpenShift(a.id);if(!i)return{type:"started",shift:await this.shiftRepo.createShiftStart({employeeId:a.id,startTime:e.messageDate,startPhotoFileId:e.fileId,startMessageId:e.messageId,startChatId:t}),employee:a};let o=36e5*this.config.maxShiftHours,n=i.startTime.getTime()+o;if(e.messageDate.getTime()>=n){let o=new Date(n),s=60*this.config.maxShiftHours,r=await this.shiftRepo.autoCloseShift(i.id,o,s,e.messageDate),l=await this.shiftRepo.createShiftStart({employeeId:a.id,startTime:e.messageDate,startPhotoFileId:e.fileId,startMessageId:e.messageId,startChatId:t});return r?{type:"autoClosedAndStarted",autoClose:{shift:r,endTime:o,durationMinutes:s},startedShift:l,employee:a}:{type:"started",shift:l,employee:a}}let s=Math.max(0,Math.round((e.messageDate.getTime()-i.startTime.getTime())/6e4)),r=await this.shiftRepo.closeShiftByUserPhoto({shiftId:i.id,endTime:e.messageDate,endPhotoFileId:e.fileId,endMessageId:e.messageId,endChatId:t,durationMinutes:s});return await this.applyShortShiftViolation(r.id,s),{type:"closed",shift:r,employee:a,durationMinutes:s}}async getOpenShiftStatus(e){let t=await this.employeeRepo.findByTelegramUserId(e);return t?this.shiftRepo.findOpenShift(t.id):null}async autoCloseOverdueShifts(e=new Date,t){let a=36e5*this.config.maxShiftHours,i=new Date(e.getTime()-a),o=await this.shiftRepo.findOverdueShifts(i,t),n=[];for(let t of o){let i=new Date(t.startTime.getTime()+a),o=60*this.config.maxShiftHours,s=await this.shiftRepo.autoCloseShift(t.id,i,o,e);s&&(await this.applyShortShiftViolation(s.id,o),n.push({shift:s,endTime:i,durationMinutes:o}))}return n}async applyShortShiftViolation(e,t){null!==t&&t<this.config.minShiftMinutes-this.config.shortShiftGraceMinutes&&await this.shiftRepo.createViolation(e,i.ViolationType.SHORT_SHIFT)}}class c{constructor(e,t){this.shiftRepo=e,this.employeeRepo=t}buildRange(e,t=new Date){return{from:new Date(t.getTime()-864e5*e),to:t,days:e}}async getEmployeeReport(e,t,a=new Date){let i=this.buildRange(t,a),o=await this.employeeRepo.findById(e);if(!o)return null;let n=await this.shiftRepo.aggregateEmployeeStats(e,i.from,i.to),s=await this.shiftRepo.countEmployeeViolationsByType(e,i.from,i.to),r=(await this.shiftRepo.findEmployeeShiftsInRange(e,i.from,i.to,10)).map(e=>({startTime:e.startTime,endTime:e.endTime,durationMinutes:e.durationMinutes,closedReason:e.closedReason,violations:e.violations.map(e=>e.type)}));return{employeeId:o.id,telegramUserId:o.telegramUserId,displayName:o.displayName,period:i,totalShifts:n.totalShifts,totalDurationMinutes:n.totalDurationMinutes,averageDurationMinutes:n.averageDurationMinutes,violationsNotClosedInTime:s.notClosedInTime,violationsShortShift:s.shortShift,violationsTotal:s.total,shifts:r}}async getAllEmployeesReport(e,t=new Date){let a=this.buildRange(e,t),o=await this.shiftRepo.groupByEmployeeStats(a.from,a.to),n=await this.shiftRepo.countViolationsByEmployeeAndType(a.from,a.to),s=await this.shiftRepo.findLastShiftsByEmployee(a.from,a.to),r=await this.employeeRepo.findByIds(o.map(e=>e.employeeId)),l=new Map;for(let e of r)l.set(e.id,{telegramUserId:e.telegramUserId,displayName:e.displayName});let d=new Map;for(let e of n){let t=d.get(e.employeeId)??{notClosedInTime:0,shortShift:0,total:0};e.type===i.ViolationType.NOT_CLOSED_IN_TIME&&(t.notClosedInTime=e.count),e.type===i.ViolationType.SHORT_SHIFT&&(t.shortShift=e.count),t.total+=e.count,d.set(e.employeeId,t)}let p=new Map;for(let e of s)p.set(e.employeeId,{startTime:e.startTime,endTime:e.endTime,closedReason:e.closedReason});let u=o.map(e=>{let t=l.get(e.employeeId)??{telegramUserId:String(e.employeeId),displayName:`user:${e.employeeId}`},a=p.get(e.employeeId),i=d.get(e.employeeId)??{notClosedInTime:0,shortShift:0,total:0};return{employeeId:e.employeeId,telegramUserId:t.telegramUserId,displayName:t.displayName,totalShifts:e.totalShifts,totalDurationMinutes:e.totalDurationMinutes,averageDurationMinutes:e.averageDurationMinutes,violationsNotClosedInTime:i.notClosedInTime,violationsShortShift:i.shortShift,violationsTotal:i.total,lastShiftStart:a?.startTime??null,lastShiftEnd:a?.endTime??null,lastShiftClosedReason:a?.closedReason??null}});u.sort((e,t)=>e.displayName.localeCompare(t.displayName,"ru"));let m=[...u].sort((e,t)=>t.violationsTotal!==e.violationsTotal?t.violationsTotal-e.violationsTotal:t.totalDurationMinutes-e.totalDurationMinutes),y=u.length,c=u.reduce((e,t)=>e+t.totalShifts,0),h=u.reduce((e,t)=>e+t.totalDurationMinutes,0);return{period:a,totalEmployees:y,totalShifts:c,totalDurationMinutes:h,violationsNotClosedInTime:u.reduce((e,t)=>e+t.violationsNotClosedInTime,0),violationsShortShift:u.reduce((e,t)=>e+t.violationsShortShift,0),totalViolations:u.reduce((e,t)=>e+t.violationsTotal,0),employees:u,topEmployees:m.slice(0,10)}}async getEmployeeShiftsForExport(e,t,a=new Date){let i=this.buildRange(t,a);return(await this.shiftRepo.findEmployeeShiftsInRange(e,i.from,i.to,1e4)).map(e=>({startTime:e.startTime,endTime:e.endTime,durationMinutes:e.durationMinutes,closedReason:e.closedReason,violations:e.violations.map(e=>e.type)}))}async getRawShiftsForExport(e,t=new Date,a=5e3){let i=this.buildRange(e,t),o=await this.shiftRepo.findShiftsInRange(i.from,i.to,{limit:a,order:"asc"});return{period:i,shifts:o.map(e=>({employeeId:e.employeeId,telegramUserId:e.employee.telegramUserId,displayName:e.employee.displayName,startTime:e.startTime,endTime:e.endTime,durationMinutes:e.durationMinutes,closedReason:e.closedReason,violations:e.violations.map(e=>e.type)}))}}}class h{constructor(e){this.adminRepo=e}async isAdmin(e){return!!n.O.adminUserIds.includes(e)||this.adminRepo.isAdminUserId(e)}async canAssignAdmin(e){return!(await this.adminRepo.countAdmins()>0)&&!(n.O.adminUserIds.length>0)||this.isAdmin(e)}async addAdmin(e){await this.adminRepo.addAdminUserId(e)}async getAdminChatIds(){let e=await this.adminRepo.getAdminUserIds();return Array.from(new Set([n.O.telegramBossChatId,...n.O.adminUserIds,...e]))}}class f{constructor(e,t,a){this.adminService=e,this.employeeRepo=t,this.sessionRepo=a}async resolveRole(e){let t;let a=i.EmployeeRoleOverride||{DEFAULT:"DEFAULT",FORCE_EMPLOYEE:"FORCE_EMPLOYEE",FORCE_ADMIN:"FORCE_ADMIN",BOTH:"BOTH"},o=i.UserMode||{ADMIN:"ADMIN",EMPLOYEE:"EMPLOYEE"},n=await this.adminService.isAdmin(e),s=await this.employeeRepo.findByTelegramUserId(e),r=s?.roleOverride??a.DEFAULT,l=s?.isActive??!1,d=!1;n?(r===a.BOTH||r===a.FORCE_EMPLOYEE)&&(d=l):d=!s||l,r===a.FORCE_ADMIN&&(d=!1);let p=n&&d&&r===a.BOTH;if(p){let a=await this.sessionRepo.getSession(e);t=a?.mode??o.ADMIN}else t=n?o.ADMIN:o.EMPLOYEE;return r===a.FORCE_EMPLOYEE&&d&&(t=o.EMPLOYEE),{userId:e,isAdmin:n,isEmployee:d,isBoth:p,mode:t,employee:s,roleOverride:r}}async setMode(e,t){await this.sessionRepo.setSession(e,t)}shouldProcessPhoto(e){let t=i.UserMode||{ADMIN:"ADMIN",EMPLOYEE:"EMPLOYEE"};return e.isEmployee&&e.mode===t.EMPLOYEE}}var g=a(6751);let I=e=>{if(null==e)return"";let t=String(e);return t.includes("\n")||t.includes(",")||t.includes('"')?`"${t.replace(/"/g,'""')}"`:t},S=e=>e===i.ClosedReason.AUTO_TIMEOUT?"AUTO_TIMEOUT":e===i.ClosedReason.USER_PHOTO?"USER_PHOTO":"",w=e=>{let t=0,a=0;for(let o of e)o===i.ViolationType.NOT_CLOSED_IN_TIME&&(t+=1),o===i.ViolationType.SHORT_SHIFT&&(a+=1);return{notClosedInTime:t,shortShift:a,total:e.length}};class T{buildEmployeeReportCsv(e,t){let a=[["employeeId","telegramUserId","displayName","startTime","endTime","durationMinutes","closedReason","notClosedInTimeViolationsCount","shortShiftViolationsCount","totalViolationsCount","violations"],...e.shifts.map(a=>{let i=w(a.violations);return[e.employeeId,e.telegramUserId,e.displayName,(0,g.o0)(a.startTime,t),a.endTime?(0,g.o0)(a.endTime,t):"",a.durationMinutes??"",S(a.closedReason),i.notClosedInTime,i.shortShift,i.total,a.violations.join(",")]})].map(e=>e.map(I).join(",")).join("\n");return{filename:`report_${(0,g.TW)(e.period.from,t)}_to_${(0,g.TW)(e.period.to,t)}.csv`,content:Buffer.from(a,"utf-8")}}buildAllEmployeesSummaryCsv(e,t,a){let i=[["employeeId","telegramUserId","displayName","shiftsCount","totalMinutes","avgShiftMinutes","notClosedInTimeViolationsCount","shortShiftViolationsCount","totalViolationsCount","lastShiftStart","lastShiftEnd","lastShiftClosedReason"],...t.map(e=>[e.employeeId,e.telegramUserId,e.displayName,e.totalShifts,e.totalDurationMinutes,e.averageDurationMinutes,e.violationsNotClosedInTime,e.violationsShortShift,e.violationsTotal,e.lastShiftStart?(0,g.o0)(e.lastShiftStart,a):"",e.lastShiftEnd?(0,g.o0)(e.lastShiftEnd,a):"",S(e.lastShiftClosedReason??null)])].map(e=>e.map(I).join(",")).join("\n");return{filename:`report_${(0,g.TW)(e.from,a)}_to_${(0,g.TW)(e.to,a)}.csv`,content:Buffer.from(i,"utf-8")}}buildRawShiftsCsv(e,t,a){let i=[["employeeId","telegramUserId","displayName","startTime","endTime","durationMinutes","closedReason","notClosedInTimeViolationsCount","shortShiftViolationsCount","totalViolationsCount","violations"],...t.map(e=>{let t=w(e.violations);return[e.employeeId,e.telegramUserId,e.displayName,(0,g.o0)(e.startTime,a),e.endTime?(0,g.o0)(e.endTime,a):"",e.durationMinutes??"",S(e.closedReason),t.notClosedInTime,t.shortShift,t.total,e.violations.join(",")]})].map(e=>e.map(I).join(",")).join("\n");return{filename:`report_raw_${(0,g.TW)(e.from,a)}_to_${(0,g.TW)(e.to,a)}.csv`,content:Buffer.from(i,"utf-8")}}}class E{constructor(e,t,a,i,o){this.employeeRepo=e,this.shiftRepo=t,this.pendingRepo=a,this.config=i,this.runInTransaction=o}async createFromPhoto(e){let t=String(e.chatId);if(await this.shiftRepo.isMessageProcessed(t,e.messageId)||await this.pendingRepo.findByChatMessage(t,e.messageId))return{type:"duplicate"};let a=await this.employeeRepo.upsertFromTelegram(e.user),o=await this.shiftRepo.findOpenShift(a.id),n=36e5*this.config.maxShiftHours,s=!!o&&e.messageDate.getTime()>=o.startTime.getTime()+n,r=!o||s?i.PendingActionType.START:i.PendingActionType.END,l=e.messageDate,d=new Date(l.getTime()+6e4*this.config.ttlMinutes);return{type:"pending",pendingAction:await this.pendingRepo.createPendingAction({employeeId:a.id,telegramUserId:a.telegramUserId,chatId:t,actionType:r,photoFileId:e.fileId,photoMessageId:e.messageId,createdAt:l,expiresAt:d}),actionType:r,employee:a}}async confirmAction(e,t,a=new Date){return this.runInTransaction(async o=>{let n=await this.pendingRepo.findById(e,o);if(!n)return{type:"not_found"};if(n.telegramUserId!==t)return{type:"forbidden"};if(n.status!==i.PendingActionStatus.PENDING)return{type:"already_handled",status:n.status};if(n.expiresAt<=a)return await this.pendingRepo.updateStatus(n.id,i.PendingActionStatus.EXPIRED,a,o),{type:"expired"};if(0===await this.pendingRepo.updateStatusIfPending(n.id,a,i.PendingActionStatus.CONFIRMED,o)){let e=await this.pendingRepo.findById(n.id,o);return e&&e.status===i.PendingActionStatus.PENDING&&e.expiresAt<=a?(await this.pendingRepo.updateStatus(e.id,i.PendingActionStatus.EXPIRED,a,o),{type:"expired"}):e?{type:"already_handled",status:e.status}:{type:"not_found"}}let s=await this.employeeRepo.findById(n.employeeId);if(!s)return await this.pendingRepo.updateStatus(n.id,i.PendingActionStatus.CANCELLED,a,o),{type:"not_found"};let r=n.createdAt,l=36e5*this.config.maxShiftHours;if(n.actionType===i.PendingActionType.START){let e=await this.shiftRepo.findOpenShift(s.id,o),t=null;if(e){if(!(r.getTime()>=e.startTime.getTime()+l))return await this.pendingRepo.updateStatus(n.id,i.PendingActionStatus.CANCELLED,a,o),{type:"open_shift_exists"};let s=new Date(e.startTime.getTime()+l),d=60*this.config.maxShiftHours;if(!(t=await this.shiftRepo.autoCloseShift(e.id,s,d,a,o)))return await this.pendingRepo.updateStatus(n.id,i.PendingActionStatus.CANCELLED,a,o),{type:"open_shift_exists"};await this.applyShortShiftViolation(t.id,d,o)}return{type:"confirmed_start",shift:await this.shiftRepo.createShiftStart({employeeId:s.id,startTime:r,startPhotoFileId:n.photoFileId,startMessageId:n.photoMessageId,startChatId:n.chatId},o),employee:s,autoClose:t}}let d=await this.shiftRepo.findOpenShift(s.id,o);if(!d)return await this.pendingRepo.updateStatus(n.id,i.PendingActionStatus.CANCELLED,a,o),{type:"no_open_shift"};if(r.getTime()>=d.startTime.getTime()+l){let e=new Date(d.startTime.getTime()+l),t=60*this.config.maxShiftHours,s=await this.shiftRepo.autoCloseShift(d.id,e,t,a,o);return s?(await this.applyShortShiftViolation(s.id,t,o),{type:"auto_closed",autoClose:s}):(await this.pendingRepo.updateStatus(n.id,i.PendingActionStatus.CANCELLED,a,o),{type:"no_open_shift"})}let p=Math.max(0,Math.round((r.getTime()-d.startTime.getTime())/6e4)),u=await this.shiftRepo.closeShiftByUserPhoto({shiftId:d.id,endTime:r,endPhotoFileId:n.photoFileId,endMessageId:n.photoMessageId,endChatId:n.chatId,durationMinutes:p},o);return await this.applyShortShiftViolation(u.id,p,o),{type:"confirmed_end",shift:u,employee:s,durationMinutes:p}})}async cancelAction(e,t,a=new Date){return this.runInTransaction(async o=>{let n=await this.pendingRepo.findById(e,o);if(!n)return{type:"not_found"};if(n.telegramUserId!==t)return{type:"forbidden"};if(n.status!==i.PendingActionStatus.PENDING)return{type:"already_handled",status:n.status};if(n.expiresAt<=a)return await this.pendingRepo.updateStatus(n.id,i.PendingActionStatus.EXPIRED,a,o),{type:"expired"};if(0===await this.pendingRepo.updateStatusIfPending(n.id,a,i.PendingActionStatus.CANCELLED,o)){let e=await this.pendingRepo.findById(n.id,o);return e&&e.status===i.PendingActionStatus.PENDING&&e.expiresAt<=a?(await this.pendingRepo.updateStatus(e.id,i.PendingActionStatus.EXPIRED,a,o),{type:"expired"}):e?{type:"already_handled",status:e.status}:{type:"not_found"}}return{type:"cancelled"}})}async expirePendingActions(e=new Date,t){return this.pendingRepo.expirePendingActions(e,t)}async applyShortShiftViolation(e,t,a){null!==t&&t<this.config.minShiftMinutes-this.config.shortShiftGraceMinutes&&await this.shiftRepo.createViolation(e,i.ViolationType.SHORT_SHIFT,a)}}var _=a(3555),M=a.n(_),R=a(4799),A=a.n(R),O=a(8466),N=a.n(O);M().extend(A()),M().extend(N());class C{constructor(e){this.shiftRepo=e}buildRange(e,t,a=new Date){let i=M()(a).tz(t);if("today"===e)return{key:e,from:i.startOf("day").toDate(),to:a,label:"–°–µ–≥–æ–¥–Ω—è"};if("yesterday"===e){let t=i.subtract(1,"day").startOf("day"),a=i.startOf("day");return{key:e,from:t.toDate(),to:a.toDate(),label:"–í—á–µ—Ä–∞"}}return{key:e,from:i.subtract(3,"day").toDate(),to:a,label:"–ü–æ—Å–ª–µ–¥–Ω–∏–µ 3 –¥–Ω—è"}}async listEmployeeShifts(e,t,a){return(await this.shiftRepo.findEmployeeShiftsInRange(e,t.from,t.to,a)).map(e=>({id:e.id,startTime:e.startTime,endTime:e.endTime,closedReason:e.closedReason,violations:e.violations.map(e=>e.type)}))}async getShiftDetails(e){return this.shiftRepo.findShiftById(e)}}var b=a(2161),D=a(3406);let P=b.Markup.keyboard([["–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏","–û—Ç—á—ë—Ç"],["–ü–æ–º–æ—â—å"]]).resize(),v=b.Markup.keyboard([["–°—Ç–∞—Ç—É—Å"],["–ü–æ–º–æ—â—å"]]).resize(),$=b.Markup.keyboard([["–†–µ–∂–∏–º: –ê–¥–º–∏–Ω","–†–µ–∂–∏–º: –°–æ—Ç—Ä—É–¥–Ω–∏–∫"]]).resize(),k=b.Markup.inlineKeyboard([[b.Markup.button.callback("–ê–¥–º–∏–Ω —Ä–µ–∂–∏–º","mode:ADMIN"),b.Markup.button.callback("–†–µ–∂–∏–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞","mode:EMPLOYEE")]]),U=(e,t)=>{e.start(async e=>{let a=e.from?.id;if(!a)return;let i=await t.resolveRole(String(a));if(i.isBoth){await e.reply(D.s.startBoth,$);return}if("ADMIN"===i.mode){await e.reply(D.s.startAdmin,P);return}await e.reply(D.s.startEmployee,v)})},F=(e,t,a)=>{let i=async(e,i)=>{let o=await a.resolveRole(e);if(!o.isEmployee||"EMPLOYEE"!==o.mode){await i(D.s.notEmployee);return}let s=await t.getOpenShiftStatus(e);if(!s){await i(D.s.noOpenShift);return}let r=(0,g.mr)(s.startTime,n.O.timezone);await i(D.s.openShift(r))};e.command("status",async e=>{let t=e.from?.id;t&&await i(String(t),t=>e.reply(t))}),e.hears("–°—Ç–∞—Ç—É—Å",async e=>{let t=e.from?.id;t&&await i(String(t),t=>e.reply(t))})},B=e=>async(t,a)=>{let i=t.from?.id;if(t.chat?.id&&i){if(!await e.isAdmin(String(i))){await t.reply(D.s.noAccess);return}return a()}},x=e=>encodeURIComponent(e),H=e=>{let t=e.employees.map(t=>{let a=t.displayName||t.username||t.telegramUserId,i=`emp_select:${t.id}:${e.page}:${x(e.query??"")}`;return[b.Markup.button.callback(a,i)]}),a=[b.Markup.button.callback("‚óÄÔ∏è",`emp_page:${Math.max(1,e.page-1)}:${x(e.query??"")}`),b.Markup.button.callback("‚ñ∂Ô∏è",`emp_page:${Math.min(e.totalPages,e.page+1)}:${x(e.query??"")}`)],i=[b.Markup.button.callback("–ü–æ–∏—Å–∫","emp_search"),b.Markup.button.callback("–ù–∞–∑–∞–¥","emp_back")];return b.Markup.inlineKeyboard([...t,a,i])},L=e=>{let t=x(e.query??"");return b.Markup.inlineKeyboard([[b.Markup.button.callback("–û—Ç—á—ë—Ç",`emp_action:report:${e.employeeId}:${e.page}:${t}`)],[b.Markup.button.callback("–§–æ—Ç–æ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –¥–Ω—è)",`emp_action:photos:${e.employeeId}:${e.page}:${t}`)],[b.Markup.button.callback("–ù–∞–∑–∞–¥",`emp_page:${e.page}:${t}`)]])},V=e=>{let t=x(e.query??""),a=e.backAction??`emp_page:${e.backPage}:${t}`;return b.Markup.inlineKeyboard([[b.Markup.button.callback("–ó–∞ 3 –¥–Ω—è",`period_emp:3:${e.employeeId}`),b.Markup.button.callback("–ó–∞ 7 –¥–Ω–µ–π",`period_emp:7:${e.employeeId}`)],[b.Markup.button.callback("–ó–∞ 30 –¥–Ω–µ–π",`period_emp:30:${e.employeeId}`)],[b.Markup.button.callback("–ù–∞–∑–∞–¥",a)]])},Q=e=>{let t=x(e.query??"");return b.Markup.inlineKeyboard([[b.Markup.button.callback("–°–µ–≥–æ–¥–Ω—è",`emp_photo_period:today:${e.employeeId}:${e.page}:${t}`),b.Markup.button.callback("–í—á–µ—Ä–∞",`emp_photo_period:yesterday:${e.employeeId}:${e.page}:${t}`)],[b.Markup.button.callback("–ü–æ—Å–ª–µ–¥–Ω–∏–µ 3 –¥–Ω—è",`emp_photo_period:last3:${e.employeeId}:${e.page}:${t}`)],[b.Markup.button.callback("–ù–∞–∑–∞–¥",`emp_action:menu:${e.employeeId}:${e.page}:${t}`)]])},q=e=>{let t=x(e.query??""),a=e.shifts.map(e=>[b.Markup.button.callback(e.label,`emp_photo_shift:${e.id}`)]);return a.push([b.Markup.button.callback("–ù–∞–∑–∞–¥",`emp_action:photos:${e.employeeId}:${e.page}:${t}`)]),b.Markup.inlineKeyboard(a)},Y=()=>b.Markup.inlineKeyboard([[b.Markup.button.callback("–ó–∞ 3 –¥–Ω—è","period_all:3"),b.Markup.button.callback("–ó–∞ 7 –¥–Ω–µ–π","period_all:7")],[b.Markup.button.callback("–ó–∞ 30 –¥–Ω–µ–π","period_all:30")]]),G=(e,t)=>b.Markup.inlineKeyboard([[b.Markup.button.callback("–≠–∫—Å–ø–æ—Ä—Ç CSV",`export_emp:csv:${t}:${e}`)]]),z=e=>b.Markup.inlineKeyboard([[b.Markup.button.callback("–≠–∫—Å–ø–æ—Ä—Ç CSV",`export_all:csv:${e}`),b.Markup.button.callback("–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏","emp_page:1:")]]),K=e=>`${Math.floor(e/60)} —á ${e%60} –º–∏–Ω`,W={NOT_CLOSED_IN_TIME:"–ù–µ –∑–∞–∫—Ä—ã–ª(–∞) —Å–º–µ–Ω—É –≤–æ–≤—Ä–µ–º—è",SHORT_SHIFT:"–°–º–µ–Ω–∞ –º–µ–Ω—å—à–µ 8 —á–∞—Å–æ–≤"},j=e=>{if(0===e.length)return"–Ω–µ—Ç";let t=e.map(e=>W[e]??String(e)).join(", ");return`${t} ‚ö†Ô∏è`},Z=e=>0===e.length?"–ù–∞—Ä—É—à–µ–Ω–∏—è: –Ω–µ—Ç":`–ù–∞—Ä—É—à–µ–Ω–∏—è: –µ—Å—Ç—å (${e.length}) ‚ö†Ô∏è`,X=e=>e===i.ClosedReason.AUTO_TIMEOUT?"–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (12 —á–∞—Å–æ–≤)":e===i.ClosedReason.USER_PHOTO?"–§–æ—Ç–æ":"‚Äî",J=(e,t)=>{let a=[];if(a.push("–û—Ç—á—ë—Ç –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É"),a.push(`–°–æ—Ç—Ä—É–¥–Ω–∏–∫: ${e.displayName}`),a.push(`–ü–µ—Ä–∏–æ–¥: ${(0,g.p6)(e.period.from,t)} ‚Äì ${(0,g.p6)(e.period.to,t)}`),a.push(`–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–º–µ–Ω: ${e.totalShifts}`),a.push(`–°—É–º–º–∞—Ä–Ω–æ–µ –≤—Ä–µ–º—è: ${K(e.totalDurationMinutes)}`),a.push(`–°—Ä–µ–¥–Ω—è—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–º–µ–Ω—ã: ${K(e.averageDurationMinutes)}`),a.push("–ù–∞—Ä—É—à–µ–Ω–∏—è:"),a.push(`- –ù–µ –∑–∞–∫—Ä—ã–ª(–∞) —Å–º–µ–Ω—É –≤–æ–≤—Ä–µ–º—è: ${e.violationsNotClosedInTime}`),a.push(`- –°–º–µ–Ω–∞ –º–µ–Ω—å—à–µ 8 —á–∞—Å–æ–≤: ${e.violationsShortShift}`),a.push(`- –í—Å–µ–≥–æ –Ω–∞—Ä—É—à–µ–Ω–∏–π: ${e.violationsTotal}`),0===e.shifts.length)return a.push(""),a.push(D.s.reportEmpty),a.join("\n");for(let i of(a.push(""),a.push("–°–º–µ–Ω—ã (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10):"),e.shifts)){let e=(0,g.p6)(i.startTime,t),o=(0,g.mr)(i.startTime,t);if(!i.endTime){a.push(`- ${e} –û—Ç–∫—Ä—ã—Ç–∞ —Å ${o} | –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ‚Äî | –ó–∞–∫—Ä—ã—Ç–∏–µ: ‚Äî | –ù–∞—Ä—É—à–µ–Ω–∏—è: ‚Äî`);continue}let n=(0,g.mr)(i.endTime,t),s=null!=i.durationMinutes?K(i.durationMinutes):"‚Äî",r=X(i.closedReason),l=j(i.violations);a.push(`- ${e} ${o}‚Äì${n} | –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${s} | –ó–∞–∫—Ä—ã—Ç–∏–µ: ${r} | –ù–∞—Ä—É—à–µ–Ω–∏—è: ${l}`)}return a.join("\n")},ee=(e,t)=>{let a=[];if(a.push("–°–≤–æ–¥–Ω—ã–π –æ—Ç—á—ë—Ç"),a.push(`–ü–µ—Ä–∏–æ–¥: ${(0,g.p6)(e.period.from,t)} ‚Äì ${(0,g.p6)(e.period.to,t)}`),a.push(`–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ –æ—Ç—á—ë—Ç–µ: ${e.totalEmployees}`),a.push(`–í—Å–µ–≥–æ —Å–º–µ–Ω: ${e.totalShifts}`),a.push(`–°—É–º–º–∞—Ä–Ω–æ–µ –≤—Ä–µ–º—è: ${K(e.totalDurationMinutes)}`),a.push("–ù–∞—Ä—É—à–µ–Ω–∏—è:"),a.push(`- –ù–µ –∑–∞–∫—Ä—ã–ª(–∞) –≤–æ–≤—Ä–µ–º—è: ${e.violationsNotClosedInTime}`),a.push(`- –°–º–µ–Ω–∞ –º–µ–Ω—å—à–µ 8 —á–∞—Å–æ–≤: ${e.violationsShortShift}`),a.push(`- –í—Å–µ–≥–æ –Ω–∞—Ä—É—à–µ–Ω–∏–π: ${e.totalViolations}`),0===e.topEmployees.length)return a.push(""),a.push(D.s.reportEmpty),a.join("\n");for(let t of(a.push(""),a.push("–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ (—Ç–æ–ø –ø–æ –Ω–∞—Ä—É—à–µ–Ω–∏—è–º, –∑–∞—Ç–µ–º –ø–æ —á–∞—Å–∞–º):"),e.topEmployees))a.push(`- ${t.displayName} ‚Äî —Å–º–µ–Ω: ${t.totalShifts}, –≤—Ä–µ–º—è: ${K(t.totalDurationMinutes)}, –Ω–∞—Ä—É—à: ${t.violationsTotal} (–Ω–µ –∑–∞–∫—Ä—ã–ª: ${t.violationsNotClosedInTime}, <8—á: ${t.violationsShortShift})`);return a.join("\n")},et=(e,t=4e3)=>{if(e.length<=t)return[e];let a=e.split("\n"),i=[],o="";for(let e of a){let a=o?`${o}
${e}`:e;a.length>t?o?(i.push(o),o=e):(i.push(e.slice(0,t)),o=e.slice(t)):o=a}return o&&i.push(o),i},ea=e=>{let t=e.trim().split(" ");return t.length<=1?"":t.slice(1).join(" ").trim().slice(0,30)},ei=e=>{let t=e.split(":"),a=Number(t[1]??"1"),i=decodeURIComponent(t[2]??"");return{page:Number.isFinite(a)&&a>0?a:1,query:i}},eo=e=>{let t=e.split(":"),a=Number(t[1]??"0"),i=Number(t[2]??"1"),o=decodeURIComponent(t[3]??"");return{employeeId:Number.isFinite(a)?a:0,page:Number.isFinite(i)&&i>0?i:1,query:o}},en=e=>{let t=e.split(":"),a=t[1]??"",i=Number(t[2]??"0"),o=Number(t[3]??"1"),n=decodeURIComponent(t[4]??"");return{action:a,employeeId:Number.isFinite(i)?i:0,page:Number.isFinite(o)&&o>0?o:1,query:n}},es=e=>{let t=e.split(":"),a=Number(t[1]??"0"),i=Number(t[2]??"0");return{days:Number.isFinite(a)?a:0,employeeId:Number.isFinite(i)?i:0}},er=e=>{let t=e.split(":"),a=t[1]??"last3",i=Number(t[2]??"0"),o=Number(t[3]??"1"),n=decodeURIComponent(t[4]??"");return{range:a,employeeId:Number.isFinite(i)?i:0,page:Number.isFinite(o)&&o>0?o:1,query:n}},el=e=>{let t=(0,g.yD)(e.startTime,e.timezone),a="AUTO_TIMEOUT"===e.closedReason?"–ê–≤—Ç–æ12—á":"USER_PHOTO"===e.closedReason?"–§–æ—Ç–æ":"–û—Ç–∫—Ä—ã—Ç–∞",i=Z(e.violations);return`${t} ‚Äî ${a} ‚Äî ${i}`},ed=(e,t,a,i,o,r)=>{let l=B(t),d=async(e,t)=>{let{items:i,total:o}=await a.listEmployees({page:t.page,pageSize:8,query:t.query}),n=Math.max(1,Math.ceil(o/8));if(0===o){await e.reply(D.s.noEmployeesFound);return}let s=t.query?`${D.s.employeesChoosePrompt}
–ü–æ–∏—Å–∫: ${t.query}`:D.s.employeesChoosePrompt;await e.reply(s,H({employees:i,page:Math.min(t.page,n),totalPages:n,query:t.query}))},p=async(e,t)=>{let i=await a.findById(t.employeeId);if(!i){await e.reply(D.s.noEmployeesFound);return}await e.reply(D.s.employeeActionPrompt(i.displayName),L({employeeId:i.id,page:t.page,query:t.query}))};e.command("employees",l,async e=>{let t=ea("text"in e.message?e.message.text:"");await d(e,{page:1,query:t})}),e.hears("–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏",l,async e=>{await d(e,{page:1,query:""})}),e.action(/^emp_page:/,l,async e=>{await e.answerCbQuery();let{page:t,query:a}=ei("data"in e.callbackQuery?e.callbackQuery.data:"");await d(e,{page:t,query:a})}),e.action(/^emp_select:/,l,async e=>{await e.answerCbQuery();let t=eo("data"in e.callbackQuery?e.callbackQuery.data:"");if(!t.employeeId){await e.reply(D.s.noEmployeesFound);return}await p(e,{employeeId:t.employeeId,page:t.page,query:t.query})}),e.action(/^emp_action:/,l,async e=>{await e.answerCbQuery();let t=en("data"in e.callbackQuery?e.callbackQuery.data:"");if(!t.employeeId){await e.reply(D.s.noEmployeesFound);return}if("menu"===t.action){await p(e,{employeeId:t.employeeId,page:t.page,query:t.query});return}let i=await a.findById(t.employeeId);if(!i){await e.reply(D.s.noEmployeesFound);return}if("report"===t.action){await e.reply(D.s.employeePeriodPrompt(i.displayName),V({employeeId:t.employeeId,backPage:t.page,query:t.query,backAction:`emp_action:menu:${t.employeeId}:${t.page}:${encodeURIComponent(t.query)}`}));return}"photos"===t.action&&await e.reply(D.s.photoPeriodPrompt(i.displayName),Q({employeeId:t.employeeId,page:t.page,query:t.query}))}),e.action(/^emp_search$/,l,async e=>{await e.answerCbQuery(),await e.reply(D.s.searchHint)}),e.action(/^emp_back$/,l,async e=>{await e.answerCbQuery(),await e.reply(D.s.startAdmin,P)}),e.action(/^period_emp:/,l,async e=>{await e.answerCbQuery();let{days:t,employeeId:a}=es("data"in e.callbackQuery?e.callbackQuery.data:"");if(t&&a)try{let o=await i.getEmployeeReport(a,t);if(!o){await e.reply(D.s.noEmployeesFound);return}let s=J(o,n.O.timezone);for(let t of et(s))await e.reply(t);await e.reply("–≠–∫—Å–ø–æ—Ä—Ç:",G(a,t))}catch(t){s.k.error({err:t},"Failed to build employee report"),await e.reply("–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")}}),e.action(/^emp_photo_period:/,l,async e=>{await e.answerCbQuery();let t=er("data"in e.callbackQuery?e.callbackQuery.data:"");if(t.employeeId&&t.range)try{let i=await a.findById(t.employeeId);if(!i){await e.reply(D.s.noEmployeesFound);return}let o=r.buildRange(t.range,n.O.timezone,new Date),s=await r.listEmployeeShifts(i.id,o,10);if(0===s.length){await e.reply(D.s.photoShiftsEmpty);return}let l=s.map(e=>({id:e.id,label:el({startTime:e.startTime,closedReason:e.closedReason,violations:e.violations,timezone:n.O.timezone})}));await e.reply(`–§–æ—Ç–æ: ${o.label}. –í—ã–±–µ—Ä–∏—Ç–µ —Å–º–µ–Ω—É:`,q({shifts:l,employeeId:i.id,page:t.page,query:t.query}))}catch(t){s.k.error({err:t},"Failed to build photo shift list"),await e.reply("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–º–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")}}),e.action(/^emp_photo_shift:/,l,async e=>{await e.answerCbQuery();let t=Number(("data"in e.callbackQuery?e.callbackQuery.data:"").split(":")[1]??"0");if(t)try{let a=await r.getShiftDetails(t);if(!a){await e.reply(D.s.shiftNotFound);return}let i=new Date(Date.now()-864e5*n.O.photoRetentionDays),o=!!a.photosPurgedAt||a.startTime<i,s=o?null:a.startPhotoFileId,l=o?null:a.endPhotoFileId,d=(0,g.o0)(a.startTime,n.O.timezone),p=a.endTime?(0,g.o0)(a.endTime,n.O.timezone):"–û—Ç–∫—Ä—ã—Ç–∞",u=null!=a.durationMinutes?K(a.durationMinutes):"‚Äî",m="AUTO_TIMEOUT"===a.closedReason?"–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (12 —á–∞—Å–æ–≤)":"USER_PHOTO"===a.closedReason?"–§–æ—Ç–æ":"‚Äî",y=a.violations.map(e=>e.type),c=a.endTime?j(y):"‚Äî";if(await e.reply(`–°–º–µ–Ω–∞: –¥–µ—Ç–∞–ª–∏
–°–æ—Ç—Ä—É–¥–Ω–∏–∫: ${a.employee.displayName}
–ü–µ—Ä–∏–æ–¥: ${d} ‚Äì ${p}
–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${u}
–°–ø–æ—Å–æ–± –∑–∞–∫—Ä—ã—Ç–∏—è: ${m}
–ù–∞—Ä—É—à–µ–Ω–∏—è: ${c}`),s?await e.replyWithPhoto(s,{caption:"–§–æ—Ç–æ –Ω–∞—á–∞–ª–∞ —Å–º–µ–Ω—ã"}):await e.reply(D.s.photoStartMissing),!a.endTime){await e.reply(D.s.photoEndNotClosed);return}if(l){await e.replyWithPhoto(l,{caption:"–§–æ—Ç–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–º–µ–Ω—ã"});return}if("AUTO_TIMEOUT"===a.closedReason){await e.reply(D.s.photoEndAutoClosed);return}await e.reply(D.s.photoEndMissing)}catch(t){s.k.error({err:t},"Failed to send shift photos"),await e.reply("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ —Å–º–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")}}),e.action(/^export_emp:/,l,async e=>{await e.answerCbQuery();let t=("data"in e.callbackQuery?e.callbackQuery.data:"").split(":"),a=t[1],r=Number(t[2]??"0"),l=Number(t[3]??"0");if("csv"===a&&r&&l)try{let t=await i.getEmployeeReport(l,r);if(!t){await e.reply(D.s.noEmployeesFound);return}let a=await i.getEmployeeShiftsForExport(l,r),s={...t,shifts:a},d=o.buildEmployeeReportCsv(s,n.O.timezone);await e.replyWithDocument({source:d.content,filename:d.filename})}catch(t){s.k.error({err:t},"Failed to export employee report"),await e.reply("–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")}})},ep=e=>{let t=Number(e.split(":")[1]??"0");return Number.isFinite(t)?t:0},eu=(e,t,a,i)=>{let o=B(t),r=async e=>{await e.reply(D.s.reportAllPrompt,Y())};e.command("report",o,async e=>{await r(e)}),e.hears("–û—Ç—á—ë—Ç",o,async e=>{await r(e)}),e.action(/^period_all:/,o,async e=>{await e.answerCbQuery();let t=ep("data"in e.callbackQuery?e.callbackQuery.data:"");if(t)try{let i=await a.getAllEmployeesReport(t),o=ee(i,n.O.timezone);for(let t of et(o))await e.reply(t);await e.reply("–≠–∫—Å–ø–æ—Ä—Ç:",z(t))}catch(t){s.k.error({err:t},"Failed to build all employees report"),await e.reply("–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")}}),e.action(/^export_all:/,o,async e=>{await e.answerCbQuery();let t=("data"in e.callbackQuery?e.callbackQuery.data:"").split(":"),o=t[1],r=Number(t[2]??"0");if("csv"===o&&r)try{let t=await a.getAllEmployeesReport(r),o=i.buildAllEmployeesSummaryCsv(t.period,t.employees,n.O.timezone);await e.replyWithDocument({source:o.content,filename:o.filename});let s=await a.getRawShiftsForExport(r,new Date,2e3);if(s.shifts.length>0&&s.shifts.length<2e3){let t=i.buildRawShiftsCsv(s.period,s.shifts,n.O.timezone);await e.replyWithDocument({source:t.content,filename:t.filename})}else s.shifts.length>=2e3&&await e.reply(D.s.exportSkipped)}catch(t){s.k.error({err:t},"Failed to export all employees report"),await e.reply("–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")}})},em=e=>b.Markup.inlineKeyboard([[b.Markup.button.callback("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å",`pending_confirm:${e}`),b.Markup.button.callback("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å",`pending_cancel:${e}`)]]),ey=(e,t,a)=>{e.on("photo",async e=>{let o=e.from,n=e.chat,r=e.message;if(!o||!n||!r||!("photo"in r))return;let l=r.photo;if(!l||0===l.length)return;let d=l[l.length-1].file_id,p=new Date(1e3*r.date),u=await t.resolveRole(String(o.id));if(!t.shouldProcessPhoto(u)){"ADMIN"===u.mode?await e.reply(D.s.adminPhotoIgnored):await e.reply(D.s.notEmployee);return}try{let t=await a.createFromPhoto({user:{id:o.id,username:o.username,firstName:o.first_name,lastName:o.last_name,chatId:n.id},messageId:r.message_id,chatId:n.id,fileId:d,messageDate:p});if("duplicate"===t.type)return;let s=t.actionType===i.PendingActionType.START?D.s.confirmStartPrompt:D.s.confirmEndPrompt;await e.reply(s,em(t.pendingAction.id))}catch(t){s.k.error({err:t},"Failed to create pending action"),await e.reply("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–æ—Ç–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")}}),e.catch((e,t)=>{let a=t.update;s.k.error({err:e,updateId:a?.update_id,updateType:t.updateType,chatId:t.chat?.id,fromId:t.from?.id,messageId:a?.message?.message_id,callbackData:a?.callback_query?.data},"Bot error")})},ec=e=>{let t=Number(e.split(":")[1]??"0");return Number.isFinite(t)?t:0},eh=(e,t,a)=>{e.action(/^pending_confirm:/,async i=>{await i.answerCbQuery();let o=ec("data"in i.callbackQuery?i.callbackQuery.data:""),r=i.from?.id;if(o&&r)try{let l=await t.confirmAction(o,String(r)),d=await a.getAdminChatIds();if("confirmed_start"===l.type){if(l.autoClose){let t=(0,g.mr)(l.autoClose.endTime??new Date,n.O.timezone),a=D.s.autoClosedBoss(l.employee.displayName,t,n.O.maxShiftHours);for(let t of d)try{await e.telegram.sendMessage(t,a)}catch(e){s.k.error({err:e,adminChatId:t},"Failed to notify admin about auto-close")}if(n.O.notifyEmployeeOnAutoClose)try{await e.telegram.sendMessage(l.employee.telegramUserId,D.s.autoClosedEmployee(n.O.maxShiftHours))}catch(e){s.k.error({err:e,employeeId:l.employee.telegramUserId},"Failed to notify employee")}}let t=(0,g.mr)(l.shift.startTime,n.O.timezone);await i.reply(D.s.shiftStarted(t));let a=D.s.bossShiftStarted(l.employee.displayName,t);for(let t of d)try{await e.telegram.sendMessage(t,a)}catch(e){s.k.error({err:e,adminChatId:t},"Failed to notify admin about shift start")}return}if("confirmed_end"===l.type){let t=(0,g.mr)(l.shift.endTime??new Date,n.O.timezone),a=K(l.durationMinutes);await i.reply(D.s.shiftClosed(t,a));let o=D.s.bossShiftClosed(l.employee.displayName,a);for(let t of d)try{await e.telegram.sendMessage(t,o)}catch(e){s.k.error({err:e,adminChatId:t},"Failed to notify admin about shift close")}return}if("auto_closed"===l.type){let t=(0,g.mr)(l.autoClose.endTime??new Date,n.O.timezone),a=D.s.autoClosedBoss(l.autoClose.employee.displayName,t,n.O.maxShiftHours);for(let t of d)try{await e.telegram.sendMessage(t,a)}catch(e){s.k.error({err:e,adminChatId:t},"Failed to notify admin about auto-close")}n.O.notifyEmployeeOnAutoClose?await i.reply(D.s.autoClosedEmployee(n.O.maxShiftHours)):await i.reply(D.s.alreadyClosed);return}if("open_shift_exists"===l.type){await i.reply(D.s.openShiftExists);return}if("no_open_shift"===l.type){await i.reply(D.s.alreadyClosed);return}if("expired"===l.type){await i.reply(D.s.pendingExpired);return}if("already_handled"===l.type){await i.reply(D.s.pendingAlreadyHandled);return}if("forbidden"===l.type){await i.reply(D.s.noAccess);return}"not_found"===l.type&&await i.reply(D.s.pendingNotFound)}catch(e){s.k.error({err:e},"Failed to confirm pending action"),await i.reply("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")}}),e.action(/^pending_cancel:/,async e=>{await e.answerCbQuery();let a=ec("data"in e.callbackQuery?e.callbackQuery.data:""),i=e.from?.id;if(a&&i)try{let o=await t.cancelAction(a,String(i));if("cancelled"===o.type){await e.reply(D.s.pendingCancelled);return}if("expired"===o.type){await e.reply(D.s.pendingExpired);return}if("already_handled"===o.type){await e.reply(D.s.pendingAlreadyHandled);return}if("forbidden"===o.type){await e.reply(D.s.noAccess);return}"not_found"===o.type&&await e.reply(D.s.pendingNotFound)}catch(t){s.k.error({err:t},"Failed to cancel pending action"),await e.reply("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")}})},ef=(e,t)=>{e.on("message",async e=>{let a=e.message;if(!a||"photo"in a||"text"in a&&a.text.startsWith("/")||"text"in a&&["–ü–æ–º–æ—â—å","–°—Ç–∞—Ç—É—Å","–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏","–û—Ç—á—ë—Ç","–†–µ–∂–∏–º: –ê–¥–º–∏–Ω","–†–µ–∂–∏–º: –°–æ—Ç—Ä—É–¥–Ω–∏–∫"].includes(a.text))return;let i=e.from?.id;if(i){if("ADMIN"===(await t.resolveRole(String(i))).mode){await e.reply(D.s.instructionAdmin);return}await e.reply(D.s.instructionEmployee)}})},eg=e=>{e.command("whoami",async e=>{let t=e.chat,a=e.from;if(!t||!a)return;let i=a.username?`@${a.username}`:"‚Äî",o=[`–¢–∏–ø —á–∞—Ç–∞: ${t.type}`,`Chat ID: ${t.id}`,`–í–∞—à User ID: ${a.id}`,`Username: ${i}`,`–ü–æ–¥—Å–∫–∞–∑–∫–∞: TELEGRAM_BOSS_CHAT_ID = ${t.id}, ADMIN_USER_IDS += ${a.id}`];await e.reply(o.join("\n"))})},eI=(e,t)=>{e.command("set_admin",async e=>{let a=e.from?.id;if(a){if(!await t.canAssignAdmin(String(a))){await e.reply(D.s.noAccess);return}await t.addAdmin(String(a)),await e.reply(D.s.setAdminSuccess)}})},eS=(e,t)=>{let a=async(e,a)=>{let i=await t.resolveRole(e);if(i.isBoth){let e="ADMIN"===i.mode?"–ê–¥–º–∏–Ω":"–°–æ—Ç—Ä—É–¥–Ω–∏–∫";await a(`${D.s.helpBoth}
–¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º: ${e}.`);return}if("ADMIN"===i.mode){await a(D.s.helpAdmin);return}await a(D.s.helpEmployee)};e.command("help",async e=>{let t=e.from?.id;t&&await a(String(t),t=>e.reply(t))}),e.hears("–ü–æ–º–æ—â—å",async e=>{let t=e.from?.id;t&&await a(String(t),t=>e.reply(t))})},ew=(e,t)=>{let a=async(e,a,o)=>{if(!(await t.resolveRole(e)).isBoth){await o(D.s.modeUnavailable);return}if(await t.setMode(e,a),a===i.UserMode.ADMIN){await o(D.s.modeSetAdmin);return}await o(D.s.modeSetEmployee)};e.command("mode",async e=>{let a=e.from?.id;if(a){if(!(await t.resolveRole(String(a))).isBoth){await e.reply(D.s.modeUnavailable);return}await e.reply(D.s.modePrompt,k)}}),e.action(/^mode:(ADMIN|EMPLOYEE)$/,async e=>{await e.answerCbQuery();let t=e.from?.id;if(!t)return;let o=("data"in e.callbackQuery?e.callbackQuery.data:"").split(":")[1];("ADMIN"===o||"EMPLOYEE"===o)&&await a(String(t),"ADMIN"===o?i.UserMode.ADMIN:i.UserMode.EMPLOYEE,t=>e.reply(t))}),e.hears("–†–µ–∂–∏–º: –ê–¥–º–∏–Ω",async e=>{let t=e.from?.id;t&&await a(String(t),i.UserMode.ADMIN,t=>e.reply(t))}),e.hears("–†–µ–∂–∏–º: –°–æ—Ç—Ä—É–¥–Ω–∏–∫",async e=>{let t=e.from?.id;t&&await a(String(t),i.UserMode.EMPLOYEE,t=>e.reply(t))})},eT=e=>{let t=new b.Telegraf(n.O.telegramBotToken);return U(t,e.roleService),F(t,e.shiftService,e.roleService),eg(t),eS(t,e.roleService),ew(t,e.roleService),eI(t,e.adminService),ed(t,e.adminService,e.employeeRepo,e.reportService,e.exportService,e.photoReviewService),eu(t,e.adminService,e.reportService,e.exportService),ey(t,e.roleService,e.pendingActionService),eh(t,e.pendingActionService,e.adminService),ef(t,e.roleService),t},eE=globalThis,e_=async()=>(eE.__shiftBotApp||(eE.__shiftBotApp=(async()=>{await o.$connect();let e=new l,t=new d,a=new p,i=new u,r=new m,g=new h(a),I=new y(e,t,{maxShiftHours:n.O.maxShiftHours,minShiftMinutes:60*n.O.minShiftHours,shortShiftGraceMinutes:n.O.shortShiftGraceMinutes},s.k),S=new c(t,e),w=new f(g,e,i),_=new T,M=new C(t),R=new E(e,t,r,{ttlMinutes:n.O.pendingActionTtlMinutes,maxShiftHours:n.O.maxShiftHours,minShiftMinutes:60*n.O.minShiftHours,shortShiftGraceMinutes:n.O.shortShiftGraceMinutes},async e=>o.$transaction(async t=>e(t)));return{prisma:o,bot:eT({shiftService:I,reportService:S,adminService:g,roleService:w,employeeRepo:e,exportService:_,pendingActionService:R,photoReviewService:M}),employeeRepo:e,shiftRepo:t,shiftService:I,adminService:g,roleService:w,reportService:S,exportService:_,pendingActionService:R,photoReviewService:M}})()),eE.__shiftBotApp)},6751:(e,t,a)=>{a.d(t,{TW:()=>y,mr:()=>d,o0:()=>u,p6:()=>p,yD:()=>m});var i=a(3555),o=a.n(i),n=a(4799),s=a.n(n),r=a(8466),l=a.n(r);o().extend(s()),o().extend(l());let d=(e,t)=>o()(e).tz(t).format("HH:mm"),p=(e,t)=>o()(e).tz(t).format("DD.MM.YYYY"),u=(e,t)=>o()(e).tz(t).format("DD.MM.YYYY HH:mm"),m=(e,t)=>o()(e).tz(t).format("DD.MM HH:mm"),y=(e,t)=>o()(e).tz(t).format("YYYY-MM-DD")}};