"use strict";exports.id=830,exports.ids=[830],exports.modules={3406:(e,t,a)=>{a.d(t,{s:()=>i});let i={startEmployee:"–ü—Ä–∏–≤–µ—Ç! –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–º–µ–Ω—É, –∑–∞—Ç–µ–º –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ. –§–æ—Ç–æ –µ—â—ë —Ä–∞–∑ ‚Äî –∑–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É.",startAdmin:"–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä.\n–ö–æ–º–∞–Ω–¥—ã: /employees, /report, /whoami, /help",startBoth:"–í—ã –º–æ–∂–µ—Ç–µ —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∏–ª–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫. –¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º: –ê–¥–º–∏–Ω.",namePrompt:"–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º. –ü—Ä–∏–º–µ—Ä: –ò–ª—å—è—Å –Ø–Ω–≥—É—Ä–∞–∑–æ–≤",nameInvalid:"–ù—É–∂–Ω–æ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—è. –ü—Ä–∏–º–µ—Ä: –ò–ª—å—è—Å –Ø–Ω–≥—É—Ä–∞–∑–æ–≤",nameSaved:e=>`–ì–æ—Ç–æ–≤–æ. –í–∞—à–µ –∏–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ${e}`,fullNamePrompt:"–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º. –ü—Ä–∏–º–µ—Ä: Ilias Iangurazov",fullNameInvalid:"–ù—É–∂–Ω–æ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—è. –ü—Ä–∏–º–µ—Ä: Ilias Iangurazov",fullNameSaved:e=>`–ì–æ—Ç–æ–≤–æ. –ò–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–æ: ${e}`,fullNameNotEmployee:"–ö–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –¥–æ–±–∞–≤—å—Ç–µ —Å–µ–±—è –∫–∞–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.",instructionEmployee:"–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ.",instructionAdmin:"–í—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /employees –∏–ª–∏ /help.",noAccess:"–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞.",noOpenShift:"–û—Ç–∫—Ä—ã—Ç—ã—Ö —Å–º–µ–Ω –Ω–µ—Ç.",openShift:e=>`–û—Ç–∫—Ä—ã—Ç–∞—è —Å–º–µ–Ω–∞ —Å ${e}`,shiftStarted:e=>`–°–º–µ–Ω–∞ –Ω–∞—á–∞–ª–∞—Å—å: ${e}`,shiftClosed:(e,t)=>`–°–º–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∞: ${e}. –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${t}.`,bossShiftStarted:(e,t)=>`‚úÖ ${e} –Ω–∞—á–∞–ª(–∞) —Å–º–µ–Ω—É –≤ ${t}`,bossShiftClosed:(e,t)=>`üèÅ ${e} –∑–∞–∫—Ä—ã–ª(–∞) —Å–º–µ–Ω—É. –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${t}.`,autoClosedBoss:(e,t,a)=>`‚ö†Ô∏è ${e} –Ω–µ –∑–∞–∫—Ä—ã–ª(–∞) —Å–º–µ–Ω—É –≤–æ–≤—Ä–µ–º—è. –°–º–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã—Ç–∞ –≤ ${t} (${a} —á–∞—Å–æ–≤). –ù–∞—Ä—É—à–µ–Ω–∏–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ.`,autoClosedEmployee:e=>`‚ö†Ô∏è –í—ã –Ω–µ –∑–∞–∫—Ä—ã–ª–∏ —Å–º–µ–Ω—É –≤–æ–≤—Ä–µ–º—è. –°–º–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã—Ç–∞ —á–µ—Ä–µ–∑ ${e} —á–∞—Å–æ–≤. –ù–∞—Ä—É—à–µ–Ω–∏–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ.`,alreadyClosed:"–û—Ç–∫—Ä—ã—Ç–∞—è —Å–º–µ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ (–≤–æ–∑–º–æ–∂–Ω–æ, –æ–Ω–∞ –±—ã–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã—Ç–∞).",reportChoosePeriod:"–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –æ—Ç—á—ë—Ç–∞:",employeesChoosePrompt:"–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏: –≤—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.",reportAllPrompt:"–û—Ç—á—ë—Ç: —Å–≤–æ–¥–∫–∞ –ø–æ –≤—Å–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º. –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥.",employeePeriodPrompt:e=>`–°–æ—Ç—Ä—É–¥–Ω–∏–∫: ${e}. –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥:`,employeeActionPrompt:e=>`–°–æ—Ç—Ä—É–¥–Ω–∏–∫: ${e}. –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:`,photoPeriodPrompt:e=>`–§–æ—Ç–æ –¥–ª—è ${e}. –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥:`,exportReady:"–§–∞–π–ª –≥–æ—Ç–æ–≤.",exportSkipped:"–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–º–µ–Ω –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞. –û—Ç–ø—Ä–∞–≤–ª–µ–Ω —Ç–æ–ª—å–∫–æ –æ–±—â–∏–π —Ñ–∞–π–ª.",searchHint:"–í–≤–µ–¥–∏—Ç–µ /employees <–∑–∞–ø—Ä–æ—Å> –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ username.",noEmployeesFound:"–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.",reportEmpty:"–î–∞–Ω–Ω—ã–µ –∑–∞ –ø–µ—Ä–∏–æ–¥ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.",setAdminSuccess:"–í—ã –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.",adminPhotoIgnored:"–í—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä. –§–æ—Ç–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–º–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /employees –∏–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º.",notEmployee:"–í—ã –Ω–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Å–µ–±—è –∫–∞–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.",confirmStartPrompt:"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–∞—á–∞–ª–æ —Å–º–µ–Ω—ã?",confirmEndPrompt:"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã?",pendingCancelled:"–û—Ç–º–µ–Ω–µ–Ω–æ. –§–æ—Ç–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ —Å–º–µ–Ω–µ.",pendingExpired:"–í—Ä–µ–º—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –∑–∞–Ω–æ–≤–æ.",pendingAlreadyHandled:"–î–µ–π—Å—Ç–≤–∏–µ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ.",pendingNotFound:"–î–µ–π—Å—Ç–≤–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.",openShiftExists:"–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç–∞—è —Å–º–µ–Ω–∞. –°–Ω–∞—á–∞–ª–∞ –∑–∞–∫—Ä–æ–π—Ç–µ –µ—ë.",photoShiftsEmpty:"–°–º–µ–Ω—ã –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.",photoStartMissing:"–§–æ—Ç–æ –Ω–∞—á–∞–ª–∞ —Å–º–µ–Ω—ã: —É–¥–∞–ª–µ–Ω–æ –ø–æ –ø–æ–ª–∏—Ç–∏–∫–µ —Ö—Ä–∞–Ω–µ–Ω–∏—è (3 –¥–Ω—è).",photoEndMissing:"–§–æ—Ç–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–º–µ–Ω—ã: —É–¥–∞–ª–µ–Ω–æ –ø–æ –ø–æ–ª–∏—Ç–∏–∫–µ —Ö—Ä–∞–Ω–µ–Ω–∏—è (3 –¥–Ω—è).",photoEndNotClosed:"–§–æ—Ç–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–º–µ–Ω—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (—Å–º–µ–Ω–∞ –µ—â—ë –Ω–µ –∑–∞–∫—Ä—ã—Ç–∞).",photoEndAutoClosed:"–§–æ—Ç–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–º–µ–Ω—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (—Å–º–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã—Ç–∞).",shiftNotFound:"–°–º–µ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.",helpAdmin:"–ü–æ–º–æ—â—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:\n/employees ‚Äî –æ—Ç—á—ë—Ç –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É\n/report ‚Äî –æ–±—â–∏–π –æ—Ç—á—ë—Ç\n/mode ‚Äî —Ä–µ–∂–∏–º (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)\n/whoami ‚Äî –≤–∞—à–∏ ID",helpEmployee:"–ü–æ–º–æ—â—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:\n–§–æ—Ç–æ ‚Äî –∑–∞–ø—Ä–æ—Å–∏—Ç—å –Ω–∞—á–∞–ª–æ/–∑–∞–∫—Ä—ã—Ç–∏–µ (–Ω—É–∂–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å)\n/status ‚Äî —Å—Ç–∞—Ç—É—Å —Å–º–µ–Ω—ã\n/fullname ‚Äî –∏–∑–º–µ–Ω–∏—Ç—å –∏–º—è\n/whoami ‚Äî –≤–∞—à–∏ ID",helpBoth:"–ü–æ–º–æ—â—å:\n/mode ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º\n/employees ‚Äî –æ—Ç—á—ë—Ç –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É\n/report ‚Äî –æ–±—â–∏–π –æ—Ç—á—ë—Ç\n/status ‚Äî —Å—Ç–∞—Ç—É—Å —Å–º–µ–Ω—ã (—Å–æ—Ç—Ä—É–¥–Ω–∏–∫)\n/fullname ‚Äî –∏–∑–º–µ–Ω–∏—Ç—å –∏–º—è\n–§–æ—Ç–æ ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–º–µ–Ω—ã",modePrompt:"–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º:",modeSetAdmin:"–†–µ–∂–∏–º: –ê–¥–º–∏–Ω.",modeSetEmployee:"–†–µ–∂–∏–º: –°–æ—Ç—Ä—É–¥–Ω–∏–∫.",modeUnavailable:"–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ."}},2942:(e,t,a)=>{a.d(t,{O:()=>o}),a(4243);var i=a(7012);let n=i.Ry({TELEGRAM_BOT_TOKEN:i.Z_().min(1),TELEGRAM_BOSS_CHAT_ID:i.Z_().min(1),ADMIN_USER_IDS:i.Z_().optional(),DATABASE_URL:i.Z_().min(1),WEBHOOK_SECRET:i.Z_().min(1),INTERNAL_SECRET:i.Z_().min(1),PUBLIC_BASE_URL:i.Z_().min(1),TELEGRAM_WEBHOOK_SECRET_TOKEN:i.Z_().optional(),TIMEZONE:i.Z_().default("Asia/Bishkek"),MAX_SHIFT_HOURS:i.oQ.number().int().positive().default(12),MIN_SHIFT_HOURS:i.oQ.number().int().positive().default(8),SHORT_SHIFT_GRACE_MINUTES:i.oQ.number().int().min(0).default(0),PENDING_ACTION_TTL_MINUTES:i.oQ.number().int().positive().default(10),PENDING_ACTION_CLEANUP_CRON:i.Z_().default("*/2 * * * *"),PHOTO_RETENTION_DAYS:i.oQ.number().int().positive().default(3),PHOTO_RETENTION_CRON:i.Z_().default("0 * * * *"),OVERDUE_CHECK_CRON:i.Z_().default("*/5 * * * *"),TICK_MAX_AUTOCLOSE:i.oQ.number().int().positive().default(50),TICK_MAX_EXPIRE_PENDING:i.oQ.number().int().positive().default(200),NOTIFY_EMPLOYEE_ON_AUTOCLOSE:i.oQ.boolean().default(!0),LOG_LEVEL:i.Z_().default("info"),NODE_ENV:i.Z_().optional()}).safeParse(process.env);if(!n.success){let e=n.error.format();throw Error(`Invalid environment configuration: ${JSON.stringify(e)}`)}let o={telegramBotToken:n.data.TELEGRAM_BOT_TOKEN,telegramBossChatId:n.data.TELEGRAM_BOSS_CHAT_ID,adminUserIds:(n.data.ADMIN_USER_IDS??"").split(",").map(e=>e.trim()).filter(Boolean),databaseUrl:n.data.DATABASE_URL,webhookSecret:n.data.WEBHOOK_SECRET,internalSecret:n.data.INTERNAL_SECRET,publicBaseUrl:n.data.PUBLIC_BASE_URL,telegramWebhookSecretToken:n.data.TELEGRAM_WEBHOOK_SECRET_TOKEN??null,timezone:n.data.TIMEZONE,maxShiftHours:n.data.MAX_SHIFT_HOURS,minShiftHours:n.data.MIN_SHIFT_HOURS,shortShiftGraceMinutes:n.data.SHORT_SHIFT_GRACE_MINUTES,pendingActionTtlMinutes:n.data.PENDING_ACTION_TTL_MINUTES,pendingActionCleanupCron:n.data.PENDING_ACTION_CLEANUP_CRON,photoRetentionDays:n.data.PHOTO_RETENTION_DAYS,photoRetentionCron:n.data.PHOTO_RETENTION_CRON,overdueCheckCron:n.data.OVERDUE_CHECK_CRON,tickMaxAutoclose:n.data.TICK_MAX_AUTOCLOSE,tickMaxExpirePending:n.data.TICK_MAX_EXPIRE_PENDING,notifyEmployeeOnAutoClose:n.data.NOTIFY_EMPLOYEE_ON_AUTOCLOSE,logLevel:n.data.LOG_LEVEL,nodeEnv:n.data.NODE_ENV}},8361:(e,t,a)=>{a.d(t,{k:()=>s});var i=a(4062),n=a.n(i),o=a(2942);let s=n()({level:o.O.logLevel,base:{service:"telegram-shift-bot"}})},1830:(e,t,a)=>{a.d(t,{M:()=>ev});var i=a(3524);let n=globalThis.prisma??new i.PrismaClient;var o=a(2942),s=a(8361);let r=e=>{let t=[e.firstName,e.lastName].filter(Boolean);return t.length>0?t.join(" "):e.username?`@${e.username}`:`user:${e.id}`},l=e=>!e||0===e.trim().length;class d{async upsertFromTelegram(e){let t=String(e.id),a=r(e),i=await n.employee.findUnique({where:{telegramUserId:t}});if(!i)return n.employee.create({data:{telegramUserId:t,username:e.username??null,firstName:e.firstName??null,lastName:e.lastName??null,displayName:a}});let o={username:e.username??null};return l(i.firstName)&&e.firstName&&(o.firstName=e.firstName),l(i.lastName)&&e.lastName&&(o.lastName=e.lastName),l(i.displayName)&&(o.displayName=a),n.employee.update({where:{telegramUserId:t},data:o})}async findByTelegramUserId(e){return n.employee.findUnique({where:{telegramUserId:e}})}async findById(e){return n.employee.findUnique({where:{id:e}})}async findByIds(e){return 0===e.length?[]:n.employee.findMany({where:{id:{in:e}}})}async listEmployees(e){let t=Math.max(1,e.page),a=Math.min(20,Math.max(1,e.pageSize)),i=e.query?.trim(),o=i?{OR:[{displayName:{contains:i,mode:"insensitive"}},{username:{contains:i,mode:"insensitive"}},{firstName:{contains:i,mode:"insensitive"}},{lastName:{contains:i,mode:"insensitive"}},{telegramUserId:{contains:i,mode:"insensitive"}}]}:{},[s,r]=await n.$transaction([n.employee.count({where:o}),n.employee.findMany({where:o,orderBy:{displayName:"asc"},skip:(t-1)*a,take:a})]);return{total:s,items:r}}async updateNameByTelegramUserId(e,t){return 0===(await n.employee.updateMany({where:{telegramUserId:e},data:{firstName:t.firstName,lastName:t.lastName,displayName:t.displayName}})).count?null:n.employee.findUnique({where:{telegramUserId:e}})}}class p{async findOpenShift(e,t){return(t??n).shift.findFirst({where:{employeeId:e,endTime:null},orderBy:{startTime:"desc"}})}async findLastShift(e){return n.shift.findFirst({where:{employeeId:e},orderBy:{startTime:"desc"}})}async isMessageProcessed(e,t){return!!await n.shift.findFirst({where:{OR:[{startChatId:e,startMessageId:t},{endChatId:e,endMessageId:t}]},select:{id:!0}})}async createShiftStart(e,t){return(t??n).shift.create({data:{employeeId:e.employeeId,startTime:e.startTime,startPhotoFileId:e.startPhotoFileId,startMessageId:e.startMessageId,startChatId:e.startChatId,employeeChatId:e.startChatId}})}async closeShiftByUserPhoto(e,t){return(t??n).shift.update({where:{id:e.shiftId},data:{endTime:e.endTime,endPhotoFileId:e.endPhotoFileId,endMessageId:e.endMessageId,endChatId:e.endChatId,closedReason:i.ClosedReason.USER_PHOTO,durationMinutes:e.durationMinutes}})}async createViolation(e,t,a){await (a??n).shiftViolation.createMany({data:[{shiftId:e,type:t}],skipDuplicates:!0})}async findOverdueShifts(e,t){return n.shift.findMany({where:{endTime:null,alertedAt:null,startTime:{lte:e}},include:{employee:!0,violations:!0},orderBy:{startTime:"asc"},take:t})}async autoCloseShift(e,t,a,o,s){return s?0===(await s.shift.updateMany({where:{id:e,endTime:null,alertedAt:null},data:{endTime:t,closedReason:i.ClosedReason.AUTO_TIMEOUT,durationMinutes:a,autoClosedAt:o,alertedAt:o}})).count?null:(await s.shiftViolation.createMany({data:[{shiftId:e,type:i.ViolationType.NOT_CLOSED_IN_TIME}],skipDuplicates:!0}),s.shift.findUnique({where:{id:e},include:{employee:!0,violations:!0}})):n.$transaction(async n=>0===(await n.shift.updateMany({where:{id:e,endTime:null,alertedAt:null},data:{endTime:t,closedReason:i.ClosedReason.AUTO_TIMEOUT,durationMinutes:a,autoClosedAt:o,alertedAt:o}})).count?null:(await n.shiftViolation.createMany({data:[{shiftId:e,type:i.ViolationType.NOT_CLOSED_IN_TIME}],skipDuplicates:!0}),n.shift.findUnique({where:{id:e},include:{employee:!0,violations:!0}})))}async findShiftsInRange(e,t,a){return n.shift.findMany({where:{startTime:{gte:e,lte:t}},include:{employee:!0,violations:!0},orderBy:[{employeeId:"asc"},{startTime:a?.order??"asc"}],take:a?.limit})}async findEmployeeShiftsInRange(e,t,a,i){return n.shift.findMany({where:{employeeId:e,startTime:{gte:t,lte:a}},include:{employee:!0,violations:!0},orderBy:{startTime:"desc"},take:i})}async findShiftById(e){return n.shift.findUnique({where:{id:e},include:{employee:!0,violations:!0}})}async purgeOldPhotos(e,t,a){if(!a)return(await n.shift.updateMany({where:{startTime:{lt:e},photosPurgedAt:null},data:{startPhotoFileId:null,endPhotoFileId:null,photosPurgedAt:t}})).count;let i=await n.shift.findMany({where:{startTime:{lt:e},photosPurgedAt:null},select:{id:!0},orderBy:{startTime:"asc"},take:a});if(0===i.length)return 0;let o=i.map(e=>e.id);return(await n.shift.updateMany({where:{id:{in:o},photosPurgedAt:null},data:{startPhotoFileId:null,endPhotoFileId:null,photosPurgedAt:t}})).count}async aggregateEmployeeStats(e,t,a){let i=await n.shift.aggregate({where:{employeeId:e,startTime:{gte:t,lte:a}},_count:{_all:!0},_sum:{durationMinutes:!0},_avg:{durationMinutes:!0}});return{totalShifts:i._count._all,totalDurationMinutes:i._sum.durationMinutes??0,averageDurationMinutes:Math.round(i._avg.durationMinutes??0)}}async countEmployeeViolations(e,t,a){return n.shiftViolation.count({where:{shift:{employeeId:e,startTime:{gte:t,lte:a}},type:{not:i.ViolationType.SHORT_SHIFT}}})}async countEmployeeViolationsByType(e,t,a){let o=await n.shiftViolation.groupBy({by:["type"],where:{shift:{employeeId:e,startTime:{gte:t,lte:a}},type:{not:i.ViolationType.SHORT_SHIFT}},_count:{_all:!0}}),s=0,r=0;for(let e of o)r+=e._count._all,e.type===i.ViolationType.NOT_CLOSED_IN_TIME&&(s=e._count._all);return{notClosedInTime:s,shortShift:0,total:r}}async groupByEmployeeStats(e,t){return(await n.shift.groupBy({by:["employeeId"],where:{startTime:{gte:e,lte:t}},_count:{_all:!0},_sum:{durationMinutes:!0},_avg:{durationMinutes:!0}})).map(e=>({employeeId:e.employeeId,totalShifts:e._count._all,totalDurationMinutes:e._sum.durationMinutes??0,averageDurationMinutes:Math.round(e._avg.durationMinutes??0)}))}async countViolationsByEmployee(e,t){return await n.$queryRaw`
      SELECT s."employeeId" AS "employeeId",
             COUNT(v.*)::int AS "violations"
      FROM "Shift" s
      JOIN "ShiftViolation" v ON v."shiftId" = s."id"
      WHERE s."startTime" >= ${e}
        AND s."startTime" <= ${t}
        AND v."type" <> 'SHORT_SHIFT'
      GROUP BY s."employeeId"
    `}async countViolationsByEmployeeAndType(e,t){return await n.$queryRaw`
      SELECT s."employeeId" AS "employeeId",
             v."type" AS "type",
             COUNT(v.*)::int AS "count"
      FROM "Shift" s
      JOIN "ShiftViolation" v ON v."shiftId" = s."id"
      WHERE s."startTime" >= ${e}
        AND s."startTime" <= ${t}
        AND v."type" <> 'SHORT_SHIFT'
      GROUP BY s."employeeId", v."type"
    `}async findLastShiftsByEmployee(e,t){return await n.$queryRaw`
      SELECT DISTINCT ON (s."employeeId")
        s."employeeId" AS "employeeId",
        s."startTime" AS "startTime",
        s."endTime" AS "endTime",
        s."closedReason" AS "closedReason"
      FROM "Shift" s
      WHERE s."startTime" >= ${e}
        AND s."startTime" <= ${t}
      ORDER BY s."employeeId", s."startTime" DESC
    `}}class m{async isAdminUserId(e){return!!await n.admin.findUnique({where:{telegramUserId:e},select:{id:!0}})}async countAdmins(){return n.admin.count()}async addAdminUserId(e){await n.admin.upsert({where:{telegramUserId:e},create:{telegramUserId:e},update:{}})}async getAdminUserIds(){return(await n.admin.findMany({select:{telegramUserId:!0}})).map(e=>e.telegramUserId)}}class u{async getSession(e){return n.userSession.findUnique({where:{telegramUserId:e},select:{telegramUserId:!0,mode:!0,nameRequestedAt:!0,fullNameRequestedAt:!0}})}async setSession(e,t){await n.userSession.upsert({where:{telegramUserId:e},create:{telegramUserId:e,mode:t},update:{mode:t}})}async setNameRequestedAt(e,t=new Date){await n.userSession.upsert({where:{telegramUserId:e},create:{telegramUserId:e,mode:i.UserMode.EMPLOYEE,nameRequestedAt:t},update:{nameRequestedAt:t}})}async clearNameRequestedAt(e){await n.userSession.updateMany({where:{telegramUserId:e},data:{nameRequestedAt:null}})}async setFullNameRequestedAt(e,t=new Date){await n.userSession.upsert({where:{telegramUserId:e},create:{telegramUserId:e,mode:i.UserMode.EMPLOYEE,fullNameRequestedAt:t},update:{fullNameRequestedAt:t}})}async clearFullNameRequestedAt(e){await n.userSession.updateMany({where:{telegramUserId:e},data:{fullNameRequestedAt:null}})}}class y{async findById(e,t){return(t??n).pendingAction.findUnique({where:{id:e}})}async findByChatMessage(e,t,a){return(a??n).pendingAction.findUnique({where:{chatId_photoMessageId:{chatId:e,photoMessageId:t}}})}async hasActiveForUser(e,t){return!!await n.pendingAction.findFirst({where:{telegramUserId:e,status:i.PendingActionStatus.PENDING,expiresAt:{gt:t}},select:{id:!0}})}async createPendingAction(e,t){return(t??n).pendingAction.create({data:{employeeId:e.employeeId,telegramUserId:e.telegramUserId,chatId:e.chatId,actionType:e.actionType,photoFileId:e.photoFileId,photoMessageId:e.photoMessageId,createdAt:e.createdAt,expiresAt:e.expiresAt}})}async updateStatus(e,t,a,i){let o=i??n;return 0===(await o.pendingAction.updateMany({where:{id:e},data:{status:t,updatedAt:a}})).count?null:o.pendingAction.findUnique({where:{id:e}})}async updateStatusIfPending(e,t,a,o){return(await (o??n).pendingAction.updateMany({where:{id:e,status:i.PendingActionStatus.PENDING,expiresAt:{gt:t}},data:{status:a,updatedAt:t}})).count}async expirePendingActions(e,t){if(!t)return(await n.pendingAction.updateMany({where:{status:i.PendingActionStatus.PENDING,expiresAt:{lte:e}},data:{status:i.PendingActionStatus.EXPIRED,updatedAt:e}})).count;let a=await n.pendingAction.findMany({where:{status:i.PendingActionStatus.PENDING,expiresAt:{lte:e}},select:{id:!0},orderBy:{expiresAt:"asc"},take:t});if(0===a.length)return 0;let o=a.map(e=>e.id);return(await n.pendingAction.updateMany({where:{id:{in:o},status:i.PendingActionStatus.PENDING},data:{status:i.PendingActionStatus.EXPIRED,updatedAt:e}})).count}}class c{constructor(e,t,a,i){this.employeeRepo=e,this.shiftRepo=t,this.config=a,this.logger=i}async handlePhotoMessage(e){let t=String(e.chatId);if(await this.shiftRepo.isMessageProcessed(t,e.messageId))return this.logger.info({chatId:t,messageId:e.messageId},"Duplicate message ignored"),{type:"duplicate"};let a=await this.employeeRepo.upsertFromTelegram(e.user),i=await this.shiftRepo.findOpenShift(a.id);if(!i)return{type:"started",shift:await this.shiftRepo.createShiftStart({employeeId:a.id,startTime:e.messageDate,startPhotoFileId:e.fileId,startMessageId:e.messageId,startChatId:t}),employee:a};let n=36e5*this.config.maxShiftHours,o=i.startTime.getTime()+n;if(e.messageDate.getTime()>=o){let n=new Date(o),s=60*this.config.maxShiftHours,r=await this.shiftRepo.autoCloseShift(i.id,n,s,e.messageDate),l=await this.shiftRepo.createShiftStart({employeeId:a.id,startTime:e.messageDate,startPhotoFileId:e.fileId,startMessageId:e.messageId,startChatId:t});return r?{type:"autoClosedAndStarted",autoClose:{shift:r,endTime:n,durationMinutes:s},startedShift:l,employee:a}:{type:"started",shift:l,employee:a}}let s=Math.max(0,Math.round((e.messageDate.getTime()-i.startTime.getTime())/6e4));return{type:"closed",shift:await this.shiftRepo.closeShiftByUserPhoto({shiftId:i.id,endTime:e.messageDate,endPhotoFileId:e.fileId,endMessageId:e.messageId,endChatId:t,durationMinutes:s}),employee:a,durationMinutes:s}}async getOpenShiftStatus(e){let t=await this.employeeRepo.findByTelegramUserId(e);return t?this.shiftRepo.findOpenShift(t.id):null}async autoCloseOverdueShifts(e=new Date,t){let a=36e5*this.config.maxShiftHours,i=new Date(e.getTime()-a),n=await this.shiftRepo.findOverdueShifts(i,t),o=[];for(let t of n){let i=new Date(t.startTime.getTime()+a),n=60*this.config.maxShiftHours,s=await this.shiftRepo.autoCloseShift(t.id,i,n,e);s&&o.push({shift:s,endTime:i,durationMinutes:n})}return o}}class h{constructor(e,t){this.shiftRepo=e,this.employeeRepo=t}buildRange(e,t=new Date){return{from:new Date(t.getTime()-864e5*e),to:t,days:e}}async getEmployeeReport(e,t,a=new Date){let n=this.buildRange(t,a),o=await this.employeeRepo.findById(e);if(!o)return null;let s=await this.shiftRepo.aggregateEmployeeStats(e,n.from,n.to),r=await this.shiftRepo.countEmployeeViolationsByType(e,n.from,n.to),l=(await this.shiftRepo.findEmployeeShiftsInRange(e,n.from,n.to,10)).map(e=>({startTime:e.startTime,endTime:e.endTime,durationMinutes:e.durationMinutes,closedReason:e.closedReason,violations:e.violations.map(e=>e.type).filter(e=>e!==i.ViolationType.SHORT_SHIFT)}));return{employeeId:o.id,telegramUserId:o.telegramUserId,displayName:o.displayName,period:n,totalShifts:s.totalShifts,totalDurationMinutes:s.totalDurationMinutes,averageDurationMinutes:s.averageDurationMinutes,violationsNotClosedInTime:r.notClosedInTime,violationsShortShift:0,violationsTotal:r.total,shifts:l}}async getAllEmployeesReport(e,t=new Date){let a=this.buildRange(e,t),n=await this.shiftRepo.groupByEmployeeStats(a.from,a.to),o=await this.shiftRepo.countViolationsByEmployeeAndType(a.from,a.to),s=await this.shiftRepo.findLastShiftsByEmployee(a.from,a.to),r=await this.employeeRepo.findByIds(n.map(e=>e.employeeId)),l=new Map;for(let e of r)l.set(e.id,{telegramUserId:e.telegramUserId,displayName:e.displayName});let d=new Map;for(let e of o){if(e.type===i.ViolationType.SHORT_SHIFT)continue;let t=d.get(e.employeeId)??{notClosedInTime:0,shortShift:0,total:0};e.type===i.ViolationType.NOT_CLOSED_IN_TIME&&(t.notClosedInTime=e.count),t.total+=e.count,d.set(e.employeeId,t)}let p=new Map;for(let e of s)p.set(e.employeeId,{startTime:e.startTime,endTime:e.endTime,closedReason:e.closedReason});let m=n.map(e=>{let t=l.get(e.employeeId)??{telegramUserId:String(e.employeeId),displayName:`user:${e.employeeId}`},a=p.get(e.employeeId),i=d.get(e.employeeId)??{notClosedInTime:0,shortShift:0,total:0};return{employeeId:e.employeeId,telegramUserId:t.telegramUserId,displayName:t.displayName,totalShifts:e.totalShifts,totalDurationMinutes:e.totalDurationMinutes,averageDurationMinutes:e.averageDurationMinutes,violationsNotClosedInTime:i.notClosedInTime,violationsShortShift:0,violationsTotal:i.total,lastShiftStart:a?.startTime??null,lastShiftEnd:a?.endTime??null,lastShiftClosedReason:a?.closedReason??null}});m.sort((e,t)=>e.displayName.localeCompare(t.displayName,"ru"));let u=[...m].sort((e,t)=>t.violationsTotal!==e.violationsTotal?t.violationsTotal-e.violationsTotal:t.totalDurationMinutes-e.totalDurationMinutes),y=m.length,c=m.reduce((e,t)=>e+t.totalShifts,0),h=m.reduce((e,t)=>e+t.totalDurationMinutes,0);return{period:a,totalEmployees:y,totalShifts:c,totalDurationMinutes:h,violationsNotClosedInTime:m.reduce((e,t)=>e+t.violationsNotClosedInTime,0),violationsShortShift:m.reduce((e,t)=>e+t.violationsShortShift,0),totalViolations:m.reduce((e,t)=>e+t.violationsTotal,0),employees:m,topEmployees:u.slice(0,10)}}async getEmployeeShiftsForExport(e,t,a=new Date){let n=this.buildRange(t,a);return(await this.shiftRepo.findEmployeeShiftsInRange(e,n.from,n.to,1e4)).map(e=>({startTime:e.startTime,endTime:e.endTime,durationMinutes:e.durationMinutes,closedReason:e.closedReason,violations:e.violations.map(e=>e.type).filter(e=>e!==i.ViolationType.SHORT_SHIFT)}))}async getRawShiftsForExport(e,t=new Date,a=5e3){let n=this.buildRange(e,t),o=await this.shiftRepo.findShiftsInRange(n.from,n.to,{limit:a,order:"asc"});return{period:n,shifts:o.map(e=>({employeeId:e.employeeId,telegramUserId:e.employee.telegramUserId,displayName:e.employee.displayName,startTime:e.startTime,endTime:e.endTime,durationMinutes:e.durationMinutes,closedReason:e.closedReason,violations:e.violations.map(e=>e.type).filter(e=>e!==i.ViolationType.SHORT_SHIFT)}))}}}class f{constructor(e){this.adminRepo=e}async isAdmin(e){return!!o.O.adminUserIds.includes(e)||this.adminRepo.isAdminUserId(e)}async canAssignAdmin(e){return!(await this.adminRepo.countAdmins()>0)&&!(o.O.adminUserIds.length>0)||this.isAdmin(e)}async addAdmin(e){await this.adminRepo.addAdminUserId(e)}async getAdminChatIds(){let e=await this.adminRepo.getAdminUserIds();return Array.from(new Set([o.O.telegramBossChatId,...o.O.adminUserIds,...e]))}}class g{constructor(e,t,a){this.adminService=e,this.employeeRepo=t,this.sessionRepo=a}async resolveRole(e){let t;let a=i.EmployeeRoleOverride||{DEFAULT:"DEFAULT",FORCE_EMPLOYEE:"FORCE_EMPLOYEE",FORCE_ADMIN:"FORCE_ADMIN",BOTH:"BOTH"},n=i.UserMode||{ADMIN:"ADMIN",EMPLOYEE:"EMPLOYEE"},o=await this.adminService.isAdmin(e),s=await this.employeeRepo.findByTelegramUserId(e),r=s?.roleOverride??a.DEFAULT,l=s?.isActive??!1,d=!1;o?(r===a.BOTH||r===a.FORCE_EMPLOYEE)&&(d=l):d=!s||l,r===a.FORCE_ADMIN&&(d=!1);let p=o&&d&&r===a.BOTH;if(p){let a=await this.sessionRepo.getSession(e);t=a?.mode??n.ADMIN}else t=o?n.ADMIN:n.EMPLOYEE;return r===a.FORCE_EMPLOYEE&&d&&(t=n.EMPLOYEE),{userId:e,isAdmin:o,isEmployee:d,isBoth:p,mode:t,employee:s,roleOverride:r}}async setMode(e,t){await this.sessionRepo.setSession(e,t)}shouldProcessPhoto(e){let t=i.UserMode||{ADMIN:"ADMIN",EMPLOYEE:"EMPLOYEE"};return e.isEmployee&&e.mode===t.EMPLOYEE}}var I=a(6751);let w=e=>{if(null==e)return"";let t=String(e);return t.includes("\n")||t.includes(",")||t.includes('"')?`"${t.replace(/"/g,'""')}"`:t},S=e=>e===i.ClosedReason.AUTO_TIMEOUT?"AUTO_TIMEOUT":e===i.ClosedReason.USER_PHOTO?"USER_PHOTO":"",T=e=>e.filter(e=>e!==i.ViolationType.SHORT_SHIFT),E=e=>{let t=0,a=0;for(let n of T(e))a+=1,n===i.ViolationType.NOT_CLOSED_IN_TIME&&(t+=1);return{notClosedInTime:t,total:a}};class _{buildEmployeeReportCsv(e,t){let a=[["employeeId","telegramUserId","displayName","startTime","endTime","durationMinutes","closedReason","notClosedInTimeViolationsCount","totalViolationsCount","violations"],...e.shifts.map(a=>{let i=T(a.violations),n=E(i);return[e.employeeId,e.telegramUserId,e.displayName,(0,I.o0)(a.startTime,t),a.endTime?(0,I.o0)(a.endTime,t):"",a.durationMinutes??"",S(a.closedReason),n.notClosedInTime,n.total,i.join(",")]})].map(e=>e.map(w).join(",")).join("\n");return{filename:`report_${(0,I.TW)(e.period.from,t)}_to_${(0,I.TW)(e.period.to,t)}.csv`,content:Buffer.from(a,"utf-8")}}buildAllEmployeesSummaryCsv(e,t,a){let i=[["employeeId","telegramUserId","displayName","shiftsCount","totalMinutes","avgShiftMinutes","notClosedInTimeViolationsCount","totalViolationsCount","lastShiftStart","lastShiftEnd","lastShiftClosedReason"],...t.map(e=>[e.employeeId,e.telegramUserId,e.displayName,e.totalShifts,e.totalDurationMinutes,e.averageDurationMinutes,e.violationsNotClosedInTime,e.violationsTotal,e.lastShiftStart?(0,I.o0)(e.lastShiftStart,a):"",e.lastShiftEnd?(0,I.o0)(e.lastShiftEnd,a):"",S(e.lastShiftClosedReason??null)])].map(e=>e.map(w).join(",")).join("\n");return{filename:`report_${(0,I.TW)(e.from,a)}_to_${(0,I.TW)(e.to,a)}.csv`,content:Buffer.from(i,"utf-8")}}buildRawShiftsCsv(e,t,a){let i=[["employeeId","telegramUserId","displayName","startTime","endTime","durationMinutes","closedReason","notClosedInTimeViolationsCount","totalViolationsCount","violations"],...t.map(e=>{let t=T(e.violations),i=E(t);return[e.employeeId,e.telegramUserId,e.displayName,(0,I.o0)(e.startTime,a),e.endTime?(0,I.o0)(e.endTime,a):"",e.durationMinutes??"",S(e.closedReason),i.notClosedInTime,i.total,t.join(",")]})].map(e=>e.map(w).join(",")).join("\n");return{filename:`report_raw_${(0,I.TW)(e.from,a)}_to_${(0,I.TW)(e.to,a)}.csv`,content:Buffer.from(i,"utf-8")}}}class M{constructor(e,t,a,i,n){this.employeeRepo=e,this.shiftRepo=t,this.pendingRepo=a,this.config=i,this.runInTransaction=n}async createFromPhoto(e){let t=String(e.chatId);if(await this.shiftRepo.isMessageProcessed(t,e.messageId)||await this.pendingRepo.findByChatMessage(t,e.messageId))return{type:"duplicate"};let a=await this.employeeRepo.upsertFromTelegram(e.user),n=await this.shiftRepo.findOpenShift(a.id),o=36e5*this.config.maxShiftHours,s=!!n&&e.messageDate.getTime()>=n.startTime.getTime()+o,r=!n||s?i.PendingActionType.START:i.PendingActionType.END,l=e.messageDate,d=new Date(l.getTime()+6e4*this.config.ttlMinutes);return{type:"pending",pendingAction:await this.pendingRepo.createPendingAction({employeeId:a.id,telegramUserId:a.telegramUserId,chatId:t,actionType:r,photoFileId:e.fileId,photoMessageId:e.messageId,createdAt:l,expiresAt:d}),actionType:r,employee:a}}async confirmAction(e,t,a=new Date){return this.runInTransaction(async n=>{let o=await this.pendingRepo.findById(e,n);if(!o)return{type:"not_found"};if(o.telegramUserId!==t)return{type:"forbidden"};if(o.status!==i.PendingActionStatus.PENDING)return{type:"already_handled",status:o.status};if(o.expiresAt<=a)return await this.pendingRepo.updateStatus(o.id,i.PendingActionStatus.EXPIRED,a,n),{type:"expired"};if(0===await this.pendingRepo.updateStatusIfPending(o.id,a,i.PendingActionStatus.CONFIRMED,n)){let e=await this.pendingRepo.findById(o.id,n);return e&&e.status===i.PendingActionStatus.PENDING&&e.expiresAt<=a?(await this.pendingRepo.updateStatus(e.id,i.PendingActionStatus.EXPIRED,a,n),{type:"expired"}):e?{type:"already_handled",status:e.status}:{type:"not_found"}}let s=await this.employeeRepo.findById(o.employeeId);if(!s)return await this.pendingRepo.updateStatus(o.id,i.PendingActionStatus.CANCELLED,a,n),{type:"not_found"};let r=o.createdAt,l=36e5*this.config.maxShiftHours;if(o.actionType===i.PendingActionType.START){let e=await this.shiftRepo.findOpenShift(s.id,n),t=null;if(e){if(!(r.getTime()>=e.startTime.getTime()+l))return await this.pendingRepo.updateStatus(o.id,i.PendingActionStatus.CANCELLED,a,n),{type:"open_shift_exists"};let s=new Date(e.startTime.getTime()+l),d=60*this.config.maxShiftHours;if(!(t=await this.shiftRepo.autoCloseShift(e.id,s,d,a,n)))return await this.pendingRepo.updateStatus(o.id,i.PendingActionStatus.CANCELLED,a,n),{type:"open_shift_exists"}}return{type:"confirmed_start",shift:await this.shiftRepo.createShiftStart({employeeId:s.id,startTime:r,startPhotoFileId:o.photoFileId,startMessageId:o.photoMessageId,startChatId:o.chatId},n),employee:s,autoClose:t}}let d=await this.shiftRepo.findOpenShift(s.id,n);if(!d)return await this.pendingRepo.updateStatus(o.id,i.PendingActionStatus.CANCELLED,a,n),{type:"no_open_shift"};if(r.getTime()>=d.startTime.getTime()+l){let e=new Date(d.startTime.getTime()+l),t=60*this.config.maxShiftHours,s=await this.shiftRepo.autoCloseShift(d.id,e,t,a,n);return s?{type:"auto_closed",autoClose:s}:(await this.pendingRepo.updateStatus(o.id,i.PendingActionStatus.CANCELLED,a,n),{type:"no_open_shift"})}let p=Math.max(0,Math.round((r.getTime()-d.startTime.getTime())/6e4));return{type:"confirmed_end",shift:await this.shiftRepo.closeShiftByUserPhoto({shiftId:d.id,endTime:r,endPhotoFileId:o.photoFileId,endMessageId:o.photoMessageId,endChatId:o.chatId,durationMinutes:p},n),employee:s,durationMinutes:p}})}async cancelAction(e,t,a=new Date){return this.runInTransaction(async n=>{let o=await this.pendingRepo.findById(e,n);if(!o)return{type:"not_found"};if(o.telegramUserId!==t)return{type:"forbidden"};if(o.status!==i.PendingActionStatus.PENDING)return{type:"already_handled",status:o.status};if(o.expiresAt<=a)return await this.pendingRepo.updateStatus(o.id,i.PendingActionStatus.EXPIRED,a,n),{type:"expired"};if(0===await this.pendingRepo.updateStatusIfPending(o.id,a,i.PendingActionStatus.CANCELLED,n)){let e=await this.pendingRepo.findById(o.id,n);return e&&e.status===i.PendingActionStatus.PENDING&&e.expiresAt<=a?(await this.pendingRepo.updateStatus(e.id,i.PendingActionStatus.EXPIRED,a,n),{type:"expired"}):e?{type:"already_handled",status:e.status}:{type:"not_found"}}return{type:"cancelled"}})}async expirePendingActions(e=new Date,t){return this.pendingRepo.expirePendingActions(e,t)}async hasActivePendingAction(e,t=new Date){return this.pendingRepo.hasActiveForUser(e,t)}}var A=a(3555),R=a.n(A),N=a(4799),O=a.n(N),C=a(8466),b=a.n(C);R().extend(O()),R().extend(b());class D{constructor(e){this.shiftRepo=e}buildRange(e,t,a=new Date){let i=R()(a).tz(t);if("today"===e)return{key:e,from:i.startOf("day").toDate(),to:a,label:"–°–µ–≥–æ–¥–Ω—è"};if("yesterday"===e){let t=i.subtract(1,"day").startOf("day"),a=i.startOf("day");return{key:e,from:t.toDate(),to:a.toDate(),label:"–í—á–µ—Ä–∞"}}return{key:e,from:i.subtract(3,"day").toDate(),to:a,label:"–ü–æ—Å–ª–µ–¥–Ω–∏–µ 3 –¥–Ω—è"}}async listEmployeeShifts(e,t,a){return(await this.shiftRepo.findEmployeeShiftsInRange(e,t.from,t.to,a)).map(e=>({id:e.id,startTime:e.startTime,endTime:e.endTime,closedReason:e.closedReason,violations:e.violations.map(e=>e.type)}))}async getShiftDetails(e){return this.shiftRepo.findShiftById(e)}}var v=a(2161),P=a(3406);let U=v.Markup.keyboard([["–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏","–û—Ç—á—ë—Ç"],["–ü–æ–º–æ—â—å"]]).resize(),$=v.Markup.keyboard([["–°—Ç–∞—Ç—É—Å"],["–ü–æ–º–æ—â—å"]]).resize(),k=v.Markup.keyboard([["–†–µ–∂–∏–º: –ê–¥–º–∏–Ω","–†–µ–∂–∏–º: –°–æ—Ç—Ä—É–¥–Ω–∏–∫"]]).resize(),F=v.Markup.inlineKeyboard([[v.Markup.button.callback("–ê–¥–º–∏–Ω —Ä–µ–∂–∏–º","mode:ADMIN"),v.Markup.button.callback("–†–µ–∂–∏–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞","mode:EMPLOYEE")]]),B=/^[\p{Script=Latin}\p{Script=Cyrillic}]+(?:-[\p{Script=Latin}\p{Script=Cyrillic}]+)*$/u,H=e=>!e||0===e.trim().length,x=e=>{if(!e)return!1;let t=e.trim();if(0===t.length)return!1;let a=t.split(/\s+/);return!(a.length<2)&&a.every(e=>B.test(e))},L=e=>{let t=e.trim().replace(/\s+/g," ");if(0===t.length)return null;let a=t.split(" ");if(a.length<2||!a.every(e=>B.test(e)))return null;let[i,...n]=a,o=n.join(" "),s=`${i} ${o}`;return{firstName:i,lastName:o,displayName:s}},q=e=>!!e&&(!(H(e.firstName)||H(e.lastName))||x(e.displayName)),Q=(e,t,a,i)=>{e.start(async e=>{let n=e.from;if(!n)return;let o=String(n.id),s=await t.resolveRole(o);if(s.isBoth){await e.reply(P.s.startBoth,k);return}if("ADMIN"===s.mode){await e.reply(P.s.startAdmin,U);return}let r=e.chat?.id??n.id;if(!q(await a.upsertFromTelegram({id:n.id,username:n.username,firstName:n.first_name,lastName:n.last_name,chatId:r}))){await e.reply(P.s.namePrompt),await i.setNameRequestedAt(o);return}await i.clearNameRequestedAt(o),await e.reply(P.s.startEmployee,$)})},V=(e,t,a)=>{let i=async(e,i)=>{let n=await a.resolveRole(e);if(!n.isEmployee||"EMPLOYEE"!==n.mode){await i(P.s.notEmployee);return}let s=await t.getOpenShiftStatus(e);if(!s){await i(P.s.noOpenShift);return}let r=(0,I.mr)(s.startTime,o.O.timezone);await i(P.s.openShift(r))};e.command("status",async e=>{let t=e.from?.id;t&&await i(String(t),t=>e.reply(t))}),e.hears("–°—Ç–∞—Ç—É—Å",async e=>{let t=e.from?.id;t&&await i(String(t),t=>e.reply(t))})},Y=e=>async(t,a)=>{let i=t.from?.id;if(t.chat?.id&&i){if(!await e.isAdmin(String(i))){await t.reply(P.s.noAccess);return}return a()}},G=e=>encodeURIComponent(e),z=e=>{let t=e.employees.map(t=>{let a=t.displayName||t.username||t.telegramUserId,i=`emp_select:${t.id}:${e.page}:${G(e.query??"")}`;return[v.Markup.button.callback(a,i)]}),a=[v.Markup.button.callback("‚óÄÔ∏è",`emp_page:${Math.max(1,e.page-1)}:${G(e.query??"")}`),v.Markup.button.callback("‚ñ∂Ô∏è",`emp_page:${Math.min(e.totalPages,e.page+1)}:${G(e.query??"")}`)],i=[v.Markup.button.callback("–ü–æ–∏—Å–∫","emp_search"),v.Markup.button.callback("–ù–∞–∑–∞–¥","emp_back")];return v.Markup.inlineKeyboard([...t,a,i])},K=e=>{let t=G(e.query??"");return v.Markup.inlineKeyboard([[v.Markup.button.callback("–û—Ç—á—ë—Ç",`emp_action:report:${e.employeeId}:${e.page}:${t}`)],[v.Markup.button.callback("–§–æ—Ç–æ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –¥–Ω—è)",`emp_action:photos:${e.employeeId}:${e.page}:${t}`)],[v.Markup.button.callback("–ù–∞–∑–∞–¥",`emp_page:${e.page}:${t}`)]])},W=e=>{let t=G(e.query??""),a=e.backAction??`emp_page:${e.backPage}:${t}`;return v.Markup.inlineKeyboard([[v.Markup.button.callback("–ó–∞ 3 –¥–Ω—è",`period_emp:3:${e.employeeId}`),v.Markup.button.callback("–ó–∞ 7 –¥–Ω–µ–π",`period_emp:7:${e.employeeId}`)],[v.Markup.button.callback("–ó–∞ 30 –¥–Ω–µ–π",`period_emp:30:${e.employeeId}`)],[v.Markup.button.callback("–ù–∞–∑–∞–¥",a)]])},j=e=>{let t=G(e.query??"");return v.Markup.inlineKeyboard([[v.Markup.button.callback("–°–µ–≥–æ–¥–Ω—è",`emp_photo_period:today:${e.employeeId}:${e.page}:${t}`),v.Markup.button.callback("–í—á–µ—Ä–∞",`emp_photo_period:yesterday:${e.employeeId}:${e.page}:${t}`)],[v.Markup.button.callback("–ü–æ—Å–ª–µ–¥–Ω–∏–µ 3 –¥–Ω—è",`emp_photo_period:last3:${e.employeeId}:${e.page}:${t}`)],[v.Markup.button.callback("–ù–∞–∑–∞–¥",`emp_action:menu:${e.employeeId}:${e.page}:${t}`)]])},Z=e=>{let t=G(e.query??""),a=e.shifts.map(e=>[v.Markup.button.callback(e.label,`emp_photo_shift:${e.id}`)]);return a.push([v.Markup.button.callback("–ù–∞–∑–∞–¥",`emp_action:photos:${e.employeeId}:${e.page}:${t}`)]),v.Markup.inlineKeyboard(a)},X=()=>v.Markup.inlineKeyboard([[v.Markup.button.callback("–ó–∞ 3 –¥–Ω—è","period_all:3"),v.Markup.button.callback("–ó–∞ 7 –¥–Ω–µ–π","period_all:7")],[v.Markup.button.callback("–ó–∞ 30 –¥–Ω–µ–π","period_all:30")]]),J=(e,t)=>v.Markup.inlineKeyboard([[v.Markup.button.callback("–≠–∫—Å–ø–æ—Ä—Ç CSV",`export_emp:csv:${t}:${e}`)]]),ee=e=>v.Markup.inlineKeyboard([[v.Markup.button.callback("–≠–∫—Å–ø–æ—Ä—Ç CSV",`export_all:csv:${e}`),v.Markup.button.callback("–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏","emp_page:1:")]]),et=e=>`${Math.floor(e/60)} —á ${e%60} –º–∏–Ω`,ea={NOT_CLOSED_IN_TIME:"–ù–µ –∑–∞–∫—Ä—ã–ª(–∞) —Å–º–µ–Ω—É –≤–æ–≤—Ä–µ–º—è"},ei=e=>e.filter(e=>e!==i.ViolationType.SHORT_SHIFT),en=e=>{let t=ei(e);if(0===t.length)return"–Ω–µ—Ç";let a=t.map(e=>ea[e]??String(e)).join(", ");return`${a} ‚ö†Ô∏è`},eo=e=>{let t=ei(e);return 0===t.length?"–ù–∞—Ä—É—à–µ–Ω–∏—è: –Ω–µ—Ç":`–ù–∞—Ä—É—à–µ–Ω–∏—è: –µ—Å—Ç—å (${t.length}) ‚ö†Ô∏è`},es=e=>e===i.ClosedReason.AUTO_TIMEOUT?"–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (12 —á–∞—Å–æ–≤)":e===i.ClosedReason.USER_PHOTO?"–§–æ—Ç–æ":"‚Äî",er=(e,t)=>{let a=[];if(a.push("–û—Ç—á—ë—Ç –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É"),a.push(`–°–æ—Ç—Ä—É–¥–Ω–∏–∫: ${e.displayName}`),a.push(`–ü–µ—Ä–∏–æ–¥: ${(0,I.p6)(e.period.from,t)} ‚Äì ${(0,I.p6)(e.period.to,t)}`),a.push(`–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–º–µ–Ω: ${e.totalShifts}`),a.push(`–°—É–º–º–∞—Ä–Ω–æ–µ –≤—Ä–µ–º—è: ${et(e.totalDurationMinutes)}`),a.push(`–°—Ä–µ–¥–Ω—è—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–º–µ–Ω—ã: ${et(e.averageDurationMinutes)}`),a.push("–ù–∞—Ä—É—à–µ–Ω–∏—è:"),a.push(`- –ù–µ –∑–∞–∫—Ä—ã–ª(–∞) —Å–º–µ–Ω—É –≤–æ–≤—Ä–µ–º—è: ${e.violationsNotClosedInTime}`),a.push(`- –í—Å–µ–≥–æ –Ω–∞—Ä—É—à–µ–Ω–∏–π: ${e.violationsTotal}`),0===e.shifts.length)return a.push(""),a.push(P.s.reportEmpty),a.join("\n");for(let i of(a.push(""),a.push("–°–º–µ–Ω—ã (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10):"),e.shifts)){let e=(0,I.p6)(i.startTime,t),n=(0,I.mr)(i.startTime,t);if(!i.endTime){a.push(`- ${e} –û—Ç–∫—Ä—ã—Ç–∞ —Å ${n} | –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ‚Äî | –ó–∞–∫—Ä—ã—Ç–∏–µ: ‚Äî | –ù–∞—Ä—É—à–µ–Ω–∏—è: ‚Äî`);continue}let o=(0,I.mr)(i.endTime,t),s=null!=i.durationMinutes?et(i.durationMinutes):"‚Äî",r=es(i.closedReason),l=en(i.violations);a.push(`- ${e} ${n}‚Äì${o} | –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${s} | –ó–∞–∫—Ä—ã—Ç–∏–µ: ${r} | –ù–∞—Ä—É—à–µ–Ω–∏—è: ${l}`)}return a.join("\n")},el=(e,t)=>{let a=[];if(a.push("–°–≤–æ–¥–Ω—ã–π –æ—Ç—á—ë—Ç"),a.push(`–ü–µ—Ä–∏–æ–¥: ${(0,I.p6)(e.period.from,t)} ‚Äì ${(0,I.p6)(e.period.to,t)}`),a.push(`–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ –æ—Ç—á—ë—Ç–µ: ${e.totalEmployees}`),a.push(`–í—Å–µ–≥–æ —Å–º–µ–Ω: ${e.totalShifts}`),a.push(`–°—É–º–º–∞—Ä–Ω–æ–µ –≤—Ä–µ–º—è: ${et(e.totalDurationMinutes)}`),a.push("–ù–∞—Ä—É—à–µ–Ω–∏—è:"),a.push(`- –ù–µ –∑–∞–∫—Ä—ã–ª(–∞) –≤–æ–≤—Ä–µ–º—è: ${e.violationsNotClosedInTime}`),a.push(`- –í—Å–µ–≥–æ –Ω–∞—Ä—É—à–µ–Ω–∏–π: ${e.totalViolations}`),0===e.topEmployees.length)return a.push(""),a.push(P.s.reportEmpty),a.join("\n");for(let t of(a.push(""),a.push("–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ (—Ç–æ–ø –ø–æ –Ω–∞—Ä—É—à–µ–Ω–∏—è–º, –∑–∞—Ç–µ–º –ø–æ —á–∞—Å–∞–º):"),e.topEmployees))a.push(`- ${t.displayName} ‚Äî —Å–º–µ–Ω: ${t.totalShifts}, –≤—Ä–µ–º—è: ${et(t.totalDurationMinutes)}, –Ω–∞—Ä—É—à: ${t.violationsTotal} (–Ω–µ –∑–∞–∫—Ä—ã–ª: ${t.violationsNotClosedInTime})`);return a.join("\n")},ed=(e,t=4e3)=>{if(e.length<=t)return[e];let a=e.split("\n"),i=[],n="";for(let e of a){let a=n?`${n}
${e}`:e;a.length>t?n?(i.push(n),n=e):(i.push(e.slice(0,t)),n=e.slice(t)):n=a}return n&&i.push(n),i},ep=e=>{let t=e.trim().split(" ");return t.length<=1?"":t.slice(1).join(" ").trim().slice(0,30)},em=e=>{let t=e.split(":"),a=Number(t[1]??"1"),i=decodeURIComponent(t[2]??"");return{page:Number.isFinite(a)&&a>0?a:1,query:i}},eu=e=>{let t=e.split(":"),a=Number(t[1]??"0"),i=Number(t[2]??"1"),n=decodeURIComponent(t[3]??"");return{employeeId:Number.isFinite(a)?a:0,page:Number.isFinite(i)&&i>0?i:1,query:n}},ey=e=>{let t=e.split(":"),a=t[1]??"",i=Number(t[2]??"0"),n=Number(t[3]??"1"),o=decodeURIComponent(t[4]??"");return{action:a,employeeId:Number.isFinite(i)?i:0,page:Number.isFinite(n)&&n>0?n:1,query:o}},ec=e=>{let t=e.split(":"),a=Number(t[1]??"0"),i=Number(t[2]??"0");return{days:Number.isFinite(a)?a:0,employeeId:Number.isFinite(i)?i:0}},eh=e=>{let t=e.split(":"),a=t[1]??"last3",i=Number(t[2]??"0"),n=Number(t[3]??"1"),o=decodeURIComponent(t[4]??"");return{range:a,employeeId:Number.isFinite(i)?i:0,page:Number.isFinite(n)&&n>0?n:1,query:o}},ef=e=>{let t=(0,I.yD)(e.startTime,e.timezone),a="AUTO_TIMEOUT"===e.closedReason?"–ê–≤—Ç–æ12—á":"USER_PHOTO"===e.closedReason?"–§–æ—Ç–æ":"–û—Ç–∫—Ä—ã—Ç–∞",i=eo(e.violations);return`${t} ‚Äî ${a} ‚Äî ${i}`},eg=(e,t,a,i,n,r)=>{let l=Y(t),d=async(e,t)=>{let{items:i,total:n}=await a.listEmployees({page:t.page,pageSize:8,query:t.query}),o=Math.max(1,Math.ceil(n/8));if(0===n){await e.reply(P.s.noEmployeesFound);return}let s=t.query?`${P.s.employeesChoosePrompt}
–ü–æ–∏—Å–∫: ${t.query}`:P.s.employeesChoosePrompt;await e.reply(s,z({employees:i,page:Math.min(t.page,o),totalPages:o,query:t.query}))},p=async(e,t)=>{let i=await a.findById(t.employeeId);if(!i){await e.reply(P.s.noEmployeesFound);return}await e.reply(P.s.employeeActionPrompt(i.displayName),K({employeeId:i.id,page:t.page,query:t.query}))};e.command("employees",l,async e=>{let t=ep("text"in e.message?e.message.text:"");await d(e,{page:1,query:t})}),e.hears("–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏",l,async e=>{await d(e,{page:1,query:""})}),e.action(/^emp_page:/,l,async e=>{await e.answerCbQuery();let{page:t,query:a}=em("data"in e.callbackQuery?e.callbackQuery.data:"");await d(e,{page:t,query:a})}),e.action(/^emp_select:/,l,async e=>{await e.answerCbQuery();let t=eu("data"in e.callbackQuery?e.callbackQuery.data:"");if(!t.employeeId){await e.reply(P.s.noEmployeesFound);return}await p(e,{employeeId:t.employeeId,page:t.page,query:t.query})}),e.action(/^emp_action:/,l,async e=>{await e.answerCbQuery();let t=ey("data"in e.callbackQuery?e.callbackQuery.data:"");if(!t.employeeId){await e.reply(P.s.noEmployeesFound);return}if("menu"===t.action){await p(e,{employeeId:t.employeeId,page:t.page,query:t.query});return}let i=await a.findById(t.employeeId);if(!i){await e.reply(P.s.noEmployeesFound);return}if("report"===t.action){await e.reply(P.s.employeePeriodPrompt(i.displayName),W({employeeId:t.employeeId,backPage:t.page,query:t.query,backAction:`emp_action:menu:${t.employeeId}:${t.page}:${encodeURIComponent(t.query)}`}));return}"photos"===t.action&&await e.reply(P.s.photoPeriodPrompt(i.displayName),j({employeeId:t.employeeId,page:t.page,query:t.query}))}),e.action(/^emp_search$/,l,async e=>{await e.answerCbQuery(),await e.reply(P.s.searchHint)}),e.action(/^emp_back$/,l,async e=>{await e.answerCbQuery(),await e.reply(P.s.startAdmin,U)}),e.action(/^period_emp:/,l,async e=>{await e.answerCbQuery();let{days:t,employeeId:a}=ec("data"in e.callbackQuery?e.callbackQuery.data:"");if(t&&a)try{let n=await i.getEmployeeReport(a,t);if(!n){await e.reply(P.s.noEmployeesFound);return}let s=er(n,o.O.timezone);for(let t of ed(s))await e.reply(t);await e.reply("–≠–∫—Å–ø–æ—Ä—Ç:",J(a,t))}catch(t){s.k.error({err:t},"Failed to build employee report"),await e.reply("–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")}}),e.action(/^emp_photo_period:/,l,async e=>{await e.answerCbQuery();let t=eh("data"in e.callbackQuery?e.callbackQuery.data:"");if(t.employeeId&&t.range)try{let i=await a.findById(t.employeeId);if(!i){await e.reply(P.s.noEmployeesFound);return}let n=r.buildRange(t.range,o.O.timezone,new Date),s=await r.listEmployeeShifts(i.id,n,10);if(0===s.length){await e.reply(P.s.photoShiftsEmpty);return}let l=s.map(e=>({id:e.id,label:ef({startTime:e.startTime,closedReason:e.closedReason,violations:e.violations,timezone:o.O.timezone})}));await e.reply(`–§–æ—Ç–æ: ${n.label}. –í—ã–±–µ—Ä–∏—Ç–µ —Å–º–µ–Ω—É:`,Z({shifts:l,employeeId:i.id,page:t.page,query:t.query}))}catch(t){s.k.error({err:t},"Failed to build photo shift list"),await e.reply("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–º–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")}}),e.action(/^emp_photo_shift:/,l,async e=>{await e.answerCbQuery();let t=Number(("data"in e.callbackQuery?e.callbackQuery.data:"").split(":")[1]??"0");if(t)try{let a=await r.getShiftDetails(t);if(!a){await e.reply(P.s.shiftNotFound);return}let i=new Date(Date.now()-864e5*o.O.photoRetentionDays),n=!!a.photosPurgedAt||a.startTime<i,s=n?null:a.startPhotoFileId,l=n?null:a.endPhotoFileId,d=(0,I.o0)(a.startTime,o.O.timezone),p=a.endTime?(0,I.o0)(a.endTime,o.O.timezone):"–û—Ç–∫—Ä—ã—Ç–∞",m=null!=a.durationMinutes?et(a.durationMinutes):"‚Äî",u="AUTO_TIMEOUT"===a.closedReason?"–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (12 —á–∞—Å–æ–≤)":"USER_PHOTO"===a.closedReason?"–§–æ—Ç–æ":"‚Äî",y=a.violations.map(e=>e.type),c=a.endTime?en(y):"‚Äî";if(await e.reply(`–°–º–µ–Ω–∞: –¥–µ—Ç–∞–ª–∏
–°–æ—Ç—Ä—É–¥–Ω–∏–∫: ${a.employee.displayName}
–ü–µ—Ä–∏–æ–¥: ${d} ‚Äì ${p}
–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${m}
–°–ø–æ—Å–æ–± –∑–∞–∫—Ä—ã—Ç–∏—è: ${u}
–ù–∞—Ä—É—à–µ–Ω–∏—è: ${c}`),s?await e.replyWithPhoto(s,{caption:"–§–æ—Ç–æ –Ω–∞—á–∞–ª–∞ —Å–º–µ–Ω—ã"}):await e.reply(P.s.photoStartMissing),!a.endTime){await e.reply(P.s.photoEndNotClosed);return}if(l){await e.replyWithPhoto(l,{caption:"–§–æ—Ç–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–º–µ–Ω—ã"});return}if("AUTO_TIMEOUT"===a.closedReason){await e.reply(P.s.photoEndAutoClosed);return}await e.reply(P.s.photoEndMissing)}catch(t){s.k.error({err:t},"Failed to send shift photos"),await e.reply("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ —Å–º–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")}}),e.action(/^export_emp:/,l,async e=>{await e.answerCbQuery();let t=("data"in e.callbackQuery?e.callbackQuery.data:"").split(":"),a=t[1],r=Number(t[2]??"0"),l=Number(t[3]??"0");if("csv"===a&&r&&l)try{let t=await i.getEmployeeReport(l,r);if(!t){await e.reply(P.s.noEmployeesFound);return}let a=await i.getEmployeeShiftsForExport(l,r),s={...t,shifts:a},d=n.buildEmployeeReportCsv(s,o.O.timezone);await e.replyWithDocument({source:d.content,filename:d.filename})}catch(t){s.k.error({err:t},"Failed to export employee report"),await e.reply("–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")}})},eI=e=>{let t=Number(e.split(":")[1]??"0");return Number.isFinite(t)?t:0},ew=(e,t,a,i)=>{let n=Y(t),r=async e=>{await e.reply(P.s.reportAllPrompt,X())};e.command("report",n,async e=>{await r(e)}),e.hears("–û—Ç—á—ë—Ç",n,async e=>{await r(e)}),e.action(/^period_all:/,n,async e=>{await e.answerCbQuery();let t=eI("data"in e.callbackQuery?e.callbackQuery.data:"");if(t)try{let i=await a.getAllEmployeesReport(t),n=el(i,o.O.timezone);for(let t of ed(n))await e.reply(t);await e.reply("–≠–∫—Å–ø–æ—Ä—Ç:",ee(t))}catch(t){s.k.error({err:t},"Failed to build all employees report"),await e.reply("–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")}}),e.action(/^export_all:/,n,async e=>{await e.answerCbQuery();let t=("data"in e.callbackQuery?e.callbackQuery.data:"").split(":"),n=t[1],r=Number(t[2]??"0");if("csv"===n&&r)try{let t=await a.getAllEmployeesReport(r),n=i.buildAllEmployeesSummaryCsv(t.period,t.employees,o.O.timezone);await e.replyWithDocument({source:n.content,filename:n.filename});let s=await a.getRawShiftsForExport(r,new Date,2e3);if(s.shifts.length>0&&s.shifts.length<2e3){let t=i.buildRawShiftsCsv(s.period,s.shifts,o.O.timezone);await e.replyWithDocument({source:t.content,filename:t.filename})}else s.shifts.length>=2e3&&await e.reply(P.s.exportSkipped)}catch(t){s.k.error({err:t},"Failed to export all employees report"),await e.reply("–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")}})},eS=e=>v.Markup.inlineKeyboard([[v.Markup.button.callback("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å",`pending_confirm:${e}`),v.Markup.button.callback("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å",`pending_cancel:${e}`)]]),eT=(e,t,a)=>{e.on("photo",async e=>{let n=e.from,o=e.chat,r=e.message;if(!n||!o||!r||!("photo"in r))return;let l=r.photo;if(!l||0===l.length)return;let d=l[l.length-1].file_id,p=new Date(1e3*r.date),m=await t.resolveRole(String(n.id));if(!t.shouldProcessPhoto(m)){"ADMIN"===m.mode?await e.reply(P.s.adminPhotoIgnored):await e.reply(P.s.notEmployee);return}try{let t=await a.createFromPhoto({user:{id:n.id,username:n.username,firstName:n.first_name,lastName:n.last_name,chatId:o.id},messageId:r.message_id,chatId:o.id,fileId:d,messageDate:p});if("duplicate"===t.type)return;let s=t.actionType===i.PendingActionType.START?P.s.confirmStartPrompt:P.s.confirmEndPrompt;await e.reply(s,eS(t.pendingAction.id))}catch(t){s.k.error({err:t},"Failed to create pending action"),await e.reply("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–æ—Ç–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")}}),e.catch((e,t)=>{let a=t.update;s.k.error({err:e,updateId:a?.update_id,updateType:t.updateType,chatId:t.chat?.id,fromId:t.from?.id,messageId:a?.message?.message_id,callbackData:a?.callback_query?.data},"Bot error")})},eE=e=>{let t=Number(e.split(":")[1]??"0");return Number.isFinite(t)?t:0},e_=(e,t,a)=>{e.action(/^pending_confirm:/,async i=>{await i.answerCbQuery();let n=eE("data"in i.callbackQuery?i.callbackQuery.data:""),r=i.from?.id;if(n&&r)try{let l=await t.confirmAction(n,String(r)),d=await a.getAdminChatIds();if("confirmed_start"===l.type){if(l.autoClose){let t=(0,I.mr)(l.autoClose.endTime??new Date,o.O.timezone),a=P.s.autoClosedBoss(l.employee.displayName,t,o.O.maxShiftHours);for(let t of d)try{await e.telegram.sendMessage(t,a)}catch(e){s.k.error({err:e,adminChatId:t},"Failed to notify admin about auto-close")}if(o.O.notifyEmployeeOnAutoClose)try{await e.telegram.sendMessage(l.employee.telegramUserId,P.s.autoClosedEmployee(o.O.maxShiftHours))}catch(e){s.k.error({err:e,employeeId:l.employee.telegramUserId},"Failed to notify employee")}}let t=(0,I.mr)(l.shift.startTime,o.O.timezone);await i.reply(P.s.shiftStarted(t));let a=P.s.bossShiftStarted(l.employee.displayName,t);for(let t of d)try{await e.telegram.sendMessage(t,a)}catch(e){s.k.error({err:e,adminChatId:t},"Failed to notify admin about shift start")}return}if("confirmed_end"===l.type){let t=(0,I.mr)(l.shift.endTime??new Date,o.O.timezone),a=et(l.durationMinutes);await i.reply(P.s.shiftClosed(t,a));let n=P.s.bossShiftClosed(l.employee.displayName,a);for(let t of d)try{await e.telegram.sendMessage(t,n)}catch(e){s.k.error({err:e,adminChatId:t},"Failed to notify admin about shift close")}return}if("auto_closed"===l.type){let t=(0,I.mr)(l.autoClose.endTime??new Date,o.O.timezone),a=P.s.autoClosedBoss(l.autoClose.employee.displayName,t,o.O.maxShiftHours);for(let t of d)try{await e.telegram.sendMessage(t,a)}catch(e){s.k.error({err:e,adminChatId:t},"Failed to notify admin about auto-close")}o.O.notifyEmployeeOnAutoClose?await i.reply(P.s.autoClosedEmployee(o.O.maxShiftHours)):await i.reply(P.s.alreadyClosed);return}if("open_shift_exists"===l.type){await i.reply(P.s.openShiftExists);return}if("no_open_shift"===l.type){await i.reply(P.s.alreadyClosed);return}if("expired"===l.type){await i.reply(P.s.pendingExpired);return}if("already_handled"===l.type){await i.reply(P.s.pendingAlreadyHandled);return}if("forbidden"===l.type){await i.reply(P.s.noAccess);return}"not_found"===l.type&&await i.reply(P.s.pendingNotFound)}catch(e){s.k.error({err:e},"Failed to confirm pending action"),await i.reply("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")}}),e.action(/^pending_cancel:/,async e=>{await e.answerCbQuery();let a=eE("data"in e.callbackQuery?e.callbackQuery.data:""),i=e.from?.id;if(a&&i)try{let n=await t.cancelAction(a,String(i));if("cancelled"===n.type){await e.reply(P.s.pendingCancelled);return}if("expired"===n.type){await e.reply(P.s.pendingExpired);return}if("already_handled"===n.type){await e.reply(P.s.pendingAlreadyHandled);return}if("forbidden"===n.type){await e.reply(P.s.noAccess);return}"not_found"===n.type&&await e.reply(P.s.pendingNotFound)}catch(t){s.k.error({err:t},"Failed to cancel pending action"),await e.reply("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")}})},eM=(e,t,a,i,n)=>{e.on("message",async e=>{let o=e.message;if(!o||"photo"in o||"text"in o&&o.text.startsWith("/")||"text"in o&&["–ü–æ–º–æ—â—å","–°—Ç–∞—Ç—É—Å","–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏","–û—Ç—á—ë—Ç","–†–µ–∂–∏–º: –ê–¥–º–∏–Ω","–†–µ–∂–∏–º: –°–æ—Ç—Ä—É–¥–Ω–∏–∫"].includes(o.text))return;let s=e.from?.id;if(!s)return;let r=String(s),l=await i.getSession(r);if(l?.fullNameRequestedAt&&"text"in o){let t=l.fullNameRequestedAt,s=new Date;if(!t||s.getTime()-t.getTime()>6e5)await i.clearFullNameRequestedAt(r);else if(!await n.hasActivePendingAction(r)){let t=L(o.text);if(!t){await e.reply(P.s.fullNameInvalid);return}let n=await a.updateNameByTelegramUserId(r,t);if(!n&&e.from){let i=e.chat?.id??e.from.id;await a.upsertFromTelegram({id:e.from.id,username:e.from.username,firstName:e.from.first_name,lastName:e.from.last_name,chatId:i}),n=await a.updateNameByTelegramUserId(r,t)}if(!n)return;await i.clearFullNameRequestedAt(r),await e.reply(P.s.fullNameSaved(t.displayName));return}}if(l?.nameRequestedAt&&"text"in o){if(q(await a.findByTelegramUserId(r)))await i.clearNameRequestedAt(r);else if(!await n.hasActivePendingAction(r)){let t=L(o.text);if(!t){await e.reply(P.s.nameInvalid);return}let n=await a.updateNameByTelegramUserId(r,t);if(!n&&e.from){let i=e.chat?.id??e.from.id;await a.upsertFromTelegram({id:e.from.id,username:e.from.username,firstName:e.from.first_name,lastName:e.from.last_name,chatId:i}),n=await a.updateNameByTelegramUserId(r,t)}if(!n)return;await i.clearNameRequestedAt(r),await e.reply(P.s.nameSaved(t.displayName)),await e.reply(P.s.startEmployee,$);return}}if("ADMIN"===(await t.resolveRole(r)).mode){await e.reply(P.s.instructionAdmin);return}await e.reply(P.s.instructionEmployee)})},eA=e=>{e.command("whoami",async e=>{let t=e.chat,a=e.from;if(!t||!a)return;let i=a.username?`@${a.username}`:"‚Äî",n=[`–¢–∏–ø —á–∞—Ç–∞: ${t.type}`,`Chat ID: ${t.id}`,`–í–∞—à User ID: ${a.id}`,`Username: ${i}`,`–ü–æ–¥—Å–∫–∞–∑–∫–∞: TELEGRAM_BOSS_CHAT_ID = ${t.id}, ADMIN_USER_IDS += ${a.id}`];await e.reply(n.join("\n"))})},eR=(e,t)=>{e.command("set_admin",async e=>{let a=e.from?.id;if(a){if(!await t.canAssignAdmin(String(a))){await e.reply(P.s.noAccess);return}await t.addAdmin(String(a)),await e.reply(P.s.setAdminSuccess)}})},eN=(e,t)=>{let a=async(e,a)=>{let i=await t.resolveRole(e);if(i.isBoth){let e="ADMIN"===i.mode?"–ê–¥–º–∏–Ω":"–°–æ—Ç—Ä—É–¥–Ω–∏–∫";await a(`${P.s.helpBoth}
–¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º: ${e}.`);return}if("ADMIN"===i.mode){await a(P.s.helpAdmin);return}await a(P.s.helpEmployee)};e.command("help",async e=>{let t=e.from?.id;t&&await a(String(t),t=>e.reply(t))}),e.hears("–ü–æ–º–æ—â—å",async e=>{let t=e.from?.id;t&&await a(String(t),t=>e.reply(t))})},eO=(e,t)=>{let a=async(e,a,n)=>{if(!(await t.resolveRole(e)).isBoth){await n(P.s.modeUnavailable);return}if(await t.setMode(e,a),a===i.UserMode.ADMIN){await n(P.s.modeSetAdmin);return}await n(P.s.modeSetEmployee)};e.command("mode",async e=>{let a=e.from?.id;if(a){if(!(await t.resolveRole(String(a))).isBoth){await e.reply(P.s.modeUnavailable);return}await e.reply(P.s.modePrompt,F)}}),e.action(/^mode:(ADMIN|EMPLOYEE)$/,async e=>{await e.answerCbQuery();let t=e.from?.id;if(!t)return;let n=("data"in e.callbackQuery?e.callbackQuery.data:"").split(":")[1];("ADMIN"===n||"EMPLOYEE"===n)&&await a(String(t),"ADMIN"===n?i.UserMode.ADMIN:i.UserMode.EMPLOYEE,t=>e.reply(t))}),e.hears("–†–µ–∂–∏–º: –ê–¥–º–∏–Ω",async e=>{let t=e.from?.id;t&&await a(String(t),i.UserMode.ADMIN,t=>e.reply(t))}),e.hears("–†–µ–∂–∏–º: –°–æ—Ç—Ä—É–¥–Ω–∏–∫",async e=>{let t=e.from?.id;t&&await a(String(t),i.UserMode.EMPLOYEE,t=>e.reply(t))})},eC=(e,t,a,i)=>{e.command("fullname",async e=>{let n=e.from;if(!n)return;let o=String(n.id);if(!(await t.resolveRole(o)).isEmployee){await e.reply(P.s.fullNameNotEmployee);return}let s=e.chat?.id??n.id;await a.upsertFromTelegram({id:n.id,username:n.username,firstName:n.first_name,lastName:n.last_name,chatId:s}),await i.setFullNameRequestedAt(o,new Date),await e.reply(P.s.fullNamePrompt)})},eb=e=>{let t=new v.Telegraf(o.O.telegramBotToken);return Q(t,e.roleService,e.employeeRepo,e.userSessionRepo),V(t,e.shiftService,e.roleService),eA(t),eN(t,e.roleService),eO(t,e.roleService),eC(t,e.roleService,e.employeeRepo,e.userSessionRepo),eR(t,e.adminService),eg(t,e.adminService,e.employeeRepo,e.reportService,e.exportService,e.photoReviewService),ew(t,e.adminService,e.reportService,e.exportService),eT(t,e.roleService,e.pendingActionService),e_(t,e.pendingActionService,e.adminService),eM(t,e.roleService,e.employeeRepo,e.userSessionRepo,e.pendingActionService),t},eD=globalThis,ev=async()=>(eD.__shiftBotApp||(eD.__shiftBotApp=(async()=>{await n.$connect();let e=new d,t=new p,a=new m,i=new u,r=new y,l=new f(a),I=new c(e,t,{maxShiftHours:o.O.maxShiftHours,minShiftMinutes:60*o.O.minShiftHours,shortShiftGraceMinutes:o.O.shortShiftGraceMinutes},s.k),w=new h(t,e),S=new g(l,e,i),T=new _,E=new D(t),A=new M(e,t,r,{ttlMinutes:o.O.pendingActionTtlMinutes,maxShiftHours:o.O.maxShiftHours,minShiftMinutes:60*o.O.minShiftHours,shortShiftGraceMinutes:o.O.shortShiftGraceMinutes},async e=>n.$transaction(async t=>e(t)));return{prisma:n,bot:eb({shiftService:I,reportService:w,adminService:l,roleService:S,employeeRepo:e,userSessionRepo:i,exportService:T,pendingActionService:A,photoReviewService:E}),employeeRepo:e,userSessionRepo:i,shiftRepo:t,shiftService:I,adminService:l,roleService:S,reportService:w,exportService:T,pendingActionService:A,photoReviewService:E}})()),eD.__shiftBotApp)},6751:(e,t,a)=>{a.d(t,{TW:()=>y,mr:()=>d,o0:()=>m,p6:()=>p,yD:()=>u});var i=a(3555),n=a.n(i),o=a(4799),s=a.n(o),r=a(8466),l=a.n(r);n().extend(s()),n().extend(l());let d=(e,t)=>n()(e).tz(t).format("HH:mm"),p=(e,t)=>n()(e).tz(t).format("DD.MM.YYYY"),m=(e,t)=>n()(e).tz(t).format("DD.MM.YYYY HH:mm"),u=(e,t)=>n()(e).tz(t).format("DD.MM HH:mm"),y=(e,t)=>n()(e).tz(t).format("YYYY-MM-DD")}};