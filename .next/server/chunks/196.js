"use strict";exports.id=196,exports.ids=[196],exports.modules={3406:(e,t,a)=>{a.d(t,{s:()=>i});let i={startEmployee:"–ü—Ä–∏–≤–µ—Ç! –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–º–µ–Ω—É, –∑–∞—Ç–µ–º –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ. –§–æ—Ç–æ –µ—â—ë —Ä–∞–∑ ‚Äî –∑–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É.",startAdmin:"–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä.\n–ö–æ–º–∞–Ω–¥—ã: /employees, /report, /errors, /whoami, /help",startBoth:"–í—ã –º–æ–∂–µ—Ç–µ —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∏–ª–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫. –¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º: –ê–¥–º–∏–Ω.",namePrompt:"–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º. –ü—Ä–∏–º–µ—Ä: –ò–ª—å—è—Å –Ø–Ω–≥—É—Ä–∞–∑–æ–≤",nameInvalid:"–ù—É–∂–Ω–æ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—è. –ü—Ä–∏–º–µ—Ä: –ò–ª—å—è—Å –Ø–Ω–≥—É—Ä–∞–∑–æ–≤",nameSaved:e=>`–ì–æ—Ç–æ–≤–æ. –í–∞—à–µ –∏–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ${e}`,fullNamePrompt:"–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º. –ü—Ä–∏–º–µ—Ä: Ilias Iangurazov",fullNameInvalid:"–ù—É–∂–Ω–æ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—è. –ü—Ä–∏–º–µ—Ä: Ilias Iangurazov",fullNameSaved:e=>`–ì–æ—Ç–æ–≤–æ. –ò–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–æ: ${e}`,fullNameNotEmployee:"–ö–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –¥–æ–±–∞–≤—å—Ç–µ —Å–µ–±—è –∫–∞–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.",instructionEmployee:"–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ.",instructionAdmin:"–í—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /employees –∏–ª–∏ /help.",noAccess:"–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞.",noOpenShift:"–û—Ç–∫—Ä—ã—Ç—ã—Ö —Å–º–µ–Ω –Ω–µ—Ç.",openShift:e=>`–û—Ç–∫—Ä—ã—Ç–∞—è —Å–º–µ–Ω–∞ —Å ${e}`,shiftStarted:e=>`–°–º–µ–Ω–∞ –Ω–∞—á–∞–ª–∞—Å—å: ${e}`,shiftClosed:(e,t)=>`–°–º–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∞: ${e}. –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${t}.`,bossShiftStarted:(e,t)=>`‚úÖ ${e} –Ω–∞—á–∞–ª(–∞) —Å–º–µ–Ω—É –≤ ${t}`,bossShiftClosed:(e,t)=>`üèÅ ${e} –∑–∞–∫—Ä—ã–ª(–∞) —Å–º–µ–Ω—É. –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${t}.`,autoClosedBoss:(e,t,a)=>`‚ö†Ô∏è ${e} –Ω–µ –∑–∞–∫—Ä—ã–ª(–∞) —Å–º–µ–Ω—É –≤–æ–≤—Ä–µ–º—è. –°–º–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã—Ç–∞ –≤ ${t} (${a} —á–∞—Å–æ–≤). –ù–∞—Ä—É—à–µ–Ω–∏–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ.`,autoClosedEmployee:e=>`‚ö†Ô∏è –í—ã –Ω–µ –∑–∞–∫—Ä—ã–ª–∏ —Å–º–µ–Ω—É –≤–æ–≤—Ä–µ–º—è. –°–º–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã—Ç–∞ —á–µ—Ä–µ–∑ ${e} —á–∞—Å–æ–≤. –ù–∞—Ä—É—à–µ–Ω–∏–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ.`,alreadyClosed:"–û—Ç–∫—Ä—ã—Ç–∞—è —Å–º–µ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ (–≤–æ–∑–º–æ–∂–Ω–æ, –æ–Ω–∞ –±—ã–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã—Ç–∞).",reportChoosePeriod:"–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –æ—Ç—á—ë—Ç–∞:",employeesChoosePrompt:"–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏: –≤—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.",reportAllPrompt:"–û—Ç—á—ë—Ç: —Å–≤–æ–¥–∫–∞ –ø–æ –≤—Å–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º. –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥.",employeePeriodPrompt:e=>`–°–æ—Ç—Ä—É–¥–Ω–∏–∫: ${e}. –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥:`,employeeActionPrompt:e=>`–°–æ—Ç—Ä—É–¥–Ω–∏–∫: ${e}. –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:`,photoPeriodPrompt:e=>`–§–æ—Ç–æ –¥–ª—è ${e}. –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥:`,exportReady:"–§–∞–π–ª –≥–æ—Ç–æ–≤.",exportSkipped:"–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–º–µ–Ω –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞. –û—Ç–ø—Ä–∞–≤–ª–µ–Ω —Ç–æ–ª—å–∫–æ –æ–±—â–∏–π —Ñ–∞–π–ª.",searchHint:"–í–≤–µ–¥–∏—Ç–µ /employees <–∑–∞–ø—Ä–æ—Å> –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ username.",noEmployeesFound:"–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.",reportEmpty:"–î–∞–Ω–Ω—ã–µ –∑–∞ –ø–µ—Ä–∏–æ–¥ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.",setAdminSuccess:"–í—ã –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.",adminPhotoIgnored:"–í—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä. –§–æ—Ç–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–º–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /employees –∏–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º.",notEmployee:"–í—ã –Ω–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Å–µ–±—è –∫–∞–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.",confirmStartPrompt:"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–∞—á–∞–ª–æ —Å–º–µ–Ω—ã?",confirmEndPrompt:"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã?",pendingCancelled:"–û—Ç–º–µ–Ω–µ–Ω–æ. –§–æ—Ç–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ —Å–º–µ–Ω–µ.",pendingExpired:"–í—Ä–µ–º—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –∑–∞–Ω–æ–≤–æ.",pendingAlreadyHandled:"–î–µ–π—Å—Ç–≤–∏–µ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ.",pendingNotFound:"–î–µ–π—Å—Ç–≤–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.",openShiftExists:"–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç–∞—è —Å–º–µ–Ω–∞. –°–Ω–∞—á–∞–ª–∞ –∑–∞–∫—Ä–æ–π—Ç–µ –µ—ë.",photoShiftsEmpty:"–°–º–µ–Ω—ã –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.",photoStartMissing:"–§–æ—Ç–æ –Ω–∞—á–∞–ª–∞ —Å–º–µ–Ω—ã: —É–¥–∞–ª–µ–Ω–æ –ø–æ –ø–æ–ª–∏—Ç–∏–∫–µ —Ö—Ä–∞–Ω–µ–Ω–∏—è (3 –¥–Ω—è).",photoEndMissing:"–§–æ—Ç–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–º–µ–Ω—ã: —É–¥–∞–ª–µ–Ω–æ –ø–æ –ø–æ–ª–∏—Ç–∏–∫–µ —Ö—Ä–∞–Ω–µ–Ω–∏—è (3 –¥–Ω—è).",photoEndNotClosed:"–§–æ—Ç–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–º–µ–Ω—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (—Å–º–µ–Ω–∞ –µ—â—ë –Ω–µ –∑–∞–∫—Ä—ã—Ç–∞).",photoEndAutoClosed:"–§–æ—Ç–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–º–µ–Ω—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (—Å–º–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã—Ç–∞).",shiftNotFound:"–°–º–µ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.",helpAdmin:"–ü–æ–º–æ—â—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:\n/employees ‚Äî –æ—Ç—á—ë—Ç –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É\n/report ‚Äî –æ–±—â–∏–π –æ—Ç—á—ë—Ç\n/errors ‚Äî –æ—à–∏–±–∫–∏\n/mode ‚Äî —Ä–µ–∂–∏–º (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)\n/whoami ‚Äî –≤–∞—à–∏ ID",helpEmployee:"–ü–æ–º–æ—â—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:\n–§–æ—Ç–æ ‚Äî –∑–∞–ø—Ä–æ—Å–∏—Ç—å –Ω–∞—á–∞–ª–æ/–∑–∞–∫—Ä—ã—Ç–∏–µ (–Ω—É–∂–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å)\n/status ‚Äî —Å—Ç–∞—Ç—É—Å —Å–º–µ–Ω—ã\n/fullname ‚Äî –∏–∑–º–µ–Ω–∏—Ç—å –∏–º—è\n/whoami ‚Äî –≤–∞—à–∏ ID",helpBoth:"–ü–æ–º–æ—â—å:\n/mode ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º\n/employees ‚Äî –æ—Ç—á—ë—Ç –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É\n/report ‚Äî –æ–±—â–∏–π –æ—Ç—á—ë—Ç\n/errors ‚Äî –æ—à–∏–±–∫–∏ (–∞–¥–º–∏–Ω)\n/status ‚Äî —Å—Ç–∞—Ç—É—Å —Å–º–µ–Ω—ã (—Å–æ—Ç—Ä—É–¥–Ω–∏–∫)\n/fullname ‚Äî –∏–∑–º–µ–Ω–∏—Ç—å –∏–º—è\n–§–æ—Ç–æ ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–º–µ–Ω—ã",modePrompt:"–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º:",modeSetAdmin:"–†–µ–∂–∏–º: –ê–¥–º–∏–Ω.",modeSetEmployee:"–†–µ–∂–∏–º: –°–æ—Ç—Ä—É–¥–Ω–∏–∫.",modeUnavailable:"–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ."}},1133:(e,t,a)=>{a.d(t,{Fo:()=>I,gj:()=>S});var i=a(7151),r=a(4051);let o=[300,800,1600],n=new Set(["ETIMEDOUT","ECONNRESET","EAI_AGAIN","ENOTFOUND","ECONNREFUSED"]),s=Symbol.for("shiftbot.rawCallApi"),l=Symbol.for("shiftbot.safeTelegramApplied"),d=Symbol.for("shiftbot.safeTelegramCallApi"),p=e=>new Promise(t=>setTimeout(t,e)),m=e=>{let t=e?.response,a="number"==typeof t?.error_code?t.error_code:void 0;return{errorCode:a,description:"string"==typeof t?.description?t.description:void 0,retryAfterSeconds:"number"==typeof t?.parameters?.retry_after?t.parameters.retry_after:void 0,networkCode:e?.code??e?.cause?.code}},u=e=>!!(e&&e.toLowerCase().includes("chat not found")),c=e=>!!(e&&e.toLowerCase().includes("bot was blocked by the user")),y=e=>null!=e.retryAfterSeconds||!!e.errorCode&&e.errorCode>=500||!(e.errorCode&&[400,401,403,404].includes(e.errorCode)||u(e.description)||c(e.description))&&!!(e.networkCode&&n.has(e.networkCode)),f=(e,t)=>e.description?e.description:e.errorCode?`Telegram error ${e.errorCode}`:e.networkCode?`Network error ${e.networkCode}`:t,h=async e=>{let t=m(e.error);await (0,r.K)(i._,{level:"warn",kind:"telegram_send_error",chatId:e.chatId??void 0,meta:{method:e.method,attempt:e.attempt,willRetry:e.willRetry,errorCode:t.errorCode,description:t.description,networkCode:t.networkCode},err:e.error})},g=async e=>{let t=e.maxRetries??o.length,a=0;for(;a<=t;)try{let t=await e.rawCall(e.method,e.payload);return{ok:!0,result:t}}catch(s){let i;let r=m(s),n=a<t&&y(r);try{await h({method:e.method,chatId:e.payload?.chat_id,attempt:a,error:s,willRetry:n})}catch{}if(!n)return{ok:!1,reason:f(r,"Telegram send failed"),error:s};if(null!=r.retryAfterSeconds){let e=Math.floor(250*Math.random());i=1e3*r.retryAfterSeconds+e}else i=o[Math.min(a,o.length-1)]+Math.floor(150*Math.random());a+=1,await p(i)}return{ok:!1,reason:"Telegram send failed"}},w=e=>{let t=e[s],a=e[d];return"function"==typeof t&&e.callApi===a?t.bind(e):e.callApi.bind(e)},I=e=>{if(e[l])return;e[l]=!0,e[s]=e.callApi.bind(e);let t=async(t,a)=>{let i=await g({telegram:e,method:t,payload:a??{},rawCall:e[s]});return i.ok?i.result:{ok:!1}};e[d]=t,e.callApi=t},S=async(e,t,a,i)=>g({telegram:e,method:"sendMessage",payload:{chat_id:t,text:a,...i??{}},rawCall:w(e)})},7388:(e,t,a)=>{a.d(t,{g:()=>i.gj});var i=a(1133)},2942:(e,t,a)=>{a.d(t,{O:()=>n}),a(4243);var i=a(7012);let r=i.dj(e=>{if("string"==typeof e){let t=e.trim().toLowerCase();if(["true","1","yes","y","on"].includes(t))return!0;if(["false","0","no","n","off",""].includes(t))return!1}return e},i.O7()),o=i.Ry({TELEGRAM_BOT_TOKEN:i.Z_().min(1),TELEGRAM_BOSS_CHAT_ID:i.Z_().min(1),ADMIN_USER_IDS:i.Z_().optional(),DATABASE_URL:i.Z_().min(1),WEBHOOK_SECRET:i.Z_().min(1),INTERNAL_SECRET:i.Z_().min(1),PUBLIC_BASE_URL:i.Z_().min(1),TELEGRAM_WEBHOOK_SECRET_TOKEN:i.Z_().optional(),TIMEZONE:i.Z_().default("Asia/Bishkek"),MAX_SHIFT_HOURS:i.oQ.number().int().positive().default(12),MIN_SHIFT_HOURS:i.oQ.number().int().positive().default(8),SHORT_SHIFT_GRACE_MINUTES:i.oQ.number().int().min(0).default(0),PENDING_ACTION_TTL_MINUTES:i.oQ.number().int().positive().default(10),PENDING_ACTION_CLEANUP_CRON:i.Z_().default("*/2 * * * *"),PHOTO_RETENTION_DAYS:i.oQ.number().int().positive().default(3),PHOTO_RETENTION_CRON:i.Z_().default("0 * * * *"),OVERDUE_CHECK_CRON:i.Z_().default("*/5 * * * *"),TICK_MAX_AUTOCLOSE:i.oQ.number().int().positive().default(50),TICK_MAX_EXPIRE_PENDING:i.oQ.number().int().positive().default(200),NOTIFY_EMPLOYEE_ON_AUTOCLOSE:r.default(!0),ERROR_NOTIFY_BOSS:r.default(!1),ERROR_NOTIFY_COOLDOWN_SEC:i.oQ.number().int().positive().default(60),EVENT_LOG_RETENTION_DAYS:i.oQ.number().int().positive().default(14),LOG_LEVEL:i.Z_().default("info"),NODE_ENV:i.Z_().optional()}).safeParse(process.env);if(!o.success){let e=o.error.format();throw Error(`Invalid environment configuration: ${JSON.stringify(e)}`)}let n={telegramBotToken:o.data.TELEGRAM_BOT_TOKEN,telegramBossChatId:o.data.TELEGRAM_BOSS_CHAT_ID,adminUserIds:(o.data.ADMIN_USER_IDS??"").split(",").map(e=>e.trim()).filter(Boolean),databaseUrl:o.data.DATABASE_URL,webhookSecret:o.data.WEBHOOK_SECRET,internalSecret:o.data.INTERNAL_SECRET,publicBaseUrl:o.data.PUBLIC_BASE_URL,telegramWebhookSecretToken:o.data.TELEGRAM_WEBHOOK_SECRET_TOKEN??null,timezone:o.data.TIMEZONE,maxShiftHours:o.data.MAX_SHIFT_HOURS,minShiftHours:o.data.MIN_SHIFT_HOURS,shortShiftGraceMinutes:o.data.SHORT_SHIFT_GRACE_MINUTES,pendingActionTtlMinutes:o.data.PENDING_ACTION_TTL_MINUTES,pendingActionCleanupCron:o.data.PENDING_ACTION_CLEANUP_CRON,photoRetentionDays:o.data.PHOTO_RETENTION_DAYS,photoRetentionCron:o.data.PHOTO_RETENTION_CRON,overdueCheckCron:o.data.OVERDUE_CHECK_CRON,tickMaxAutoclose:o.data.TICK_MAX_AUTOCLOSE,tickMaxExpirePending:o.data.TICK_MAX_EXPIRE_PENDING,notifyEmployeeOnAutoClose:o.data.NOTIFY_EMPLOYEE_ON_AUTOCLOSE,errorNotifyBoss:o.data.ERROR_NOTIFY_BOSS,errorNotifyCooldownSec:o.data.ERROR_NOTIFY_COOLDOWN_SEC,eventLogRetentionDays:o.data.EVENT_LOG_RETENTION_DAYS,logLevel:o.data.LOG_LEVEL,nodeEnv:o.data.NODE_ENV}},8361:(e,t,a)=>{a.d(t,{k:()=>n});var i=a(4062),r=a.n(i),o=a(2942);let n=r()({level:o.O.logLevel,base:{service:"telegram-shift-bot"}})},7151:(e,t,a)=>{a.d(t,{_:()=>r});var i=a(3524);let r=globalThis.prisma??new i.PrismaClient},3196:(e,t,a)=>{a.d(t,{M:()=>ez});var i=a(7151),r=a(2942),o=a(8361);let n=e=>{let t=[e.firstName,e.lastName].filter(Boolean);return t.length>0?t.join(" "):e.username?`@${e.username}`:`user:${e.id}`},s=e=>!e||0===e.trim().length;class l{async upsertFromTelegram(e){let t=String(e.id),a=n(e),r=await i._.employee.findUnique({where:{telegramUserId:t}});if(!r)return i._.employee.create({data:{telegramUserId:t,username:e.username??null,firstName:e.firstName??null,lastName:e.lastName??null,displayName:a}});let o={username:e.username??null};return s(r.firstName)&&e.firstName&&(o.firstName=e.firstName),s(r.lastName)&&e.lastName&&(o.lastName=e.lastName),s(r.displayName)&&(o.displayName=a),i._.employee.update({where:{telegramUserId:t},data:o})}async findByTelegramUserId(e){return i._.employee.findUnique({where:{telegramUserId:e}})}async findById(e){return i._.employee.findUnique({where:{id:e}})}async findByIds(e){return 0===e.length?[]:i._.employee.findMany({where:{id:{in:e}}})}async listEmployees(e){let t=Math.max(1,e.page),a=Math.min(20,Math.max(1,e.pageSize)),r=e.query?.trim(),o=r?{OR:[{displayName:{contains:r,mode:"insensitive"}},{username:{contains:r,mode:"insensitive"}},{firstName:{contains:r,mode:"insensitive"}},{lastName:{contains:r,mode:"insensitive"}},{telegramUserId:{contains:r,mode:"insensitive"}}]}:{},[n,s]=await i._.$transaction([i._.employee.count({where:o}),i._.employee.findMany({where:o,orderBy:{displayName:"asc"},skip:(t-1)*a,take:a})]);return{total:n,items:s}}async updateNameByTelegramUserId(e,t){return 0===(await i._.employee.updateMany({where:{telegramUserId:e},data:{firstName:t.firstName,lastName:t.lastName,displayName:t.displayName}})).count?null:i._.employee.findUnique({where:{telegramUserId:e}})}}var d=a(3524);class p{async findOpenShift(e,t){return(t??i._).shift.findFirst({where:{employeeId:e,endTime:null},orderBy:{startTime:"desc"}})}async findLastShift(e){return i._.shift.findFirst({where:{employeeId:e},orderBy:{startTime:"desc"}})}async isMessageProcessed(e,t){return!!await i._.shift.findFirst({where:{OR:[{startChatId:e,startMessageId:t},{endChatId:e,endMessageId:t}]},select:{id:!0}})}async createShiftStart(e,t){return(t??i._).shift.create({data:{employeeId:e.employeeId,startTime:e.startTime,startPhotoFileId:e.startPhotoFileId,startMessageId:e.startMessageId,startChatId:e.startChatId,employeeChatId:e.startChatId}})}async closeShiftByUserPhoto(e,t){return(t??i._).shift.update({where:{id:e.shiftId},data:{endTime:e.endTime,endPhotoFileId:e.endPhotoFileId,endMessageId:e.endMessageId,endChatId:e.endChatId,closedReason:d.ClosedReason.USER_PHOTO,durationMinutes:e.durationMinutes}})}async createViolation(e,t,a){let r=a??i._;await r.shiftViolation.createMany({data:[{shiftId:e,type:t}],skipDuplicates:!0})}async findOverdueShifts(e,t){return i._.shift.findMany({where:{endTime:null,alertedAt:null,startTime:{lte:e}},include:{employee:!0,violations:!0},orderBy:{startTime:"asc"},take:t})}async autoCloseShift(e,t,a,r,o){return o?0===(await o.shift.updateMany({where:{id:e,endTime:null,alertedAt:null},data:{endTime:t,closedReason:d.ClosedReason.AUTO_TIMEOUT,durationMinutes:a,autoClosedAt:r,alertedAt:r}})).count?null:(await o.shiftViolation.createMany({data:[{shiftId:e,type:d.ViolationType.NOT_CLOSED_IN_TIME}],skipDuplicates:!0}),o.shift.findUnique({where:{id:e},include:{employee:!0,violations:!0}})):i._.$transaction(async i=>0===(await i.shift.updateMany({where:{id:e,endTime:null,alertedAt:null},data:{endTime:t,closedReason:d.ClosedReason.AUTO_TIMEOUT,durationMinutes:a,autoClosedAt:r,alertedAt:r}})).count?null:(await i.shiftViolation.createMany({data:[{shiftId:e,type:d.ViolationType.NOT_CLOSED_IN_TIME}],skipDuplicates:!0}),i.shift.findUnique({where:{id:e},include:{employee:!0,violations:!0}})))}async findShiftsInRange(e,t,a){return i._.shift.findMany({where:{startTime:{gte:e,lte:t}},include:{employee:!0,violations:!0},orderBy:[{employeeId:"asc"},{startTime:a?.order??"asc"}],take:a?.limit})}async findEmployeeShiftsInRange(e,t,a,r){return i._.shift.findMany({where:{employeeId:e,startTime:{gte:t,lte:a}},include:{employee:!0,violations:!0},orderBy:{startTime:"desc"},skip:r.skip,take:r.limit})}async findShiftById(e){return i._.shift.findUnique({where:{id:e},include:{employee:!0,violations:!0}})}async purgeOldPhotos(e,t,a){if(!a)return(await i._.shift.updateMany({where:{startTime:{lt:e},photosPurgedAt:null},data:{startPhotoFileId:null,endPhotoFileId:null,photosPurgedAt:t}})).count;let r=await i._.shift.findMany({where:{startTime:{lt:e},photosPurgedAt:null},select:{id:!0},orderBy:{startTime:"asc"},take:a});if(0===r.length)return 0;let o=r.map(e=>e.id);return(await i._.shift.updateMany({where:{id:{in:o},photosPurgedAt:null},data:{startPhotoFileId:null,endPhotoFileId:null,photosPurgedAt:t}})).count}async aggregateEmployeeStats(e,t,a){let r=await i._.shift.aggregate({where:{employeeId:e,startTime:{gte:t,lte:a}},_count:{_all:!0},_sum:{durationMinutes:!0},_avg:{durationMinutes:!0}});return{totalShifts:r._count._all,totalDurationMinutes:r._sum.durationMinutes??0,averageDurationMinutes:Math.round(r._avg.durationMinutes??0)}}async countEmployeeViolations(e,t,a){return i._.shiftViolation.count({where:{shift:{employeeId:e,startTime:{gte:t,lte:a}},type:{not:d.ViolationType.SHORT_SHIFT}}})}async countEmployeeViolationsByType(e,t,a){let r=await i._.shiftViolation.groupBy({by:["type"],where:{shift:{employeeId:e,startTime:{gte:t,lte:a}},type:{not:d.ViolationType.SHORT_SHIFT}},_count:{_all:!0}}),o=0,n=0;for(let e of r)n+=e._count._all,e.type===d.ViolationType.NOT_CLOSED_IN_TIME&&(o=e._count._all);return{notClosedInTime:o,shortShift:0,total:n}}async groupByEmployeeStats(e,t){return(await i._.shift.groupBy({by:["employeeId"],where:{startTime:{gte:e,lte:t}},_count:{_all:!0},_sum:{durationMinutes:!0},_avg:{durationMinutes:!0}})).map(e=>({employeeId:e.employeeId,totalShifts:e._count._all,totalDurationMinutes:e._sum.durationMinutes??0,averageDurationMinutes:Math.round(e._avg.durationMinutes??0)}))}async countViolationsByEmployee(e,t){return await i._.$queryRaw`
      SELECT s."employeeId" AS "employeeId",
             COUNT(v.*)::int AS "violations"
      FROM "Shift" s
      JOIN "ShiftViolation" v ON v."shiftId" = s."id"
      WHERE s."startTime" >= ${e}
        AND s."startTime" <= ${t}
        AND v."type" <> 'SHORT_SHIFT'
      GROUP BY s."employeeId"
    `}async countViolationsByEmployeeAndType(e,t){return await i._.$queryRaw`
      SELECT s."employeeId" AS "employeeId",
             v."type" AS "type",
             COUNT(v.*)::int AS "count"
      FROM "Shift" s
      JOIN "ShiftViolation" v ON v."shiftId" = s."id"
      WHERE s."startTime" >= ${e}
        AND s."startTime" <= ${t}
        AND v."type" <> 'SHORT_SHIFT'
      GROUP BY s."employeeId", v."type"
    `}async findLastShiftsByEmployee(e,t){return await i._.$queryRaw`
      SELECT DISTINCT ON (s."employeeId")
        s."employeeId" AS "employeeId",
        s."startTime" AS "startTime",
        s."endTime" AS "endTime",
        s."closedReason" AS "closedReason"
      FROM "Shift" s
      WHERE s."startTime" >= ${e}
        AND s."startTime" <= ${t}
      ORDER BY s."employeeId", s."startTime" DESC
    `}}class m{async isAdminUserId(e){return!!await i._.admin.findUnique({where:{telegramUserId:e},select:{id:!0}})}async countAdmins(){return i._.admin.count()}async addAdminUserId(e){await i._.admin.upsert({where:{telegramUserId:e},create:{telegramUserId:e},update:{}})}async getAdminUserIds(){return(await i._.admin.findMany({select:{telegramUserId:!0}})).map(e=>e.telegramUserId)}}class u{async getSession(e){return i._.userSession.findUnique({where:{telegramUserId:e},select:{telegramUserId:!0,mode:!0,nameRequestedAt:!0,fullNameRequestedAt:!0}})}async setSession(e,t){await i._.userSession.upsert({where:{telegramUserId:e},create:{telegramUserId:e,mode:t},update:{mode:t}})}async setNameRequestedAt(e,t=new Date){await i._.userSession.upsert({where:{telegramUserId:e},create:{telegramUserId:e,mode:d.UserMode.EMPLOYEE,nameRequestedAt:t},update:{nameRequestedAt:t}})}async clearNameRequestedAt(e){await i._.userSession.updateMany({where:{telegramUserId:e},data:{nameRequestedAt:null}})}async setFullNameRequestedAt(e,t=new Date){await i._.userSession.upsert({where:{telegramUserId:e},create:{telegramUserId:e,mode:d.UserMode.EMPLOYEE,fullNameRequestedAt:t},update:{fullNameRequestedAt:t}})}async clearFullNameRequestedAt(e){await i._.userSession.updateMany({where:{telegramUserId:e},data:{fullNameRequestedAt:null}})}}class c{async findById(e,t){return(t??i._).pendingAction.findUnique({where:{id:e}})}async findByChatMessage(e,t,a){return(a??i._).pendingAction.findUnique({where:{chatId_photoMessageId:{chatId:e,photoMessageId:t}}})}async hasActiveForUser(e,t){return!!await i._.pendingAction.findFirst({where:{telegramUserId:e,status:d.PendingActionStatus.PENDING,expiresAt:{gt:t}},select:{id:!0}})}async createPendingAction(e,t){return(t??i._).pendingAction.create({data:{employeeId:e.employeeId,telegramUserId:e.telegramUserId,chatId:e.chatId,actionType:e.actionType,photoFileId:e.photoFileId,photoMessageId:e.photoMessageId,createdAt:e.createdAt,expiresAt:e.expiresAt}})}async updateStatus(e,t,a,r){let o=r??i._;return 0===(await o.pendingAction.updateMany({where:{id:e},data:{status:t,updatedAt:a}})).count?null:o.pendingAction.findUnique({where:{id:e}})}async updateStatusIfPending(e,t,a,r){let o=r??i._;return(await o.pendingAction.updateMany({where:{id:e,status:d.PendingActionStatus.PENDING,expiresAt:{gt:t}},data:{status:a,updatedAt:t}})).count}async expirePendingActions(e,t){if(!t)return(await i._.pendingAction.updateMany({where:{status:d.PendingActionStatus.PENDING,expiresAt:{lte:e}},data:{status:d.PendingActionStatus.EXPIRED,updatedAt:e}})).count;let a=await i._.pendingAction.findMany({where:{status:d.PendingActionStatus.PENDING,expiresAt:{lte:e}},select:{id:!0},orderBy:{expiresAt:"asc"},take:t});if(0===a.length)return 0;let r=a.map(e=>e.id);return(await i._.pendingAction.updateMany({where:{id:{in:r},status:d.PendingActionStatus.PENDING},data:{status:d.PendingActionStatus.EXPIRED,updatedAt:e}})).count}}var y=a(2254);class f{constructor(e,t,a,i,r=y.H){this.employeeRepo=e,this.shiftRepo=t,this.config=a,this.logger=i,this.clock=r}async handlePhotoMessage(e){let t=String(e.chatId);if(await this.shiftRepo.isMessageProcessed(t,e.messageId))return this.logger.info({chatId:t,messageId:e.messageId},"Duplicate message ignored"),{type:"duplicate"};let a=await this.employeeRepo.upsertFromTelegram(e.user),i=await this.shiftRepo.findOpenShift(a.id);if(!i)return{type:"started",shift:await this.shiftRepo.createShiftStart({employeeId:a.id,startTime:e.messageDate,startPhotoFileId:e.fileId,startMessageId:e.messageId,startChatId:t}),employee:a};let r=36e5*this.config.maxShiftHours,o=i.startTime.getTime()+r;if(e.messageDate.getTime()>=o){let r=new Date(o),n=60*this.config.maxShiftHours,s=await this.shiftRepo.autoCloseShift(i.id,r,n,e.messageDate),l=await this.shiftRepo.createShiftStart({employeeId:a.id,startTime:e.messageDate,startPhotoFileId:e.fileId,startMessageId:e.messageId,startChatId:t});return s?{type:"autoClosedAndStarted",autoClose:{shift:s,endTime:r,durationMinutes:n},startedShift:l,employee:a}:{type:"started",shift:l,employee:a}}let n=Math.max(0,Math.round((e.messageDate.getTime()-i.startTime.getTime())/6e4));return{type:"closed",shift:await this.shiftRepo.closeShiftByUserPhoto({shiftId:i.id,endTime:e.messageDate,endPhotoFileId:e.fileId,endMessageId:e.messageId,endChatId:t,durationMinutes:n}),employee:a,durationMinutes:n}}async getOpenShiftStatus(e){let t=await this.employeeRepo.findByTelegramUserId(e);return t?this.shiftRepo.findOpenShift(t.id):null}async autoCloseOverdueShifts(e=this.clock.now(),t){let a=36e5*this.config.maxShiftHours,i=new Date(e.getTime()-a),r=await this.shiftRepo.findOverdueShifts(i,t),o=[];for(let t of r){let i=new Date(t.startTime.getTime()+a),r=60*this.config.maxShiftHours,n=await this.shiftRepo.autoCloseShift(t.id,i,r,e);n&&o.push({shift:n,endTime:i,durationMinutes:r})}return o}}class h{constructor(e,t){this.shiftRepo=e,this.employeeRepo=t}buildRange(e,t=new Date){return{from:new Date(t.getTime()-864e5*e),to:t,days:e}}async getEmployeeReport(e,t,a){let i=a instanceof Date?void 0:a,r=a instanceof Date?a:new Date,o="number"==typeof t?this.buildRange(t,r):{from:t.from,to:t.to,days:t.days??Math.max(1,Math.ceil((t.to.getTime()-t.from.getTime())/864e5))},n=await this.employeeRepo.findById(e);if(!n)return null;let s=await this.shiftRepo.aggregateEmployeeStats(e,o.from,o.to),l=await this.shiftRepo.countEmployeeViolationsByType(e,o.from,o.to),p=Math.max(1,Math.floor(i?.pageSize??10)),m=s.totalShifts,u=m>0?Math.ceil(m/p):1,c=Math.min(Math.max(0,i?.page??0),u-1),y=(m>0?await this.shiftRepo.findEmployeeShiftsInRange(e,o.from,o.to,{limit:p,skip:c*p}):[]).map(e=>({startTime:e.startTime,endTime:e.endTime,durationMinutes:e.durationMinutes,closedReason:e.closedReason,violations:e.violations.map(e=>e.type).filter(e=>e!==d.ViolationType.SHORT_SHIFT)}));return{employeeId:n.id,telegramUserId:n.telegramUserId,displayName:n.displayName,period:o,totalShifts:m,totalDurationMinutes:s.totalDurationMinutes,averageDurationMinutes:s.averageDurationMinutes,violationsNotClosedInTime:l.notClosedInTime,violationsShortShift:0,violationsTotal:l.total,summary:{totalShifts:m,totalDurationMinutes:s.totalDurationMinutes,averageDurationMinutes:s.averageDurationMinutes,violationsNotClosedInTime:l.notClosedInTime,violationsShortShift:0,violationsTotal:l.total},shifts:y,page:c,pageSize:p}}async getAllEmployeesReport(e,t=new Date){let a=this.buildRange(e,t),i=await this.shiftRepo.groupByEmployeeStats(a.from,a.to),r=await this.shiftRepo.countViolationsByEmployeeAndType(a.from,a.to),o=await this.shiftRepo.findLastShiftsByEmployee(a.from,a.to),n=await this.employeeRepo.findByIds(i.map(e=>e.employeeId)),s=new Map;for(let e of n)s.set(e.id,{telegramUserId:e.telegramUserId,displayName:e.displayName});let l=new Map;for(let e of r){if(e.type===d.ViolationType.SHORT_SHIFT)continue;let t=l.get(e.employeeId)??{notClosedInTime:0,shortShift:0,total:0};e.type===d.ViolationType.NOT_CLOSED_IN_TIME&&(t.notClosedInTime=e.count),t.total+=e.count,l.set(e.employeeId,t)}let p=new Map;for(let e of o)p.set(e.employeeId,{startTime:e.startTime,endTime:e.endTime,closedReason:e.closedReason});let m=i.map(e=>{let t=s.get(e.employeeId)??{telegramUserId:String(e.employeeId),displayName:`user:${e.employeeId}`},a=p.get(e.employeeId),i=l.get(e.employeeId)??{notClosedInTime:0,shortShift:0,total:0};return{employeeId:e.employeeId,telegramUserId:t.telegramUserId,displayName:t.displayName,totalShifts:e.totalShifts,totalDurationMinutes:e.totalDurationMinutes,averageDurationMinutes:e.averageDurationMinutes,violationsNotClosedInTime:i.notClosedInTime,violationsShortShift:0,violationsTotal:i.total,lastShiftStart:a?.startTime??null,lastShiftEnd:a?.endTime??null,lastShiftClosedReason:a?.closedReason??null}});m.sort((e,t)=>e.displayName.localeCompare(t.displayName,"ru"));let u=[...m].sort((e,t)=>t.violationsTotal!==e.violationsTotal?t.violationsTotal-e.violationsTotal:t.totalDurationMinutes-e.totalDurationMinutes),c=m.length,y=m.reduce((e,t)=>e+t.totalShifts,0),f=m.reduce((e,t)=>e+t.totalDurationMinutes,0);return{period:a,totalEmployees:c,totalShifts:y,totalDurationMinutes:f,violationsNotClosedInTime:m.reduce((e,t)=>e+t.violationsNotClosedInTime,0),violationsShortShift:m.reduce((e,t)=>e+t.violationsShortShift,0),totalViolations:m.reduce((e,t)=>e+t.violationsTotal,0),employees:m,topEmployees:u.slice(0,10)}}async getEmployeeShiftsForExport(e,t,a=new Date){let i=this.buildRange(t,a);return(await this.shiftRepo.findEmployeeShiftsInRange(e,i.from,i.to,{limit:1e4})).map(e=>({startTime:e.startTime,endTime:e.endTime,durationMinutes:e.durationMinutes,closedReason:e.closedReason,violations:e.violations.map(e=>e.type).filter(e=>e!==d.ViolationType.SHORT_SHIFT)}))}async getRawShiftsForExport(e,t=new Date,a=5e3){let i=this.buildRange(e,t),r=await this.shiftRepo.findShiftsInRange(i.from,i.to,{limit:a,order:"asc"});return{period:i,shifts:r.map(e=>({employeeId:e.employeeId,telegramUserId:e.employee.telegramUserId,displayName:e.employee.displayName,startTime:e.startTime,endTime:e.endTime,durationMinutes:e.durationMinutes,closedReason:e.closedReason,violations:e.violations.map(e=>e.type).filter(e=>e!==d.ViolationType.SHORT_SHIFT)}))}}}class g{constructor(e){this.adminRepo=e}async isAdmin(e){return!!r.O.adminUserIds.includes(e)||this.adminRepo.isAdminUserId(e)}async canAssignAdmin(e){return!(await this.adminRepo.countAdmins()>0)&&!(r.O.adminUserIds.length>0)||this.isAdmin(e)}async addAdmin(e){await this.adminRepo.addAdminUserId(e)}async getAdminChatIds(){let e=await this.adminRepo.getAdminUserIds();return Array.from(new Set([r.O.telegramBossChatId,...r.O.adminUserIds,...e]))}}class w{constructor(e,t,a){this.adminService=e,this.employeeRepo=t,this.sessionRepo=a}async resolveRole(e){let t;let a=d.EmployeeRoleOverride||{DEFAULT:"DEFAULT",FORCE_EMPLOYEE:"FORCE_EMPLOYEE",FORCE_ADMIN:"FORCE_ADMIN",BOTH:"BOTH"},i=d.UserMode||{ADMIN:"ADMIN",EMPLOYEE:"EMPLOYEE"},r=await this.adminService.isAdmin(e),o=await this.employeeRepo.findByTelegramUserId(e),n=o?.roleOverride??a.DEFAULT,s=o?.isActive??!1,l=!1;r?(n===a.BOTH||n===a.FORCE_EMPLOYEE)&&(l=s):l=!o||s,n===a.FORCE_ADMIN&&(l=!1);let p=r&&l&&n===a.BOTH;if(p){let a=await this.sessionRepo.getSession(e);t=a?.mode??i.ADMIN}else t=r?i.ADMIN:i.EMPLOYEE;return n===a.FORCE_EMPLOYEE&&l&&(t=i.EMPLOYEE),{userId:e,isAdmin:r,isEmployee:l,isBoth:p,mode:t,employee:o,roleOverride:n}}async setMode(e,t){await this.sessionRepo.setSession(e,t)}shouldProcessPhoto(e){let t=d.UserMode||{ADMIN:"ADMIN",EMPLOYEE:"EMPLOYEE"};return e.isEmployee&&e.mode===t.EMPLOYEE}}var I=a(6751);let S=e=>{if(null==e)return"";let t=String(e);return t.includes("\n")||t.includes(",")||t.includes('"')?`"${t.replace(/"/g,'""')}"`:t},T=e=>e===d.ClosedReason.AUTO_TIMEOUT?"AUTO_TIMEOUT":e===d.ClosedReason.USER_PHOTO?"USER_PHOTO":"",_=e=>e.filter(e=>e!==d.ViolationType.SHORT_SHIFT),E=e=>{let t=0,a=0;for(let i of _(e))a+=1,i===d.ViolationType.NOT_CLOSED_IN_TIME&&(t+=1);return{notClosedInTime:t,total:a}};class N{buildEmployeeReportCsv(e,t){let a=[["employeeId","telegramUserId","displayName","startTime","endTime","durationMinutes","closedReason","notClosedInTimeViolationsCount","totalViolationsCount","violations"],...e.shifts.map(a=>{let i=_(a.violations),r=E(i);return[e.employeeId,e.telegramUserId,e.displayName,(0,I.o0)(a.startTime,t),a.endTime?(0,I.o0)(a.endTime,t):"",a.durationMinutes??"",T(a.closedReason),r.notClosedInTime,r.total,i.join(",")]})].map(e=>e.map(S).join(",")).join("\n");return{filename:`report_${(0,I.TW)(e.period.from,t)}_to_${(0,I.TW)(e.period.to,t)}.csv`,content:Buffer.from(a,"utf-8")}}buildAllEmployeesSummaryCsv(e,t,a){let i=[["employeeId","telegramUserId","displayName","shiftsCount","totalMinutes","avgShiftMinutes","notClosedInTimeViolationsCount","totalViolationsCount","lastShiftStart","lastShiftEnd","lastShiftClosedReason"],...t.map(e=>[e.employeeId,e.telegramUserId,e.displayName,e.totalShifts,e.totalDurationMinutes,e.averageDurationMinutes,e.violationsNotClosedInTime,e.violationsTotal,e.lastShiftStart?(0,I.o0)(e.lastShiftStart,a):"",e.lastShiftEnd?(0,I.o0)(e.lastShiftEnd,a):"",T(e.lastShiftClosedReason??null)])].map(e=>e.map(S).join(",")).join("\n");return{filename:`report_${(0,I.TW)(e.from,a)}_to_${(0,I.TW)(e.to,a)}.csv`,content:Buffer.from(i,"utf-8")}}buildRawShiftsCsv(e,t,a){let i=[["employeeId","telegramUserId","displayName","startTime","endTime","durationMinutes","closedReason","notClosedInTimeViolationsCount","totalViolationsCount","violations"],...t.map(e=>{let t=_(e.violations),i=E(t);return[e.employeeId,e.telegramUserId,e.displayName,(0,I.o0)(e.startTime,a),e.endTime?(0,I.o0)(e.endTime,a):"",e.durationMinutes??"",T(e.closedReason),i.notClosedInTime,i.total,t.join(",")]})].map(e=>e.map(S).join(",")).join("\n");return{filename:`report_raw_${(0,I.TW)(e.from,a)}_to_${(0,I.TW)(e.to,a)}.csv`,content:Buffer.from(i,"utf-8")}}}class M{constructor(e,t,a,i,r,o=y.H){this.employeeRepo=e,this.shiftRepo=t,this.pendingRepo=a,this.config=i,this.runInTransaction=r,this.clock=o}async createFromPhoto(e){let t=String(e.chatId);if(await this.shiftRepo.isMessageProcessed(t,e.messageId)||await this.pendingRepo.findByChatMessage(t,e.messageId))return{type:"duplicate"};let a=await this.employeeRepo.upsertFromTelegram(e.user),i=await this.shiftRepo.findOpenShift(a.id),r=36e5*this.config.maxShiftHours,o=!!i&&e.messageDate.getTime()>=i.startTime.getTime()+r,n=!i||o?d.PendingActionType.START:d.PendingActionType.END,s=e.messageDate,l=new Date(s.getTime()+6e4*this.config.ttlMinutes);return{type:"pending",pendingAction:await this.pendingRepo.createPendingAction({employeeId:a.id,telegramUserId:a.telegramUserId,chatId:t,actionType:n,photoFileId:e.fileId,photoMessageId:e.messageId,createdAt:s,expiresAt:l}),actionType:n,employee:a}}async confirmAction(e,t,a=this.clock.now()){return this.runInTransaction(async i=>{let r=await this.pendingRepo.findById(e,i);if(!r)return{type:"not_found"};if(r.telegramUserId!==t)return{type:"forbidden"};if(r.status!==d.PendingActionStatus.PENDING)return{type:"already_handled",status:r.status};if(r.expiresAt<=a)return await this.pendingRepo.updateStatus(r.id,d.PendingActionStatus.EXPIRED,a,i),{type:"expired"};if(0===await this.pendingRepo.updateStatusIfPending(r.id,a,d.PendingActionStatus.CONFIRMED,i)){let e=await this.pendingRepo.findById(r.id,i);return e&&e.status===d.PendingActionStatus.PENDING&&e.expiresAt<=a?(await this.pendingRepo.updateStatus(e.id,d.PendingActionStatus.EXPIRED,a,i),{type:"expired"}):e?{type:"already_handled",status:e.status}:{type:"not_found"}}let o=await this.employeeRepo.findById(r.employeeId);if(!o)return await this.pendingRepo.updateStatus(r.id,d.PendingActionStatus.CANCELLED,a,i),{type:"not_found"};let n=r.createdAt,s=36e5*this.config.maxShiftHours;if(r.actionType===d.PendingActionType.START){let e=await this.shiftRepo.findOpenShift(o.id,i),t=null;if(e){if(!(n.getTime()>=e.startTime.getTime()+s))return await this.pendingRepo.updateStatus(r.id,d.PendingActionStatus.CANCELLED,a,i),{type:"open_shift_exists"};let o=new Date(e.startTime.getTime()+s),l=60*this.config.maxShiftHours;if(!(t=await this.shiftRepo.autoCloseShift(e.id,o,l,a,i)))return await this.pendingRepo.updateStatus(r.id,d.PendingActionStatus.CANCELLED,a,i),{type:"open_shift_exists"}}return{type:"confirmed_start",shift:await this.shiftRepo.createShiftStart({employeeId:o.id,startTime:n,startPhotoFileId:r.photoFileId,startMessageId:r.photoMessageId,startChatId:r.chatId},i),employee:o,autoClose:t}}let l=await this.shiftRepo.findOpenShift(o.id,i);if(!l)return await this.pendingRepo.updateStatus(r.id,d.PendingActionStatus.CANCELLED,a,i),{type:"no_open_shift"};if(n.getTime()>=l.startTime.getTime()+s){let e=new Date(l.startTime.getTime()+s),t=60*this.config.maxShiftHours,o=await this.shiftRepo.autoCloseShift(l.id,e,t,a,i);return o?{type:"auto_closed",autoClose:o}:(await this.pendingRepo.updateStatus(r.id,d.PendingActionStatus.CANCELLED,a,i),{type:"no_open_shift"})}let p=Math.max(0,Math.round((n.getTime()-l.startTime.getTime())/6e4));return{type:"confirmed_end",shift:await this.shiftRepo.closeShiftByUserPhoto({shiftId:l.id,endTime:n,endPhotoFileId:r.photoFileId,endMessageId:r.photoMessageId,endChatId:r.chatId,durationMinutes:p},i),employee:o,durationMinutes:p}})}async cancelAction(e,t,a=this.clock.now()){return this.runInTransaction(async i=>{let r=await this.pendingRepo.findById(e,i);if(!r)return{type:"not_found"};if(r.telegramUserId!==t)return{type:"forbidden"};if(r.status!==d.PendingActionStatus.PENDING)return{type:"already_handled",status:r.status};if(r.expiresAt<=a)return await this.pendingRepo.updateStatus(r.id,d.PendingActionStatus.EXPIRED,a,i),{type:"expired"};if(0===await this.pendingRepo.updateStatusIfPending(r.id,a,d.PendingActionStatus.CANCELLED,i)){let e=await this.pendingRepo.findById(r.id,i);return e&&e.status===d.PendingActionStatus.PENDING&&e.expiresAt<=a?(await this.pendingRepo.updateStatus(e.id,d.PendingActionStatus.EXPIRED,a,i),{type:"expired"}):e?{type:"already_handled",status:e.status}:{type:"not_found"}}return{type:"cancelled"}})}async expirePendingActions(e=this.clock.now(),t){return this.pendingRepo.expirePendingActions(e,t)}async hasActivePendingAction(e,t=this.clock.now()){return this.pendingRepo.hasActiveForUser(e,t)}}var A=a(3555),R=a.n(A),b=a(4799),O=a.n(b),C=a(8466),v=a.n(C);R().extend(O()),R().extend(v());class k{constructor(e){this.shiftRepo=e}buildRange(e,t,a=new Date){let i=R()(a).tz(t);if("today"===e)return{key:e,from:i.startOf("day").toDate(),to:a,label:"–°–µ–≥–æ–¥–Ω—è"};if("yesterday"===e){let t=i.subtract(1,"day").startOf("day"),a=i.startOf("day");return{key:e,from:t.toDate(),to:a.toDate(),label:"–í—á–µ—Ä–∞"}}return{key:e,from:i.subtract(3,"day").toDate(),to:a,label:"–ü–æ—Å–ª–µ–¥–Ω–∏–µ 3 –¥–Ω—è"}}async listEmployeeShifts(e,t,a){return(await this.shiftRepo.findEmployeeShiftsInRange(e,t.from,t.to,{limit:a})).map(e=>({id:e.id,startTime:e.startTime,endTime:e.endTime,closedReason:e.closedReason,violations:e.violations.map(e=>e.type)}))}async getShiftDetails(e){return this.shiftRepo.findShiftById(e)}}var D=a(2161),$=a(3406);let P=D.Markup.keyboard([["–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏","–û—Ç—á—ë—Ç"],["–û—à–∏–±–∫–∏","–ü–æ–º–æ—â—å"]]).resize(),U=D.Markup.keyboard([["–°—Ç–∞—Ç—É—Å"],["–ü–æ–º–æ—â—å"]]).resize(),F=D.Markup.keyboard([["–†–µ–∂–∏–º: –ê–¥–º–∏–Ω","–†–µ–∂–∏–º: –°–æ—Ç—Ä—É–¥–Ω–∏–∫"]]).resize(),B=D.Markup.inlineKeyboard([[D.Markup.button.callback("–ê–¥–º–∏–Ω —Ä–µ–∂–∏–º","mode:ADMIN"),D.Markup.button.callback("–†–µ–∂–∏–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞","mode:EMPLOYEE")]]),x=/^[\p{Script=Latin}\p{Script=Cyrillic}]+(?:-[\p{Script=Latin}\p{Script=Cyrillic}]+)*$/u,L=e=>!e||0===e.trim().length,H=e=>{if(!e)return!1;let t=e.trim();if(0===t.length)return!1;let a=t.split(/\s+/);return!(a.length<2)&&a.every(e=>x.test(e))},q=e=>{let t=e.trim().replace(/\s+/g," ");if(0===t.length)return null;let a=t.split(" ");if(a.length<2||!a.every(e=>x.test(e)))return null;let[i,...r]=a,o=r.join(" "),n=`${i} ${o}`;return{firstName:i,lastName:o,displayName:n}},Q=e=>!!e&&(!(L(e.firstName)||L(e.lastName))||H(e.displayName)),Y=(e,t,a,i)=>{e.start(async e=>{await e.reply("‚úÖ DEBUG: /start reached");let r=e.from;if(!r)return;let o=String(r.id),n=await t.resolveRole(o);if(n.isBoth){await e.reply($.s.startBoth,F);return}if("ADMIN"===n.mode){await e.reply($.s.startAdmin,P);return}let s=e.chat?.id??r.id;if(!Q(await a.upsertFromTelegram({id:r.id,username:r.username,firstName:r.first_name,lastName:r.last_name,chatId:s}))){await e.reply($.s.namePrompt),await i.setNameRequestedAt(o);return}await i.clearNameRequestedAt(o),await e.reply($.s.startEmployee,U)})},z=(e,t,a)=>{let i=async(e,i)=>{let o=await a.resolveRole(e);if(!o.isEmployee||"EMPLOYEE"!==o.mode){await i($.s.notEmployee);return}let n=await t.getOpenShiftStatus(e);if(!n){await i($.s.noOpenShift);return}let s=(0,I.mr)(n.startTime,r.O.timezone);await i($.s.openShift(s))};e.command("status",async e=>{let t=e.from?.id;t&&await i(String(t),t=>e.reply(t))}),e.hears("–°—Ç–∞—Ç—É—Å",async e=>{let t=e.from?.id;t&&await i(String(t),t=>e.reply(t))})},V=e=>async(t,a)=>{let i=t.from?.id;if(t.chat?.id&&i){if(!await e.isAdmin(String(i))){await t.reply($.s.noAccess);return}return a()}},G=e=>encodeURIComponent(e),j=e=>{let t=e.employees.map(t=>{let a=t.displayName||t.username||t.telegramUserId,i=`emp_select:${t.id}:${e.page}:${G(e.query??"")}`;return[D.Markup.button.callback(a,i)]}),a=[D.Markup.button.callback("‚óÄÔ∏è",`emp_page:${Math.max(1,e.page-1)}:${G(e.query??"")}`),D.Markup.button.callback("‚ñ∂Ô∏è",`emp_page:${Math.min(e.totalPages,e.page+1)}:${G(e.query??"")}`)],i=[D.Markup.button.callback("–ü–æ–∏—Å–∫","emp_search"),D.Markup.button.callback("–ù–∞–∑–∞–¥","emp_back")];return D.Markup.inlineKeyboard([...t,a,i])},K=e=>{let t=G(e.query??"");return D.Markup.inlineKeyboard([[D.Markup.button.callback("–û—Ç—á—ë—Ç",`emp_action:report:${e.employeeId}:${e.page}:${t}`)],[D.Markup.button.callback("–§–æ—Ç–æ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –¥–Ω—è)",`emp_action:photos:${e.employeeId}:${e.page}:${t}`)],[D.Markup.button.callback("–ù–∞–∑–∞–¥",`emp_page:${e.page}:${t}`)]])},W=e=>{let t=G(e.query??""),a=e.backAction??`emp_page:${e.backPage}:${t}`;return D.Markup.inlineKeyboard([[D.Markup.button.callback("–ó–∞ 3 –¥–Ω—è",`period_emp:3:${e.employeeId}`),D.Markup.button.callback("–ó–∞ 7 –¥–Ω–µ–π",`period_emp:7:${e.employeeId}`)],[D.Markup.button.callback("–ó–∞ 30 –¥–Ω–µ–π",`period_emp:30:${e.employeeId}`)],[D.Markup.button.callback("–ù–∞–∑–∞–¥",a)]])},Z=e=>{let t=G(e.query??"");return D.Markup.inlineKeyboard([[D.Markup.button.callback("–°–µ–≥–æ–¥–Ω—è",`emp_photo_period:today:${e.employeeId}:${e.page}:${t}`),D.Markup.button.callback("–í—á–µ—Ä–∞",`emp_photo_period:yesterday:${e.employeeId}:${e.page}:${t}`)],[D.Markup.button.callback("–ü–æ—Å–ª–µ–¥–Ω–∏–µ 3 –¥–Ω—è",`emp_photo_period:last3:${e.employeeId}:${e.page}:${t}`)],[D.Markup.button.callback("–ù–∞–∑–∞–¥",`emp_action:menu:${e.employeeId}:${e.page}:${t}`)]])},X=e=>{let t=G(e.query??""),a=e.shifts.map(e=>[D.Markup.button.callback(e.label,`emp_photo_shift:${e.id}`)]);return a.push([D.Markup.button.callback("–ù–∞–∑–∞–¥",`emp_action:photos:${e.employeeId}:${e.page}:${t}`)]),D.Markup.inlineKeyboard(a)},J=()=>D.Markup.inlineKeyboard([[D.Markup.button.callback("–ó–∞ 3 –¥–Ω—è","period_all:3"),D.Markup.button.callback("–ó–∞ 7 –¥–Ω–µ–π","period_all:7")],[D.Markup.button.callback("–ó–∞ 30 –¥–Ω–µ–π","period_all:30")]]),ee=e=>{let t=[],a=e.totalShifts>e.pageSize,i=a&&e.page>0,r=a&&(e.page+1)*e.pageSize<e.totalShifts;return i&&t.push(D.Markup.button.callback("‚¨ÖÔ∏è –ù–∞–∑–∞–¥",`emp_rep:${e.employeeId}:${e.days}:${e.page-1}`)),r&&t.push(D.Markup.button.callback("‚û°Ô∏è –î–∞–ª–µ–µ",`emp_rep:${e.employeeId}:${e.days}:${e.page+1}`)),t.push(D.Markup.button.callback("\uD83D\uDCC4 –≠–∫—Å–ø–æ—Ä—Ç",`emp_rep_export:${e.employeeId}:${e.days}`)),D.Markup.inlineKeyboard([t])},et=e=>D.Markup.inlineKeyboard([[D.Markup.button.callback("–≠–∫—Å–ø–æ—Ä—Ç CSV",`export_all:csv:${e}`),D.Markup.button.callback("–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏","emp_page:1:")]]),ea=e=>`${Math.floor(e/60)} —á ${e%60} –º–∏–Ω`,ei={NOT_CLOSED_IN_TIME:"–ù–µ –∑–∞–∫—Ä—ã–ª(–∞) —Å–º–µ–Ω—É –≤–æ–≤—Ä–µ–º—è"},er=e=>e.filter(e=>e!==d.ViolationType.SHORT_SHIFT),eo=e=>{let t=er(e);if(0===t.length)return"–Ω–µ—Ç";let a=t.map(e=>ei[e]??String(e)).join(", ");return`${a} ‚ö†Ô∏è`},en=e=>{let t=er(e);return 0===t.length?"–ù–∞—Ä—É—à–µ–Ω–∏—è: –Ω–µ—Ç":`–ù–∞—Ä—É—à–µ–Ω–∏—è: –µ—Å—Ç—å (${t.length}) ‚ö†Ô∏è`},es=e=>e===d.ClosedReason.AUTO_TIMEOUT?"–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (12 —á–∞—Å–æ–≤)":e===d.ClosedReason.USER_PHOTO?"–§–æ—Ç–æ":"‚Äî",el=(e,t)=>{let a=[];if(a.push("–û—Ç—á—ë—Ç –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É"),a.push(`–°–æ—Ç—Ä—É–¥–Ω–∏–∫: ${e.displayName}`),a.push(`–ü–µ—Ä–∏–æ–¥: ${(0,I.p6)(e.period.from,t)} ‚Äì ${(0,I.p6)(e.period.to,t)}`),a.push(`–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–º–µ–Ω: ${e.totalShifts}`),a.push(`–°—É–º–º–∞—Ä–Ω–æ–µ –≤—Ä–µ–º—è: ${ea(e.totalDurationMinutes)}`),a.push(`–°—Ä–µ–¥–Ω—è—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–º–µ–Ω—ã: ${ea(e.averageDurationMinutes)}`),a.push("–ù–∞—Ä—É—à–µ–Ω–∏—è:"),a.push(`- –ù–µ –∑–∞–∫—Ä—ã–ª(–∞) —Å–º–µ–Ω—É –≤–æ–≤—Ä–µ–º—è: ${e.violationsNotClosedInTime}`),a.push(`- –í—Å–µ–≥–æ –Ω–∞—Ä—É—à–µ–Ω–∏–π: ${e.violationsTotal}`),0===e.shifts.length)return a.push(""),a.push($.s.reportEmpty),a.join("\n");a.push("");let i=e.pageSize||e.shifts.length||10,r=e.page??0,o=e.totalShifts,n=0===o?0:Math.min(o,r*i+e.shifts.length);for(let s of(o<=i?a.push("–°–º–µ–Ω—ã:"):a.push(`–°–º–µ–Ω—ã (–ø–æ–∫–∞–∑–∞–Ω—ã ${0===o?0:r*i+1}-${n} –∏–∑ ${o}):`),e.shifts)){let e=(0,I.p6)(s.startTime,t),i=(0,I.mr)(s.startTime,t);if(!s.endTime){a.push(`- ${e} –û—Ç–∫—Ä—ã—Ç–∞ —Å ${i} | –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ‚Äî | –ó–∞–∫—Ä—ã—Ç–∏–µ: ‚Äî | –ù–∞—Ä—É—à–µ–Ω–∏—è: ‚Äî`);continue}let r=(0,I.mr)(s.endTime,t),o=null!=s.durationMinutes?ea(s.durationMinutes):"‚Äî",n=es(s.closedReason),l=eo(s.violations);a.push(`- ${e} ${i}‚Äì${r} | –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${o} | –ó–∞–∫—Ä—ã—Ç–∏–µ: ${n} | –ù–∞—Ä—É—à–µ–Ω–∏—è: ${l}`)}return a.join("\n")},ed=(e,t)=>{let a=[];if(a.push("–°–≤–æ–¥–Ω—ã–π –æ—Ç—á—ë—Ç"),a.push(`–ü–µ—Ä–∏–æ–¥: ${(0,I.p6)(e.period.from,t)} ‚Äì ${(0,I.p6)(e.period.to,t)}`),a.push(`–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ –æ—Ç—á—ë—Ç–µ: ${e.totalEmployees}`),a.push(`–í—Å–µ–≥–æ —Å–º–µ–Ω: ${e.totalShifts}`),a.push(`–°—É–º–º–∞—Ä–Ω–æ–µ –≤—Ä–µ–º—è: ${ea(e.totalDurationMinutes)}`),a.push("–ù–∞—Ä—É—à–µ–Ω–∏—è:"),a.push(`- –ù–µ –∑–∞–∫—Ä—ã–ª(–∞) –≤–æ–≤—Ä–µ–º—è: ${e.violationsNotClosedInTime}`),a.push(`- –í—Å–µ–≥–æ –Ω–∞—Ä—É—à–µ–Ω–∏–π: ${e.totalViolations}`),0===e.topEmployees.length)return a.push(""),a.push($.s.reportEmpty),a.join("\n");for(let t of(a.push(""),a.push("–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ (—Ç–æ–ø –ø–æ –Ω–∞—Ä—É—à–µ–Ω–∏—è–º, –∑–∞—Ç–µ–º –ø–æ —á–∞—Å–∞–º):"),e.topEmployees))a.push(`- ${t.displayName} ‚Äî —Å–º–µ–Ω: ${t.totalShifts}, –≤—Ä–µ–º—è: ${ea(t.totalDurationMinutes)}, –Ω–∞—Ä—É—à: ${t.violationsTotal} (–Ω–µ –∑–∞–∫—Ä—ã–ª: ${t.violationsNotClosedInTime})`);return a.join("\n")},ep=e=>{let t=e.trim().split(" ");return t.length<=1?"":t.slice(1).join(" ").trim().slice(0,30)},em=e=>{let t=e.split(":"),a=Number(t[1]??"1"),i=decodeURIComponent(t[2]??"");return{page:Number.isFinite(a)&&a>0?a:1,query:i}},eu=e=>{let t=e.split(":"),a=Number(t[1]??"0"),i=Number(t[2]??"1"),r=decodeURIComponent(t[3]??"");return{employeeId:Number.isFinite(a)?a:0,page:Number.isFinite(i)&&i>0?i:1,query:r}},ec=e=>{let t=e.split(":"),a=t[1]??"",i=Number(t[2]??"0"),r=Number(t[3]??"1"),o=decodeURIComponent(t[4]??"");return{action:a,employeeId:Number.isFinite(i)?i:0,page:Number.isFinite(r)&&r>0?r:1,query:o}},ey=e=>{let t=e.split(":"),a=Number(t[1]??"0"),i=Number(t[2]??"0");return{days:Number.isFinite(a)?a:0,employeeId:Number.isFinite(i)?i:0}},ef=e=>{let t=e.split(":"),a=t[1]??"last3",i=Number(t[2]??"0"),r=Number(t[3]??"1"),o=decodeURIComponent(t[4]??"");return{range:a,employeeId:Number.isFinite(i)?i:0,page:Number.isFinite(r)&&r>0?r:1,query:o}},eh=e=>{let t=(0,I.yD)(e.startTime,e.timezone),a="AUTO_TIMEOUT"===e.closedReason?"–ê–≤—Ç–æ12—á":"USER_PHOTO"===e.closedReason?"–§–æ—Ç–æ":"–û—Ç–∫—Ä—ã—Ç–∞",i=en(e.violations);return`${t} ‚Äî ${a} ‚Äî ${i}`},eg=(e,t,a,i,n,s)=>{let l=V(t),d=async(e,t)=>{let{items:i,total:r}=await a.listEmployees({page:t.page,pageSize:8,query:t.query}),o=Math.max(1,Math.ceil(r/8));if(0===r){await e.reply($.s.noEmployeesFound);return}let n=t.query?`${$.s.employeesChoosePrompt}
–ü–æ–∏—Å–∫: ${t.query}`:$.s.employeesChoosePrompt;await e.reply(n,j({employees:i,page:Math.min(t.page,o),totalPages:o,query:t.query}))},p=async(e,t)=>{let i=await a.findById(t.employeeId);if(!i){await e.reply($.s.noEmployeesFound);return}await e.reply($.s.employeeActionPrompt(i.displayName),K({employeeId:i.id,page:t.page,query:t.query}))};e.command("employees",l,async e=>{let t=ep("text"in e.message?e.message.text:"");await d(e,{page:1,query:t})}),e.hears("–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏",l,async e=>{await d(e,{page:1,query:""})}),e.action(/^emp_page:/,l,async e=>{await e.answerCbQuery();let{page:t,query:a}=em("data"in e.callbackQuery?e.callbackQuery.data:"");await d(e,{page:t,query:a})}),e.action(/^emp_select:/,l,async e=>{await e.answerCbQuery();let t=eu("data"in e.callbackQuery?e.callbackQuery.data:"");if(!t.employeeId){await e.reply($.s.noEmployeesFound);return}await p(e,{employeeId:t.employeeId,page:t.page,query:t.query})}),e.action(/^emp_action:/,l,async e=>{await e.answerCbQuery();let t=ec("data"in e.callbackQuery?e.callbackQuery.data:"");if(!t.employeeId){await e.reply($.s.noEmployeesFound);return}if("menu"===t.action){await p(e,{employeeId:t.employeeId,page:t.page,query:t.query});return}let i=await a.findById(t.employeeId);if(!i){await e.reply($.s.noEmployeesFound);return}if("report"===t.action){await e.reply($.s.employeePeriodPrompt(i.displayName),W({employeeId:t.employeeId,backPage:t.page,query:t.query,backAction:`emp_action:menu:${t.employeeId}:${t.page}:${encodeURIComponent(t.query)}`}));return}"photos"===t.action&&await e.reply($.s.photoPeriodPrompt(i.displayName),Z({employeeId:t.employeeId,page:t.page,query:t.query}))}),e.action(/^emp_search$/,l,async e=>{await e.answerCbQuery(),await e.reply($.s.searchHint)}),e.action(/^emp_back$/,l,async e=>{await e.answerCbQuery(),await e.reply($.s.startAdmin,P)}),e.action(/^period_emp:/,l,async e=>{await e.answerCbQuery();let{days:t,employeeId:a}=ey("data"in e.callbackQuery?e.callbackQuery.data:"");if(t&&a)try{let o=await i.getEmployeeReport(a,t,{page:0,pageSize:10});if(!o){await e.reply($.s.noEmployeesFound);return}let n=el(o,r.O.timezone),s=ee({employeeId:a,days:t,page:o.page,pageSize:o.pageSize,totalShifts:o.totalShifts});await e.reply(n,s)}catch(t){o.k.error({err:t},"Failed to build employee report"),await e.reply("–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")}}),e.action(/^emp_rep:/,l,async e=>{await e.answerCbQuery();let t=("data"in e.callbackQuery?e.callbackQuery.data:"").split(":"),a=Number(t[1]??"0"),n=Number(t[2]??"0"),s=Number(t[3]??"0");if(!a||!n||!Number.isFinite(s)){await e.reply("–î–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏. –°—Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ –æ—Ç—á—ë—Ç –∑–∞–Ω–æ–≤–æ.");return}try{let t=await i.getEmployeeReport(a,n,{page:s,pageSize:10});if(!t){await e.reply("–î–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏. –°—Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ –æ—Ç—á—ë—Ç –∑–∞–Ω–æ–≤–æ.");return}let l=el(t,r.O.timezone),d=ee({employeeId:a,days:n,page:t.page,pageSize:t.pageSize,totalShifts:t.totalShifts});try{await e.editMessageText(l,d)}catch(t){o.k.warn({err:t},"Failed to edit employee report message"),await e.reply("–î–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏. –°—Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ –æ—Ç—á—ë—Ç –∑–∞–Ω–æ–≤–æ.")}}catch(t){o.k.error({err:t},"Failed to paginate employee report"),await e.reply("–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")}}),e.action(/^emp_photo_period:/,l,async e=>{await e.answerCbQuery();let t=ef("data"in e.callbackQuery?e.callbackQuery.data:"");if(t.employeeId&&t.range)try{let i=await a.findById(t.employeeId);if(!i){await e.reply($.s.noEmployeesFound);return}let o=s.buildRange(t.range,r.O.timezone,new Date),n=await s.listEmployeeShifts(i.id,o,10);if(0===n.length){await e.reply($.s.photoShiftsEmpty);return}let l=n.map(e=>({id:e.id,label:eh({startTime:e.startTime,closedReason:e.closedReason,violations:e.violations,timezone:r.O.timezone})}));await e.reply(`–§–æ—Ç–æ: ${o.label}. –í—ã–±–µ—Ä–∏—Ç–µ —Å–º–µ–Ω—É:`,X({shifts:l,employeeId:i.id,page:t.page,query:t.query}))}catch(t){o.k.error({err:t},"Failed to build photo shift list"),await e.reply("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–º–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")}}),e.action(/^emp_photo_shift:/,l,async e=>{await e.answerCbQuery();let t=Number(("data"in e.callbackQuery?e.callbackQuery.data:"").split(":")[1]??"0");if(t)try{let a=await s.getShiftDetails(t);if(!a){await e.reply($.s.shiftNotFound);return}let i=new Date(Date.now()-864e5*r.O.photoRetentionDays),o=!!a.photosPurgedAt||a.startTime<i,n=o?null:a.startPhotoFileId,l=o?null:a.endPhotoFileId,d=(0,I.o0)(a.startTime,r.O.timezone),p=a.endTime?(0,I.o0)(a.endTime,r.O.timezone):"–û—Ç–∫—Ä—ã—Ç–∞",m=null!=a.durationMinutes?ea(a.durationMinutes):"‚Äî",u="AUTO_TIMEOUT"===a.closedReason?"–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (12 —á–∞—Å–æ–≤)":"USER_PHOTO"===a.closedReason?"–§–æ—Ç–æ":"‚Äî",c=a.violations.map(e=>e.type),y=a.endTime?eo(c):"‚Äî";if(await e.reply(`–°–º–µ–Ω–∞: –¥–µ—Ç–∞–ª–∏
–°–æ—Ç—Ä—É–¥–Ω–∏–∫: ${a.employee.displayName}
–ü–µ—Ä–∏–æ–¥: ${d} ‚Äì ${p}
–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${m}
–°–ø–æ—Å–æ–± –∑–∞–∫—Ä—ã—Ç–∏—è: ${u}
–ù–∞—Ä—É—à–µ–Ω–∏—è: ${y}`),n?await e.replyWithPhoto(n,{caption:"–§–æ—Ç–æ –Ω–∞—á–∞–ª–∞ —Å–º–µ–Ω—ã"}):await e.reply($.s.photoStartMissing),!a.endTime){await e.reply($.s.photoEndNotClosed);return}if(l){await e.replyWithPhoto(l,{caption:"–§–æ—Ç–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–º–µ–Ω—ã"});return}if("AUTO_TIMEOUT"===a.closedReason){await e.reply($.s.photoEndAutoClosed);return}await e.reply($.s.photoEndMissing)}catch(t){o.k.error({err:t},"Failed to send shift photos"),await e.reply("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ —Å–º–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")}}),e.action(/^export_emp:/,l,async e=>{await e.answerCbQuery();let t=("data"in e.callbackQuery?e.callbackQuery.data:"").split(":"),a=t[1],s=Number(t[2]??"0"),l=Number(t[3]??"0");if("csv"===a&&s&&l)try{let t=await i.getEmployeeReport(l,s);if(!t){await e.reply($.s.noEmployeesFound);return}let a=await i.getEmployeeShiftsForExport(l,s),o={...t,shifts:a},d=n.buildEmployeeReportCsv(o,r.O.timezone);await e.replyWithDocument({source:d.content,filename:d.filename})}catch(t){o.k.error({err:t},"Failed to export employee report"),await e.reply("–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")}}),e.action(/^emp_rep_export:/,l,async e=>{await e.answerCbQuery();let t=("data"in e.callbackQuery?e.callbackQuery.data:"").split(":"),a=Number(t[1]??"0"),s=Number(t[2]??"0");if(!a||!s){await e.reply("–î–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏. –°—Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ –æ—Ç—á—ë—Ç –∑–∞–Ω–æ–≤–æ.");return}try{let t=await i.getEmployeeReport(a,s);if(!t){await e.reply($.s.noEmployeesFound);return}let o=await i.getEmployeeShiftsForExport(a,s),l={...t,shifts:o},d=n.buildEmployeeReportCsv(l,r.O.timezone);await e.replyWithDocument({source:d.content,filename:d.filename})}catch(t){o.k.error({err:t},"Failed to export employee report"),await e.reply("–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")}})},ew=(e,t=4e3)=>{if(e.length<=t)return[e];let a=e.split("\n"),i=[],r="";for(let e of a){let a=r?`${r}
${e}`:e;a.length>t?r?(i.push(r),r=e):(i.push(e.slice(0,t)),r=e.slice(t)):r=a}return r&&i.push(r),i},eI=e=>{let t=Number(e.split(":")[1]??"0");return Number.isFinite(t)?t:0},eS=(e,t,a,i)=>{let n=V(t),s=async e=>{await e.reply($.s.reportAllPrompt,J())};e.command("report",n,async e=>{await s(e)}),e.hears("–û—Ç—á—ë—Ç",n,async e=>{await s(e)}),e.action(/^period_all:/,n,async e=>{await e.answerCbQuery();let t=eI("data"in e.callbackQuery?e.callbackQuery.data:"");if(t)try{let i=await a.getAllEmployeesReport(t),o=ed(i,r.O.timezone);for(let t of ew(o))await e.reply(t);await e.reply("–≠–∫—Å–ø–æ—Ä—Ç:",et(t))}catch(t){o.k.error({err:t},"Failed to build all employees report"),await e.reply("–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")}}),e.action(/^export_all:/,n,async e=>{await e.answerCbQuery();let t=("data"in e.callbackQuery?e.callbackQuery.data:"").split(":"),n=t[1],s=Number(t[2]??"0");if("csv"===n&&s)try{let t=await a.getAllEmployeesReport(s),o=i.buildAllEmployeesSummaryCsv(t.period,t.employees,r.O.timezone);await e.replyWithDocument({source:o.content,filename:o.filename});let n=await a.getRawShiftsForExport(s,new Date,2e3);if(n.shifts.length>0&&n.shifts.length<2e3){let t=i.buildRawShiftsCsv(n.period,n.shifts,r.O.timezone);await e.replyWithDocument({source:t.content,filename:t.filename})}else n.shifts.length>=2e3&&await e.reply($.s.exportSkipped)}catch(t){o.k.error({err:t},"Failed to export all employees report"),await e.reply("–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")}})},eT=e=>D.Markup.inlineKeyboard([[D.Markup.button.callback("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å",`pending_confirm:${e}`),D.Markup.button.callback("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å",`pending_cancel:${e}`)]]),e_=(e,t,a)=>{e.on("photo",async e=>{let i=e.from,r=e.chat,n=e.message;if(!i||!r||!n||!("photo"in n))return;let s=n.photo;if(!s||0===s.length)return;let l=s[s.length-1].file_id,p=new Date(1e3*n.date),m=await t.resolveRole(String(i.id));if(!t.shouldProcessPhoto(m)){"ADMIN"===m.mode?await e.reply($.s.adminPhotoIgnored):await e.reply($.s.notEmployee);return}try{let t=await a.createFromPhoto({user:{id:i.id,username:i.username,firstName:i.first_name,lastName:i.last_name,chatId:r.id},messageId:n.message_id,chatId:r.id,fileId:l,messageDate:p});if("duplicate"===t.type)return;let o=t.actionType===d.PendingActionType.START?$.s.confirmStartPrompt:$.s.confirmEndPrompt;await e.reply(o,eT(t.pendingAction.id))}catch(t){o.k.error({err:t},"Failed to create pending action"),await e.reply("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–æ—Ç–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")}}),e.catch((e,t)=>{let a=t.update;o.k.error({err:e,updateId:a?.update_id,updateType:t.updateType,chatId:t.chat?.id,fromId:t.from?.id,messageId:a?.message?.message_id,callbackData:a?.callback_query?.data},"Bot error")})};var eE=a(7388);let eN=e=>{let t=Number(e.split(":")[1]??"0");return Number.isFinite(t)?t:0},eM=(e,t,a)=>{e.action(/^pending_confirm:/,async i=>{await i.answerCbQuery();let n=eN("data"in i.callbackQuery?i.callbackQuery.data:""),s=i.from?.id;if(n&&s)try{let o=await t.confirmAction(n,String(s)),l=await a.getAdminChatIds();if("confirmed_start"===o.type){if(o.autoClose){let t=(0,I.mr)(o.autoClose.endTime??new Date,r.O.timezone),a=$.s.autoClosedBoss(o.employee.displayName,t,r.O.maxShiftHours);for(let t of l)await (0,eE.g)(e.telegram,t,a);r.O.notifyEmployeeOnAutoClose&&await (0,eE.g)(e.telegram,o.employee.telegramUserId,$.s.autoClosedEmployee(r.O.maxShiftHours))}let t=(0,I.mr)(o.shift.startTime,r.O.timezone);await i.reply($.s.shiftStarted(t));let a=$.s.bossShiftStarted(o.employee.displayName,t);for(let t of l)await (0,eE.g)(e.telegram,t,a);return}if("confirmed_end"===o.type){let t=(0,I.mr)(o.shift.endTime??new Date,r.O.timezone),a=ea(o.durationMinutes);await i.reply($.s.shiftClosed(t,a));let n=$.s.bossShiftClosed(o.employee.displayName,a);for(let t of l)await (0,eE.g)(e.telegram,t,n);return}if("auto_closed"===o.type){let t=(0,I.mr)(o.autoClose.endTime??new Date,r.O.timezone),a=$.s.autoClosedBoss(o.autoClose.employee.displayName,t,r.O.maxShiftHours);for(let t of l)await (0,eE.g)(e.telegram,t,a);r.O.notifyEmployeeOnAutoClose?await i.reply($.s.autoClosedEmployee(r.O.maxShiftHours)):await i.reply($.s.alreadyClosed);return}if("open_shift_exists"===o.type){await i.reply($.s.openShiftExists);return}if("no_open_shift"===o.type){await i.reply($.s.alreadyClosed);return}if("expired"===o.type){await i.reply($.s.pendingExpired);return}if("already_handled"===o.type){await i.reply($.s.pendingAlreadyHandled);return}if("forbidden"===o.type){await i.reply($.s.noAccess);return}"not_found"===o.type&&await i.reply($.s.pendingNotFound)}catch(e){o.k.error({err:e},"Failed to confirm pending action"),await i.reply("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")}}),e.action(/^pending_cancel:/,async e=>{await e.answerCbQuery();let a=eN("data"in e.callbackQuery?e.callbackQuery.data:""),i=e.from?.id;if(a&&i)try{let r=await t.cancelAction(a,String(i));if("cancelled"===r.type){await e.reply($.s.pendingCancelled);return}if("expired"===r.type){await e.reply($.s.pendingExpired);return}if("already_handled"===r.type){await e.reply($.s.pendingAlreadyHandled);return}if("forbidden"===r.type){await e.reply($.s.noAccess);return}"not_found"===r.type&&await e.reply($.s.pendingNotFound)}catch(t){o.k.error({err:t},"Failed to cancel pending action"),await e.reply("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")}})},eA=(e,t,a,i,r)=>{e.on("message",async e=>{let o=e.message;if(!o||"photo"in o||"text"in o&&o.text.startsWith("/")||"text"in o&&["–ü–æ–º–æ—â—å","–°—Ç–∞—Ç—É—Å","–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏","–û—Ç—á—ë—Ç","–†–µ–∂–∏–º: –ê–¥–º–∏–Ω","–†–µ–∂–∏–º: –°–æ—Ç—Ä—É–¥–Ω–∏–∫"].includes(o.text))return;let n=e.from?.id;if(!n)return;let s=String(n),l=await i.getSession(s);if(l?.fullNameRequestedAt&&"text"in o){let t=l.fullNameRequestedAt,n=new Date;if(!t||n.getTime()-t.getTime()>6e5)await i.clearFullNameRequestedAt(s);else if(!await r.hasActivePendingAction(s)){let t=q(o.text);if(!t){await e.reply($.s.fullNameInvalid);return}let r=await a.updateNameByTelegramUserId(s,t);if(!r&&e.from){let i=e.chat?.id??e.from.id;await a.upsertFromTelegram({id:e.from.id,username:e.from.username,firstName:e.from.first_name,lastName:e.from.last_name,chatId:i}),r=await a.updateNameByTelegramUserId(s,t)}if(!r)return;await i.clearFullNameRequestedAt(s),await e.reply($.s.fullNameSaved(t.displayName));return}}if(l?.nameRequestedAt&&"text"in o){if(Q(await a.findByTelegramUserId(s)))await i.clearNameRequestedAt(s);else if(!await r.hasActivePendingAction(s)){let t=q(o.text);if(!t){await e.reply($.s.nameInvalid);return}let r=await a.updateNameByTelegramUserId(s,t);if(!r&&e.from){let i=e.chat?.id??e.from.id;await a.upsertFromTelegram({id:e.from.id,username:e.from.username,firstName:e.from.first_name,lastName:e.from.last_name,chatId:i}),r=await a.updateNameByTelegramUserId(s,t)}if(!r)return;await i.clearNameRequestedAt(s),await e.reply($.s.nameSaved(t.displayName)),await e.reply($.s.startEmployee,U);return}}if("ADMIN"===(await t.resolveRole(s)).mode){await e.reply($.s.instructionAdmin);return}await e.reply($.s.instructionEmployee)})},eR=e=>{e.command("whoami",async e=>{let t=e.chat,a=e.from;if(!t||!a)return;let i=a.username?`@${a.username}`:"‚Äî",r=[`–¢–∏–ø —á–∞—Ç–∞: ${t.type}`,`Chat ID: ${t.id}`,`–í–∞—à User ID: ${a.id}`,`Username: ${i}`,`–ü–æ–¥—Å–∫–∞–∑–∫–∞: TELEGRAM_BOSS_CHAT_ID = ${t.id}, ADMIN_USER_IDS += ${a.id}`];await e.reply(r.join("\n"))})},eb=(e,t)=>{e.command("set_admin",async e=>{let a=e.from?.id;if(a){if(!await t.canAssignAdmin(String(a))){await e.reply($.s.noAccess);return}await t.addAdmin(String(a)),await e.reply($.s.setAdminSuccess)}})},eO=(e,t)=>{let a=async(e,a)=>{let i=await t.resolveRole(e);if(i.isBoth){let e="ADMIN"===i.mode?"–ê–¥–º–∏–Ω":"–°–æ—Ç—Ä—É–¥–Ω–∏–∫";await a(`${$.s.helpBoth}
–¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º: ${e}.`);return}if("ADMIN"===i.mode){await a($.s.helpAdmin);return}await a($.s.helpEmployee)};e.command("help",async e=>{let t=e.from?.id;t&&await a(String(t),t=>e.reply(t))}),e.hears("–ü–æ–º–æ—â—å",async e=>{let t=e.from?.id;t&&await a(String(t),t=>e.reply(t))})},eC=(e,t)=>{let a=async(e,a,i)=>{if(!(await t.resolveRole(e)).isBoth){await i($.s.modeUnavailable);return}if(await t.setMode(e,a),a===d.UserMode.ADMIN){await i($.s.modeSetAdmin);return}await i($.s.modeSetEmployee)};e.command("mode",async e=>{let a=e.from?.id;if(a){if(!(await t.resolveRole(String(a))).isBoth){await e.reply($.s.modeUnavailable);return}await e.reply($.s.modePrompt,B)}}),e.action(/^mode:(ADMIN|EMPLOYEE)$/,async e=>{await e.answerCbQuery();let t=e.from?.id;if(!t)return;let i=("data"in e.callbackQuery?e.callbackQuery.data:"").split(":")[1];("ADMIN"===i||"EMPLOYEE"===i)&&await a(String(t),"ADMIN"===i?d.UserMode.ADMIN:d.UserMode.EMPLOYEE,t=>e.reply(t))}),e.hears("–†–µ–∂–∏–º: –ê–¥–º–∏–Ω",async e=>{let t=e.from?.id;t&&await a(String(t),d.UserMode.ADMIN,t=>e.reply(t))}),e.hears("–†–µ–∂–∏–º: –°–æ—Ç—Ä—É–¥–Ω–∏–∫",async e=>{let t=e.from?.id;t&&await a(String(t),d.UserMode.EMPLOYEE,t=>e.reply(t))})},ev=(e,t,a,i)=>{e.command("fullname",async e=>{let r=e.from;if(!r)return;let o=String(r.id);if(!(await t.resolveRole(o)).isEmployee){await e.reply($.s.fullNameNotEmployee);return}let n=e.chat?.id??r.id;await a.upsertFromTelegram({id:r.id,username:r.username,firstName:r.first_name,lastName:r.last_name,chatId:n}),await i.setFullNameRequestedAt(o,new Date),await e.reply($.s.fullNamePrompt)})},ek=()=>D.Markup.inlineKeyboard([[D.Markup.button.callback("1 —á–∞—Å","errors:period:1h"),D.Markup.button.callback("6 —á–∞—Å–æ–≤","errors:period:6h")],[D.Markup.button.callback("24 —á–∞—Å–∞","errors:period:24h"),D.Markup.button.callback("7 –¥–Ω–µ–π","errors:period:7d")]]),eD={"1h":{label:"1 —á–∞—Å",ms:36e5},"6h":{label:"6 —á–∞—Å–æ–≤",ms:216e5},"24h":{label:"24 —á–∞—Å–∞",ms:864e5},"7d":{label:"7 –¥–Ω–µ–π",ms:6048e5}},e$=e=>{let t=e.split(":")[2];return t&&eD[t]?eD[t]:null},eP=(e,t=140)=>{if(!e)return"‚Äî";let a=e.split("\n")[0]??"";return a.length<=t?a:`${a.slice(0,Math.max(0,t-3))}...`},eU=(e,t=20,a=2e3)=>{if(!e)return"‚Äî";let i=e.split("\n"),r=i.slice(0,t).join("\n");return i.length>t&&(r+="\n..."),r.length>a&&(r=`${r.slice(0,Math.max(0,a-3))}...`),r},eF=e=>{if(!e)return"‚Äî";if("string"==typeof e)return eU(e,20,2e3);try{return eU(JSON.stringify(e,null,2),20,2e3)}catch{return"‚Äî"}},eB=e=>{let t=[];for(let a=0;a<e.length;a+=2){let i=[];i.push(D.Markup.button.callback(`–ü–æ–¥—Ä–æ–±–Ω–µ–µ ${a+1}`,`errors:detail:${e[a]}`)),e[a+1]&&i.push(D.Markup.button.callback(`–ü–æ–¥—Ä–æ–±–Ω–µ–µ ${a+2}`,`errors:detail:${e[a+1]}`)),t.push(i)}return D.Markup.inlineKeyboard(t)},ex=(e,t)=>{let a=V(t),o=async e=>{await e.reply("–û—à–∏–±–∫–∏: –≤—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥.",ek())};e.command("errors",a,async e=>{await o(e)}),e.hears("–û—à–∏–±–∫–∏",a,async e=>{await o(e)}),e.action(/^errors:period:/,a,async e=>{await e.answerCbQuery();let t=e$("data"in e.callbackQuery?e.callbackQuery.data:"");if(!t)return;let a=new Date(Date.now()-t.ms),o=await i._.eventLog.findMany({where:{level:"error",createdAt:{gte:a}},orderBy:{createdAt:"desc"},take:10});if(0===o.length){await e.reply(`–û—à–∏–±–æ–∫ –∑–∞ –ø–µ—Ä–∏–æ–¥ ${t.label} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.`);return}let n=[`–û—à–∏–±–∫–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥ ${t.label} (–ø–æ—Å–ª–µ–¥–Ω–∏–µ ${o.length}):`];for(let[e,t]of o.entries()){let a=(0,I.o0)(t.createdAt,r.O.timezone),i=[t.fromId?`from:${t.fromId}`:null,t.chatId?`chat:${t.chatId}`:null].filter(Boolean).join(" "),o=t.updateType?` (${t.updateType})`:"",s=eP(t.errorMsg??t.errorName??"‚Äî");n.push(`${e+1}) ${a} | ${t.kind}${o} | ${i||"‚Äî"} | ${s}`)}let s=eB(o.map(e=>e.id));await e.reply(n.join("\n"),s)}),e.action(/^errors:detail:/,a,async e=>{await e.answerCbQuery();let t=("data"in e.callbackQuery?e.callbackQuery.data:"").split(":")[2];if(!t)return;let a=await i._.eventLog.findUnique({where:{id:t}});if(!a){await e.reply("–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.");return}for(let t of ew(`–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:
–î–∞—Ç–∞/–≤—Ä–µ–º—è: ${(0,I.o0)(a.createdAt,r.O.timezone)}
–¢–∏–ø: ${a.kind}
Update type: ${a.updateType??"‚Äî"}
chatId: ${a.chatId??"‚Äî"}
fromId: ${a.fromId??"‚Äî"}
messageId: ${a.messageId??"‚Äî"}
–ò–º—è: ${a.errorName??"‚Äî"}
–°–æ–æ–±—â–µ–Ω–∏–µ: ${eU(a.errorMsg,4,1e3)}
–°—Ç–µ–∫:
${eU(a.errorStack,20,3e3)}
Meta:
${eF(a.meta)}`))await e.reply(t)})},eL=(e,t)=>{Y(e,t.roleService,t.employeeRepo,t.userSessionRepo),z(e,t.shiftService,t.roleService),eR(e),eO(e,t.roleService),eC(e,t.roleService),ev(e,t.roleService,t.employeeRepo,t.userSessionRepo),eb(e,t.adminService),eg(e,t.adminService,t.employeeRepo,t.reportService,t.exportService,t.photoReviewService),eS(e,t.adminService,t.reportService,t.exportService),ex(e,t.adminService),e_(e,t.roleService,t.pendingActionService),eM(e,t.pendingActionService,t.adminService),eA(e,t.roleService,t.employeeRepo,t.userSessionRepo,t.pendingActionService)};var eH=a(1133),eq=a(4051);let eQ=e=>{let t=new D.Telegraf(r.O.telegramBotToken);return(0,eH.Fo)(t.telegram),eL(t,e),t.catch(async(e,t)=>{console.error("telegraf_error",{update_id:t.update?.update_id,updateType:t.updateType,chatId:t.chat?.id,fromId:t.from?.id},e);try{let a=t.message??t.update?.message,r=t.callbackQuery??t.update?.callback_query,o=t.update,n=r?.data;await (0,eq.K)(i._,{level:"error",kind:"telegraf_error",updateId:"number"==typeof o?.update_id?o.update_id:void 0,updateType:t.updateType,chatId:t.chat?.id,fromId:t.from?.id,messageId:a?.message_id??r?.message?.message_id,meta:{hasPhoto:!!a?.photo?.length,hasText:!!a?.text,hasCaption:!!a?.caption,mediaGroupId:a?.media_group_id?String(a.media_group_id):void 0,callbackDataPrefix:"string"==typeof n?n.slice(0,20):void 0},err:e})}catch(e){console.error("Failed to log telegraf error",e)}}),t},eY=globalThis,ez=async()=>(eY.__shiftBotApp||(eY.__shiftBotApp=(async()=>{let e=null;for(let t=1;t<=3;t+=1)try{await i._.$connect(),e=null;break}catch(r){e=r;try{await (0,eq.K)(i._,{level:"error",kind:"prisma_connect_error",meta:{attempt:t,maxAttempts:3},err:r})}catch{}let a=200*t+Math.floor(100*Math.random());await new Promise(e=>setTimeout(e,a))}if(e)throw e;let t=new l,a=new p,n=new m,s=new u,d=new c,y=new g(n),I=new f(t,a,{maxShiftHours:r.O.maxShiftHours,minShiftMinutes:60*r.O.minShiftHours,shortShiftGraceMinutes:r.O.shortShiftGraceMinutes},o.k),S=new h(a,t),T=new w(y,t,s),_=new N,E=new k(a),A=new M(t,a,d,{ttlMinutes:r.O.pendingActionTtlMinutes,maxShiftHours:r.O.maxShiftHours,minShiftMinutes:60*r.O.minShiftHours,shortShiftGraceMinutes:r.O.shortShiftGraceMinutes},async e=>i._.$transaction(async t=>e(t))),R=eQ({shiftService:I,reportService:S,adminService:y,roleService:T,employeeRepo:t,userSessionRepo:s,exportService:_,pendingActionService:A,photoReviewService:E});return{prisma:i._,bot:R,employeeRepo:t,userSessionRepo:s,shiftRepo:a,shiftService:I,adminService:y,roleService:T,reportService:S,exportService:_,pendingActionService:A,photoReviewService:E}})()),eY.__shiftBotApp)},2254:(e,t,a)=>{a.d(t,{H:()=>i});let i={now:()=>new Date}},4051:(e,t,a)=>{a.d(t,{K:()=>h});var i=a(4770),r=a(2942);let o=globalThis,n=o.__eventLogNotifyState??(o.__eventLogNotifyState={}),s=(e,t)=>e?e.length<=t?e:e.slice(0,t):void 0,l=e=>e?(e.split("\n")[0]??"").trim():"",d=e=>null==e?void 0:"string"==typeof e?e:"number"==typeof e||"bigint"==typeof e?String(e):void 0,p=e=>{if(!e)return{};if(e instanceof Error)return{name:e.name,message:e.message,stack:e.stack};if("string"==typeof e)return{name:"Error",message:e};try{return{name:"Error",message:JSON.stringify(e)}}catch{return{name:typeof e,message:String(e)}}},m=e=>{if(null!=e){if("string"==typeof e)return s(e,200)??"";if("number"==typeof e||"boolean"==typeof e)return e;if(Array.isArray(e)){let t=e.slice(0,10).map(e=>"string"==typeof e?s(e,200)??"":"number"==typeof e||"boolean"==typeof e?e:null==e?"[null]":"[complex]");return e.length>10?{length:e.length,sample:t}:t}if("object"==typeof e){let t=Object.entries(e);if(t.length>10)return{keys:t.slice(0,10).map(([e])=>e)};let a={};for(let[e,i]of t){if("string"==typeof i){a[e]=s(i,120)??"";continue}if("number"==typeof i||"boolean"==typeof i){a[e]=i;continue}null!=i&&(a[e]="[complex]")}return a}return String(e).slice(0,200)}},u=e=>{if(!e||"object"!=typeof e)return;let t={};for(let[a,i]of Object.entries(e)){let e=m(i);void 0!==e&&(t[a]=e)}try{if(JSON.stringify(t).length<=4e3)return t}catch{return}return{note:"meta_truncated",keys:Object.keys(t).slice(0,12)}},c=e=>{let t=e.meta&&"object"==typeof e.meta&&!Array.isArray(e.meta)?String(e.meta.callbackDataPrefix??""):"",a=[e.kind,e.updateType??"",e.errorName??"",l(e.errorMsg??""),t].join("|");return(0,i.createHash)("sha1").update(a).digest("hex")},y=(e,t)=>{let a=l(t.message??"")||"‚Äî",i=`–û—à–∏–±–∫–∞
–¢–∏–ø: ${e.kind}
Update: ${e.updateType??"‚Äî"}
fromId: ${e.fromId??"‚Äî"}
chatId: ${e.chatId??"‚Äî"}
${t.name??"–û—à–∏–±–∫–∞"}: ${a}`;return s(i,1e3)??i},f=async e=>{if(!r.O.errorNotifyBoss)return;let t=r.O.telegramBossChatId;if(!t)return;let a=await fetch(`https://api.telegram.org/bot${r.O.telegramBotToken}/sendMessage`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({chat_id:t,text:e})});if(!a.ok){let e=await a.text().catch(()=>"");throw Error(`Telegram notify failed: ${a.status} ${e}`)}},h=async(e,t)=>{try{let a=p(t.err),i=s(a.message,1e3),o=s(a.stack,12e3),l=u(t.meta),m=t.updateType??void 0,h="error"===t.level?c({kind:t.kind,updateType:m,errorName:a.name,errorMsg:i,meta:l}):void 0;if(h){let t=new Date(Date.now()-6e5);if(await e.eventLog.findFirst({where:{fingerprint:h,createdAt:{gte:t}},select:{id:!0}}))return;await e.eventLog.updateMany({where:{fingerprint:h,createdAt:{lt:t}},data:{fingerprint:null}})}try{await e.eventLog.create({data:{level:t.level,kind:t.kind,updateId:t.updateId??void 0,chatId:d(t.chatId),fromId:d(t.fromId),messageId:t.messageId??void 0,updateType:m??void 0,meta:l??void 0,errorName:a.name,errorMsg:i,errorStack:o,fingerprint:h}})}catch(t){let e="object"==typeof t&&t?t.code:void 0;if("P2002"===e)return;throw t}if("error"===t.level&&r.O.errorNotifyBoss&&"test"!==r.O.nodeEnv){let e=Date.now(),i=n[t.kind]??0,o=1e3*r.O.errorNotifyCooldownSec;if(e-i>=o){n[t.kind]=e;let i=y(t,a);f(i).catch(e=>{console.error("Failed to notify boss",e)})}}}catch(e){console.error("Failed to persist event log",e)}}},6751:(e,t,a)=>{a.d(t,{TW:()=>c,mr:()=>d,o0:()=>m,p6:()=>p,yD:()=>u});var i=a(3555),r=a.n(i),o=a(4799),n=a.n(o),s=a(8466),l=a.n(s);r().extend(n()),r().extend(l());let d=(e,t)=>r()(e).tz(t).format("HH:mm"),p=(e,t)=>r()(e).tz(t).format("DD.MM.YYYY"),m=(e,t)=>r()(e).tz(t).format("DD.MM.YYYY HH:mm"),u=(e,t)=>r()(e).tz(t).format("DD.MM HH:mm"),c=(e,t)=>r()(e).tz(t).format("YYYY-MM-DD")}};