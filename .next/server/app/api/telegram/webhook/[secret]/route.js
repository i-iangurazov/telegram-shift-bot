"use strict";(()=>{var e={};e.id=215,e.ids=[215],e.modules={3524:e=>{e.exports=require("@prisma/client")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7790:e=>{e.exports=require("assert")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},7702:e=>{e.exports=require("events")},2048:e=>{e.exports=require("fs")},5807:e=>{e.exports=require("module")},9801:e=>{e.exports=require("os")},5315:e=>{e.exports=require("path")},7360:e=>{e.exports=require("url")},1764:e=>{e.exports=require("util")},6162:e=>{e.exports=require("worker_threads")},778:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>T,patchFetch:()=>N,requestAsyncStorage:()=>O,routeModule:()=>E,serverHooks:()=>g,staticGenerationAsyncStorage:()=>h});var a={};r.r(a),r.d(a,{POST:()=>f,runtime:()=>p});var o=r(261),i=r(8331),n=r(4510),s=r(9784),l=r(2942),_=r(8361),d=r(7151),u=r(4051);let p="nodejs",c=e=>{for(let t of["message","edited_message","callback_query","inline_query","chosen_inline_result","channel_post","edited_channel_post","chat_member","my_chat_member","chat_join_request","shipping_query","pre_checkout_query","poll","poll_answer"])if(t in e)return t},m=e=>{let t=c(e),r=e.message??e.edited_message??e.channel_post??e.edited_channel_post??e.callback_query?.message??e.chat_join_request??e.chat_member??e.my_chat_member,a=e.message?.from??e.edited_message?.from??e.callback_query?.from??e.inline_query?.from??e.chosen_inline_result?.from??e.chat_join_request?.from??e.chat_member?.from??e.my_chat_member?.from??e.shipping_query?.from??e.pre_checkout_query?.from??e.poll_answer?.user,o=r?.chat?.id??e.callback_query?.message?.chat?.id??e.chat_join_request?.chat?.id,i=a?.id,n=r?.message_id??e.callback_query?.message?.message_id,s=e.callback_query?.data;return{updateType:t,updateId:"number"==typeof e.update_id?e.update_id:void 0,chatId:o,fromId:i,messageId:n,meta:{topKeys:Object.keys(e),messageKeys:r?Object.keys(r):null,hasPhoto:!!r?.photo?.length,hasText:!!r?.text,hasCaption:!!r?.caption,mediaGroupId:r?.media_group_id?String(r.media_group_id):void 0,callbackDataPrefix:"string"==typeof s?s.slice(0,20):void 0}}};async function f(e,{params:t}){let r;if(t.secret!==l.O.webhookSecret)return s.NextResponse.json({ok:!1},{status:404});if(l.O.telegramWebhookSecretToken&&e.headers.get("x-telegram-bot-api-secret-token")!==l.O.telegramWebhookSecretToken)return s.NextResponse.json({ok:!1},{status:401});let a=e.headers.get("content-type"),o="";try{o=await e.text(),r=JSON.parse(o)}catch(e){try{await (0,u.K)(d._,{level:"error",kind:"webhook_parse_error",meta:{rawLen:o.length,contentType:a},err:e})}catch(e){_.k.error({err:e},"Failed to log webhook parse error")}return s.NextResponse.json({ok:!0})}try{let e="number"==typeof r.update_id?r.update_id:null;if(!e)return await (0,u.K)(d._,{level:"error",kind:"webhook_missing_update_id",meta:{topKeys:Object.keys(r)},err:Error("Missing update_id")}),s.NextResponse.json({ok:!0});await d._.telegramUpdateQueue.upsert({where:{updateId:e},update:{},create:{updateId:e,payload:r}})}catch(e){try{let t=m(r);await (0,u.K)(d._,{level:"error",kind:"webhook_queue_error",...t,err:e})}catch(e){_.k.error({err:e},"Failed to log webhook queue error")}}return s.NextResponse.json({ok:!0})}let E=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/telegram/webhook/[secret]/route",pathname:"/api/telegram/webhook/[secret]",filename:"route",bundlePath:"app/api/telegram/webhook/[secret]/route"},resolvedPagePath:"/Users/ilias_iangurazov/Desktop/telegram-shift-bot/src/app/api/telegram/webhook/[secret]/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:O,staticGenerationAsyncStorage:h,serverHooks:g}=E,T="/api/telegram/webhook/[secret]/route";function N(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:h})}},2942:(e,t,r)=>{r.d(t,{O:()=>i}),r(4243);var a=r(7012);let o=a.Ry({TELEGRAM_BOT_TOKEN:a.Z_().min(1),TELEGRAM_BOSS_CHAT_ID:a.Z_().min(1),ADMIN_USER_IDS:a.Z_().optional(),DATABASE_URL:a.Z_().min(1),WEBHOOK_SECRET:a.Z_().min(1),INTERNAL_SECRET:a.Z_().min(1),PUBLIC_BASE_URL:a.Z_().min(1),TELEGRAM_WEBHOOK_SECRET_TOKEN:a.Z_().optional(),TIMEZONE:a.Z_().default("Asia/Bishkek"),MAX_SHIFT_HOURS:a.oQ.number().int().positive().default(12),MIN_SHIFT_HOURS:a.oQ.number().int().positive().default(8),SHORT_SHIFT_GRACE_MINUTES:a.oQ.number().int().min(0).default(0),PENDING_ACTION_TTL_MINUTES:a.oQ.number().int().positive().default(10),PENDING_ACTION_CLEANUP_CRON:a.Z_().default("*/2 * * * *"),PHOTO_RETENTION_DAYS:a.oQ.number().int().positive().default(3),PHOTO_RETENTION_CRON:a.Z_().default("0 * * * *"),OVERDUE_CHECK_CRON:a.Z_().default("*/5 * * * *"),TICK_MAX_AUTOCLOSE:a.oQ.number().int().positive().default(50),TICK_MAX_EXPIRE_PENDING:a.oQ.number().int().positive().default(200),NOTIFY_EMPLOYEE_ON_AUTOCLOSE:a.oQ.boolean().default(!0),ERROR_NOTIFY_BOSS:a.oQ.boolean().default(!1),ERROR_NOTIFY_COOLDOWN_SEC:a.oQ.number().int().positive().default(60),EVENT_LOG_RETENTION_DAYS:a.oQ.number().int().positive().default(14),LOG_LEVEL:a.Z_().default("info"),NODE_ENV:a.Z_().optional()}).safeParse(process.env);if(!o.success){let e=o.error.format();throw Error(`Invalid environment configuration: ${JSON.stringify(e)}`)}let i={telegramBotToken:o.data.TELEGRAM_BOT_TOKEN,telegramBossChatId:o.data.TELEGRAM_BOSS_CHAT_ID,adminUserIds:(o.data.ADMIN_USER_IDS??"").split(",").map(e=>e.trim()).filter(Boolean),databaseUrl:o.data.DATABASE_URL,webhookSecret:o.data.WEBHOOK_SECRET,internalSecret:o.data.INTERNAL_SECRET,publicBaseUrl:o.data.PUBLIC_BASE_URL,telegramWebhookSecretToken:o.data.TELEGRAM_WEBHOOK_SECRET_TOKEN??null,timezone:o.data.TIMEZONE,maxShiftHours:o.data.MAX_SHIFT_HOURS,minShiftHours:o.data.MIN_SHIFT_HOURS,shortShiftGraceMinutes:o.data.SHORT_SHIFT_GRACE_MINUTES,pendingActionTtlMinutes:o.data.PENDING_ACTION_TTL_MINUTES,pendingActionCleanupCron:o.data.PENDING_ACTION_CLEANUP_CRON,photoRetentionDays:o.data.PHOTO_RETENTION_DAYS,photoRetentionCron:o.data.PHOTO_RETENTION_CRON,overdueCheckCron:o.data.OVERDUE_CHECK_CRON,tickMaxAutoclose:o.data.TICK_MAX_AUTOCLOSE,tickMaxExpirePending:o.data.TICK_MAX_EXPIRE_PENDING,notifyEmployeeOnAutoClose:o.data.NOTIFY_EMPLOYEE_ON_AUTOCLOSE,errorNotifyBoss:o.data.ERROR_NOTIFY_BOSS,errorNotifyCooldownSec:o.data.ERROR_NOTIFY_COOLDOWN_SEC,eventLogRetentionDays:o.data.EVENT_LOG_RETENTION_DAYS,logLevel:o.data.LOG_LEVEL,nodeEnv:o.data.NODE_ENV}},8361:(e,t,r)=>{r.d(t,{k:()=>n});var a=r(4062),o=r.n(a),i=r(2942);let n=o()({level:i.O.logLevel,base:{service:"telegram-shift-bot"}})},7151:(e,t,r)=>{r.d(t,{_:()=>o});var a=r(3524);let o=globalThis.prisma??new a.PrismaClient},4051:(e,t,r)=>{r.d(t,{K:()=>E});var a=r(4770),o=r(2942);let i=globalThis,n=i.__eventLogNotifyState??(i.__eventLogNotifyState={}),s=(e,t)=>e?e.length<=t?e:e.slice(0,t):void 0,l=e=>e?(e.split("\n")[0]??"").trim():"",_=e=>null==e?void 0:"string"==typeof e?e:"number"==typeof e||"bigint"==typeof e?String(e):void 0,d=e=>{if(!e)return{};if(e instanceof Error)return{name:e.name,message:e.message,stack:e.stack};if("string"==typeof e)return{name:"Error",message:e};try{return{name:"Error",message:JSON.stringify(e)}}catch{return{name:typeof e,message:String(e)}}},u=e=>{if(null!=e){if("string"==typeof e)return s(e,200)??"";if("number"==typeof e||"boolean"==typeof e)return e;if(Array.isArray(e)){let t=e.slice(0,10).map(e=>"string"==typeof e?s(e,200)??"":"number"==typeof e||"boolean"==typeof e?e:null==e?"[null]":"[complex]");return e.length>10?{length:e.length,sample:t}:t}if("object"==typeof e){let t=Object.entries(e);if(t.length>10)return{keys:t.slice(0,10).map(([e])=>e)};let r={};for(let[e,a]of t){if("string"==typeof a){r[e]=s(a,120)??"";continue}if("number"==typeof a||"boolean"==typeof a){r[e]=a;continue}null!=a&&(r[e]="[complex]")}return r}return String(e).slice(0,200)}},p=e=>{if(!e||"object"!=typeof e)return;let t={};for(let[r,a]of Object.entries(e)){let e=u(a);void 0!==e&&(t[r]=e)}try{if(JSON.stringify(t).length<=4e3)return t}catch{return}return{note:"meta_truncated",keys:Object.keys(t).slice(0,12)}},c=e=>{let t=e.meta&&"object"==typeof e.meta&&!Array.isArray(e.meta)?String(e.meta.callbackDataPrefix??""):"",r=[e.kind,e.updateType??"",e.errorName??"",l(e.errorMsg??""),t].join("|");return(0,a.createHash)("sha1").update(r).digest("hex")},m=(e,t)=>{let r=l(t.message??"")||"—",a=`Ошибка
Тип: ${e.kind}
Update: ${e.updateType??"—"}
fromId: ${e.fromId??"—"}
chatId: ${e.chatId??"—"}
${t.name??"Ошибка"}: ${r}`;return s(a,1e3)??a},f=async e=>{if(!o.O.errorNotifyBoss)return;let t=o.O.telegramBossChatId;if(!t)return;let r=await fetch(`https://api.telegram.org/bot${o.O.telegramBotToken}/sendMessage`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({chat_id:t,text:e})});if(!r.ok){let e=await r.text().catch(()=>"");throw Error(`Telegram notify failed: ${r.status} ${e}`)}},E=async(e,t)=>{try{let r=d(t.err),a=s(r.message,1e3),i=s(r.stack,12e3),l=p(t.meta),u=t.updateType??void 0,E="error"===t.level?c({kind:t.kind,updateType:u,errorName:r.name,errorMsg:a,meta:l}):void 0;if(E){let t=new Date(Date.now()-6e5);if(await e.eventLog.findFirst({where:{fingerprint:E,createdAt:{gte:t}},select:{id:!0}}))return;await e.eventLog.updateMany({where:{fingerprint:E,createdAt:{lt:t}},data:{fingerprint:null}})}if(await e.eventLog.create({data:{level:t.level,kind:t.kind,updateId:t.updateId??void 0,chatId:_(t.chatId),fromId:_(t.fromId),messageId:t.messageId??void 0,updateType:u??void 0,meta:l??void 0,errorName:r.name,errorMsg:a,errorStack:i,fingerprint:E}}),"error"===t.level&&o.O.errorNotifyBoss){let e=Date.now(),a=n[t.kind]??0,i=1e3*o.O.errorNotifyCooldownSec;if(e-a>=i){n[t.kind]=e;let a=m(t,r);f(a).catch(e=>{console.error("Failed to notify boss",e)})}}}catch(e){console.error("Failed to persist event log",e)}}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[937,705],()=>r(778));module.exports=a})();