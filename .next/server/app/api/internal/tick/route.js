"use strict";(()=>{var e={};e.id=122,e.ids=[122],e.modules={3524:e=>{e.exports=require("@prisma/client")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7790:e=>{e.exports=require("assert")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},7702:e=>{e.exports=require("events")},2048:e=>{e.exports=require("fs")},629:e=>{e.exports=require("fs/promises")},2615:e=>{e.exports=require("http")},5240:e=>{e.exports=require("https")},5807:e=>{e.exports=require("module")},9801:e=>{e.exports=require("os")},5315:e=>{e.exports=require("path")},8621:e=>{e.exports=require("punycode")},8220:e=>{e.exports=require("stream")},4175:e=>{e.exports=require("tty")},7360:e=>{e.exports=require("url")},1764:e=>{e.exports=require("util")},6162:e=>{e.exports=require("worker_threads")},1568:e=>{e.exports=require("zlib")},1330:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>j,patchFetch:()=>D,requestAsyncStorage:()=>M,routeModule:()=>C,serverHooks:()=>I,staticGenerationAsyncStorage:()=>P});var a={};r.r(a),r.d(a,{POST:()=>S,runtime:()=>v});var i=r(261),o=r(8331),n=r(4510),s=r(9784),l=r(2942),d=r(3196),u=r(3406),p=r(6751),c=r(7388),m=r(2254);let g=async(e,t,r,a)=>{let i=a?.now??a?.clock?.now()??m.H.now(),o=await t.autoCloseOverdueShifts(i,a?.limit);if(0===o.length)return{autoClosed:0,notifiedAdmins:0,notifiedEmployees:0};let n=await r.getAdminChatIds(),s=0,d=0;for(let t of o){let r=(0,p.mr)(t.endTime,l.O.timezone),a=t.shift.employee.displayName,i=u.s.autoClosedBoss(a,r,l.O.maxShiftHours);for(let t of n)(await (0,c.g)(e.telegram,t,i)).ok&&(s+=1);l.O.notifyEmployeeOnAutoClose&&(await (0,c.g)(e.telegram,t.shift.employee.telegramUserId,u.s.autoClosedEmployee(l.O.maxShiftHours))).ok&&(d+=1)}return{autoClosed:o.length,notifiedAdmins:s,notifiedEmployees:d}};var h=r(8361);let w=async(e,t)=>{let r=t?.now??t?.clock?.now()??m.H.now(),a=await e.expirePendingActions(r,t?.limit);return a>0&&h.k.info({expired:a},"Expired pending actions"),a},f=async(e,t)=>{let r=t?.now??t?.clock?.now()??m.H.now(),a=new Date(r.getTime()-864e5*l.O.photoRetentionDays),i=await e.purgeOldPhotos(a,r,t?.limit);return i>0&&h.k.info({purged:i},"Purged old shift photos"),i};var y=r(4051);let k=e=>{for(let t of["message","edited_message","callback_query","inline_query","chosen_inline_result","channel_post","edited_channel_post","chat_member","my_chat_member","chat_join_request","shipping_query","pre_checkout_query","poll","poll_answer"])if(t in e)return t},_=e=>{let t=k(e),r=e.message??e.edited_message??e.channel_post??e.edited_channel_post??e.callback_query?.message??e.chat_join_request??e.chat_member??e.my_chat_member,a=e.callback_query?.data;return{updateType:t,meta:{topKeys:Object.keys(e),messageKeys:r?Object.keys(r):null,hasPhoto:!!r?.photo?.length,hasText:!!r?.text,hasCaption:!!r?.caption,mediaGroupId:r?.media_group_id?String(r.media_group_id):void 0,callbackDataPrefix:"string"==typeof a?a.slice(0,20):void 0}}},x=e=>{if(!e)return"Unknown error";if(e instanceof Error)return e.message||e.name;if("string"==typeof e)return e;try{return JSON.stringify(e)}catch{return String(e)}},q=(e,t)=>e.length<=t?e:e.slice(0,t),b=async e=>{let t=e.now??new Date,r=await e.prisma.telegramUpdateQueue.findMany({where:{status:"pending",nextRunAt:{lte:t}},orderBy:{createdAt:"asc"},take:e.limit}),a={picked:r.length,processed:0,done:0,failed:0,skipped:0};for(let i of r){if(0===(await e.prisma.telegramUpdateQueue.updateMany({where:{id:i.id,status:"pending",nextRunAt:{lte:t}},data:{status:"processing"}})).count){a.skipped+=1;continue}a.processed+=1;let r=i.payload&&"object"==typeof i.payload?i.payload:{},{updateType:o,meta:n}=_(r);try{await e.bot.handleUpdate(r),await e.prisma.telegramUpdateQueue.update({where:{id:i.id},data:{status:"done"}}),a.done+=1}catch(p){let t=i.attempts+1,r=Math.min(10*Math.pow(2,t),600),s=Math.floor(1e3*Math.random()),l=new Date(Date.now()+1e3*r+s),d=t>=10?"failed":"pending",u=q(x(p),500);await e.prisma.telegramUpdateQueue.update({where:{id:i.id},data:{status:d,attempts:t,lastError:u,nextRunAt:l}}),"failed"===d&&(a.failed+=1),await (0,y.K)(e.prisma,{level:"error",kind:"queue_update_error",updateId:i.updateId,updateType:o,meta:{...n,attempts:t},err:p})}}return a},v="nodejs",A=e=>{let t=e.headers.get("authorization"),r=t?.startsWith("Bearer ")?t.slice(7):null,a=e.headers.get("x-internal-secret");return r===l.O.internalSecret||a===l.O.internalSecret},O=async e=>{let t=await e.prisma.telegramUpdateQueue.findFirst({where:{status:"pending"},orderBy:{createdAt:"asc"},select:{createdAt:!0}});if(!t)return;let r=Math.floor((e.now.getTime()-t.createdAt.getTime())/1e3);if(r<=180)return;await (0,y.K)(e.prisma,{level:"warn",kind:"queue_backlog_detected",meta:{ageSeconds:r,oldestCreatedAt:t.createdAt.toISOString()}});let a=new Date(e.now.getTime()-36e5);if(await e.prisma.eventLog.findFirst({where:{kind:"queue_backlog_alert_sent",createdAt:{gte:a}},select:{id:!0}})||!l.O.telegramBossChatId)return;let i=`⚠️ Очередь Telegram отстаёт: старейшая запись ${r} сек.`,o=await (0,c.g)(e.bot.telegram,l.O.telegramBossChatId,i);o.ok?await (0,y.K)(e.prisma,{level:"warn",kind:"queue_backlog_alert_sent",meta:{ageSeconds:r,oldestCreatedAt:t.createdAt.toISOString()}}):await (0,y.K)(e.prisma,{level:"warn",kind:"queue_backlog_alert_failed",meta:{ageSeconds:r,oldestCreatedAt:t.createdAt.toISOString(),reason:o.reason}})};async function S(e){if(!A(e))return s.NextResponse.json({ok:!1},{status:401});let t=e.nextUrl.searchParams.get("mode"),r="daily"===t?"daily":"queue"===t?"queue":"regular",a=new Date,i=null;try{i=await (0,d.M)();let e=null;"daily"!==r&&(e=await b({bot:i.bot,prisma:i.prisma,limit:25,now:a}));let t=0,o={autoClosed:0,notifiedAdmins:0,notifiedEmployees:0};"queue"!==r&&(t=await w(i.pendingActionService,{now:a,limit:l.O.tickMaxExpirePending}),o=await g(i.bot,i.shiftService,i.adminService,{now:a,limit:l.O.tickMaxAutoclose})),"regular"===r&&await O({prisma:i.prisma,bot:i.bot,now:a});let n=0,u=0;if("daily"===r){n=await f(i.shiftRepo,{now:a,limit:l.O.tickMaxExpirePending});let e=l.O.eventLogRetentionDays,t=new Date(a.getTime()-864e5*e);u=(await i.prisma.eventLog.deleteMany({where:{createdAt:{lt:t}}})).count}return s.NextResponse.json({ok:!0,mode:r,queue:e,expiredPending:t,autoClosed:o.autoClosed,photosPurged:n,logsPurged:u,ranAt:a.toISOString()})}catch(e){try{let t=i??await (0,d.M)();await (0,y.K)(t.prisma,{level:"error",kind:"tick_error",meta:{mode:r},err:e})}catch(e){h.k.error({err:e},"Failed to log tick error")}return h.k.error({err:e},"Internal tick failed"),s.NextResponse.json({ok:!0,mode:r,error:!0,ranAt:a.toISOString()})}}let C=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/internal/tick/route",pathname:"/api/internal/tick",filename:"route",bundlePath:"app/api/internal/tick/route"},resolvedPagePath:"/Users/ilias_iangurazov/Desktop/telegram-shift-bot/src/app/api/internal/tick/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:M,staticGenerationAsyncStorage:P,serverHooks:I}=C,j="/api/internal/tick/route";function D(){return(0,n.patchFetch)({serverHooks:I,staticGenerationAsyncStorage:P})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[937,830,157,196],()=>r(1330));module.exports=a})();