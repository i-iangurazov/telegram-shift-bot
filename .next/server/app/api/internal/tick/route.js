"use strict";(()=>{var e={};e.id=122,e.ids=[122],e.modules={3524:e=>{e.exports=require("@prisma/client")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7790:e=>{e.exports=require("assert")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},7702:e=>{e.exports=require("events")},2048:e=>{e.exports=require("fs")},629:e=>{e.exports=require("fs/promises")},2615:e=>{e.exports=require("http")},5240:e=>{e.exports=require("https")},5807:e=>{e.exports=require("module")},9801:e=>{e.exports=require("os")},5315:e=>{e.exports=require("path")},8621:e=>{e.exports=require("punycode")},8220:e=>{e.exports=require("stream")},4175:e=>{e.exports=require("tty")},7360:e=>{e.exports=require("url")},1764:e=>{e.exports=require("util")},6162:e=>{e.exports=require("worker_threads")},1568:e=>{e.exports=require("zlib")},1330:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>C,patchFetch:()=>D,requestAsyncStorage:()=>A,routeModule:()=>S,serverHooks:()=>M,staticGenerationAsyncStorage:()=>P});var a={};r.r(a),r.d(a,{POST:()=>b,runtime:()=>v});var i=r(261),o=r(8331),n=r(4510),s=r(9784),l=r(2942),u=r(3196),p=r(3406),d=r(6751),c=r(7388);let m=async(e,t,r,a)=>{let i=a?.now??new Date,o=await t.autoCloseOverdueShifts(i,a?.limit);if(0===o.length)return{autoClosed:0,notifiedAdmins:0,notifiedEmployees:0};let n=await r.getAdminChatIds(),s=0,u=0;for(let t of o){let r=(0,d.mr)(t.endTime,l.O.timezone),a=t.shift.employee.displayName,i=p.s.autoClosedBoss(a,r,l.O.maxShiftHours);for(let t of n)await (0,c.g)(e.telegram,t,i)&&(s+=1);l.O.notifyEmployeeOnAutoClose&&await (0,c.g)(e.telegram,t.shift.employee.telegramUserId,p.s.autoClosedEmployee(l.O.maxShiftHours))&&(u+=1)}return{autoClosed:o.length,notifiedAdmins:s,notifiedEmployees:u}};var h=r(8361);let g=async(e,t)=>{let r=t?.now??new Date,a=await e.expirePendingActions(r,t?.limit);return a>0&&h.k.info({expired:a},"Expired pending actions"),a},f=async(e,t)=>{let r=t?.now??new Date,a=new Date(r.getTime()-864e5*l.O.photoRetentionDays),i=await e.purgeOldPhotos(a,r,t?.limit);return i>0&&h.k.info({purged:i},"Purged old shift photos"),i};var y=r(4051);let w=e=>{for(let t of["message","edited_message","callback_query","inline_query","chosen_inline_result","channel_post","edited_channel_post","chat_member","my_chat_member","chat_join_request","shipping_query","pre_checkout_query","poll","poll_answer"])if(t in e)return t},x=e=>{let t=w(e),r=e.message??e.edited_message??e.channel_post??e.edited_channel_post??e.callback_query?.message??e.chat_join_request??e.chat_member??e.my_chat_member,a=e.callback_query?.data;return{updateType:t,meta:{topKeys:Object.keys(e),messageKeys:r?Object.keys(r):null,hasPhoto:!!r?.photo?.length,hasText:!!r?.text,hasCaption:!!r?.caption,mediaGroupId:r?.media_group_id?String(r.media_group_id):void 0,callbackDataPrefix:"string"==typeof a?a.slice(0,20):void 0}}},_=e=>{if(!e)return"Unknown error";if(e instanceof Error)return e.message||e.name;if("string"==typeof e)return e;try{return JSON.stringify(e)}catch{return String(e)}},k=(e,t)=>e.length<=t?e:e.slice(0,t),q=async e=>{let t=e.now??new Date,r=await e.prisma.telegramUpdateQueue.findMany({where:{status:"pending",nextRunAt:{lte:t}},orderBy:{createdAt:"asc"},take:e.limit}),a={picked:r.length,processed:0,done:0,failed:0,skipped:0};for(let i of r){if(0===(await e.prisma.telegramUpdateQueue.updateMany({where:{id:i.id,status:"pending",nextRunAt:{lte:t}},data:{status:"processing"}})).count){a.skipped+=1;continue}a.processed+=1;let r=i.payload&&"object"==typeof i.payload?i.payload:{},{updateType:o,meta:n}=x(r);try{await e.bot.handleUpdate(r),await e.prisma.telegramUpdateQueue.update({where:{id:i.id},data:{status:"done"}}),a.done+=1}catch(d){let t=i.attempts+1,r=Math.min(10*Math.pow(2,t),600),s=Math.floor(1e3*Math.random()),l=new Date(Date.now()+1e3*r+s),u=t>=10?"failed":"pending",p=k(_(d),500);await e.prisma.telegramUpdateQueue.update({where:{id:i.id},data:{status:u,attempts:t,lastError:p,nextRunAt:l}}),"failed"===u&&(a.failed+=1),await (0,y.K)(e.prisma,{level:"error",kind:"queue_update_error",updateId:i.updateId,updateType:o,meta:{...n,attempts:t},err:d})}}return a},v="nodejs",O=e=>{let t=e.headers.get("authorization"),r=t?.startsWith("Bearer ")?t.slice(7):null,a=e.headers.get("x-internal-secret");return r===l.O.internalSecret||a===l.O.internalSecret};async function b(e){if(!O(e))return s.NextResponse.json({ok:!1},{status:401});let t=e.nextUrl.searchParams.get("mode"),r="daily"===t?"daily":"queue"===t?"queue":"regular",a=new Date,i=null;try{i=await (0,u.M)();let e=null;"daily"!==r&&(e=await q({bot:i.bot,prisma:i.prisma,limit:25,now:a}));let t=0,o={autoClosed:0,notifiedAdmins:0,notifiedEmployees:0};"queue"!==r&&(t=await g(i.pendingActionService,{now:a,limit:l.O.tickMaxExpirePending}),o=await m(i.bot,i.shiftService,i.adminService,{now:a,limit:l.O.tickMaxAutoclose}));let n=0,p=0;if("daily"===r){n=await f(i.shiftRepo,{now:a,limit:l.O.tickMaxExpirePending});let e=l.O.eventLogRetentionDays,t=new Date(a.getTime()-864e5*e);p=(await i.prisma.eventLog.deleteMany({where:{createdAt:{lt:t}}})).count}return s.NextResponse.json({ok:!0,mode:r,queue:e,expiredPending:t,autoClosed:o.autoClosed,photosPurged:n,logsPurged:p,ranAt:a.toISOString()})}catch(e){try{let t=i??await (0,u.M)();await (0,y.K)(t.prisma,{level:"error",kind:"tick_error",meta:{mode:r},err:e})}catch(e){h.k.error({err:e},"Failed to log tick error")}return h.k.error({err:e},"Internal tick failed"),s.NextResponse.json({ok:!0,mode:r,error:!0,ranAt:a.toISOString()})}}let S=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/internal/tick/route",pathname:"/api/internal/tick",filename:"route",bundlePath:"app/api/internal/tick/route"},resolvedPagePath:"/Users/ilias_iangurazov/Desktop/telegram-shift-bot/src/app/api/internal/tick/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:A,staticGenerationAsyncStorage:P,serverHooks:M}=S,C="/api/internal/tick/route";function D(){return(0,n.patchFetch)({serverHooks:M,staticGenerationAsyncStorage:P})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[937,533,196],()=>r(1330));module.exports=a})();