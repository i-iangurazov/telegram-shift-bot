"use strict";(()=>{var e={};e.id=122,e.ids=[122],e.modules={3524:e=>{e.exports=require("@prisma/client")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7790:e=>{e.exports=require("assert")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},7702:e=>{e.exports=require("events")},2048:e=>{e.exports=require("fs")},629:e=>{e.exports=require("fs/promises")},2615:e=>{e.exports=require("http")},5240:e=>{e.exports=require("https")},5807:e=>{e.exports=require("module")},9801:e=>{e.exports=require("os")},5315:e=>{e.exports=require("path")},8621:e=>{e.exports=require("punycode")},8220:e=>{e.exports=require("stream")},4175:e=>{e.exports=require("tty")},7360:e=>{e.exports=require("url")},1764:e=>{e.exports=require("util")},6162:e=>{e.exports=require("worker_threads")},1568:e=>{e.exports=require("zlib")},4608:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>P,requestAsyncStorage:()=>q,routeModule:()=>w,serverHooks:()=>O,staticGenerationAsyncStorage:()=>k});var i={};r.r(i),r.d(i,{POST:()=>y,runtime:()=>f});var o=r(261),a=r(8331),s=r(4510),n=r(9784),l=r(2942),u=r(1830),p=r(3406),d=r(6751),c=r(8361);let m=async(e,t,r,i)=>{let o=i?.now??new Date,a=await t.autoCloseOverdueShifts(o,i?.limit);if(0===a.length)return{autoClosed:0,notifiedAdmins:0,notifiedEmployees:0};let s=await r.getAdminChatIds(),n=0,u=0;for(let t of a){let r=(0,d.mr)(t.endTime,l.O.timezone),i=t.shift.employee.displayName,o=p.s.autoClosedBoss(i,r,l.O.maxShiftHours);for(let t of s)try{await e.telegram.sendMessage(t,o),n+=1}catch(e){c.k.error({err:e,adminChatId:t},"Failed to notify admin about auto-close")}if(l.O.notifyEmployeeOnAutoClose)try{await e.telegram.sendMessage(t.shift.employee.telegramUserId,p.s.autoClosedEmployee(l.O.maxShiftHours)),u+=1}catch(e){c.k.error({err:e,employeeId:t.shift.employee.telegramUserId},"Failed to notify employee")}}return{autoClosed:a.length,notifiedAdmins:n,notifiedEmployees:u}},x=async(e,t)=>{let r=t?.now??new Date,i=await e.expirePendingActions(r,t?.limit);return i>0&&c.k.info({expired:i},"Expired pending actions"),i},h=async(e,t)=>{let r=t?.now??new Date,i=new Date(r.getTime()-864e5*l.O.photoRetentionDays),o=await e.purgeOldPhotos(i,r,t?.limit);return o>0&&c.k.info({purged:o},"Purged old shift photos"),o},f="nodejs",g=e=>{let t=e.headers.get("authorization"),r=t?.startsWith("Bearer ")?t.slice(7):null,i=e.headers.get("x-internal-secret");return r===l.O.internalSecret||i===l.O.internalSecret};async function y(e){if(!g(e))return n.NextResponse.json({ok:!1},{status:401});let t="daily"===e.nextUrl.searchParams.get("mode")?"daily":"regular",r=new Date;try{let e=await (0,u.M)(),i=await x(e.pendingActionService,{now:r,limit:l.O.tickMaxExpirePending}),o=await m(e.bot,e.shiftService,e.adminService,{now:r,limit:l.O.tickMaxAutoclose}),a=0;return"daily"===t&&(a=await h(e.shiftRepo,{now:r,limit:l.O.tickMaxExpirePending})),n.NextResponse.json({ok:!0,mode:t,expiredPending:i,autoClosed:o.autoClosed,photosPurged:a,ranAt:r.toISOString()})}catch(e){return c.k.error({err:e},"Internal tick failed"),n.NextResponse.json({ok:!1},{status:500})}}let w=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/internal/tick/route",pathname:"/api/internal/tick",filename:"route",bundlePath:"app/api/internal/tick/route"},resolvedPagePath:"/Users/ilias_iangurazov/Desktop/telegram-shift-bot/src/app/api/internal/tick/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:q,staticGenerationAsyncStorage:k,serverHooks:O}=w,v="/api/internal/tick/route";function P(){return(0,s.patchFetch)({serverHooks:O,staticGenerationAsyncStorage:k})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[937,533,830],()=>r(4608));module.exports=i})();